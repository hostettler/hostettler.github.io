
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Integration Tests With Docker and Arquillian - Steve Hostettler</title>
  <meta name="author" content="Steve Hostettler">

  
  <meta name="description" content="Last month I decided to add a touch of microservices to the JEE course I teach at the University of Geneva.
I ended up with a couple of microservices &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hostettler.github.io/blog/2016/01/30/integration-tests-with-docker-and-arquillian">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Steve Hostettler" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30751319-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Steve Hostettler</a></h1>
  
    <h2>JEE and test automation</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hostettler.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Integration Tests With Docker and Arquillian</h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-30T23:38:50+01:00" pubdate data-updated="true">Jan 30<span>th</span>, 2016</time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Last month I decided to add a touch of <a href="http://martinfowler.com/articles/microservices.html">microservices</a> to the JEE course I teach at the University of Geneva.
I ended up with a couple of microservices and as expected I came across the problem of testing their integration.
In this post I won&#8217;t talk about microservices specifically. I will rather focus on the integration testing experience I encountered while building my microservices. A dedicated blog post will follow on my journey through the building of microservices with JEE.</p>

<h2>A short description of the architecture</h2>

<p>From a technological perspective, I am using JEE 7 on <a href="http://wildfly.org/">Wildfly</a> with <a href="http://wildfly.org/">MySql</a>. Therefore, my microservices are wars composed of 1-2 EJBs plus a restful service that exposes the logic. Typically, my microservices are composed of 4-5 classes of max 150 lines of codes each. On my laptop, a microservice deploys in less than 5 seconds. I mainly need to test EJBs and their database calls. I also want to test integration between microservices.</p>

<h3>Why Docker?</h3>

<p>As it serves as a example for a course, I want it to be super easy to install/re-install 20 times if necessary. To that end, Docker is a great tool because I do not have to bother on what laptop/computer the students work (provided they can run <a href="https://www.docker.com/products/docker-toolbox">Docker Toolbox</a>). Moreover, all the tools I am using for the course are already packaged as Docker images.</p>

<h2>Building a  Docker image for a Wildfly Integration Test Server</h2>

<p>As mentioned previously, I propose to use Wildfly +  MySql as a runtime environment. However, at test time, I do not want to start both an application server and a database. More important I want to get a fresh database for each and every test suite. Moreover, I would like to use on a simpler setup for the application server. For instance, I do prefer to use an in memory H2 database instead of MySql. I also do not want to bother with LDAP/JAAS configuration.</p>

<p>A great feature of Wildfly is that it  allows to configure almost everything through the command line.
The first step is to configure a data source relying on H2 that has the same name as the production one.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># First step : Add the datasource</span>
</span><span class='line'>data-source add --name<span class="o">=</span>StudentsDS --driver-name<span class="o">=</span>h2 --jndi-name<span class="o">=</span><span class="nv">$STUDENTS_DS</span> --connection-url<span class="o">=</span><span class="nv">$H2_URI</span> --user-name<span class="o">=</span><span class="nv">$H2_USER</span> --password<span class="o">=</span><span class="nv">$H2_PWD</span> --use-ccm<span class="o">=</span><span class="nb">false</span> --max-pool-size<span class="o">=</span>25 --blocking-timeout-wait-millis<span class="o">=</span>5000
</span></code></pre></td></tr></table></div></figure>


<p>Then, let&#8217;s configure a realm.  This is helpful when the integration tests rely on principals and do verify the security.
The file <code>jee7-demo-realm-users.properties</code> (resp. <code>jee7-demo-realm-roles.properties</code>) defines the users (resp. the roles) of the realm.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Add a property file realm</span>
</span><span class='line'>/subsystem<span class="o">=</span>security/security-domain<span class="o">=</span>jee7-demo-realm:add<span class="o">(</span>cache-type<span class="o">=</span>default<span class="o">)</span>
</span><span class='line'>/subsystem<span class="o">=</span>security/security-domain<span class="o">=</span>jee7-demo-realm/authentication<span class="o">=</span>classic:add<span class="o">()</span>
</span><span class='line'>/subsystem<span class="o">=</span>security/security-domain<span class="o">=</span>jee7-demo-realm/authentication<span class="o">=</span>classic/login-module<span class="o">=</span>UsersRoles       <span class="se">\</span>
</span><span class='line'>    :add<span class="o">(</span><span class="nv">code</span><span class="o">=</span>UsersRoles, <span class="nv">flag</span><span class="o">=</span>required,                                                        <span class="se">\</span>
</span><span class='line'>         module-options<span class="o">={</span><span class="s2">&quot;usersProperties&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;${JBOSS_CUSTOMIZATION}/jee7-demo-realm-users.properties&quot;</span>,   <span class="se">\</span>
</span><span class='line'>                         <span class="s2">&quot;rolesProperties&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;${JBOSS_CUSTOMIZATION}/jee7-demo-realm-roles.properties&quot;</span><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, let&#8217;s add an admin user in order to allows Arquilian or an IDE to interact with this application server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/opt/jboss/wildfly/bin/add-user.sh admin admin
</span></code></pre></td></tr></table></div></figure>


<p>Hereafter the complete configuration <code>config_wildfly.sh</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Usage: execute.sh [WildFly mode] [configuration file]</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># The default mode is &#39;standalone&#39; and default configuration is based on the</span>
</span><span class='line'><span class="c"># mode. It can be &#39;standalone.xml&#39; or &#39;domain.xml&#39;.</span>
</span><span class='line'>
</span><span class='line'><span class="nv">JBOSS_HOME</span><span class="o">=</span>/opt/jboss/wildfly
</span><span class='line'><span class="nv">JBOSS_CUSTOMIZATION</span><span class="o">=</span><span class="nv">$JBOSS_HOME</span>/customization
</span><span class='line'><span class="nv">JBOSS_STANDALONE_CONFIG</span><span class="o">=</span><span class="nv">$JBOSS_HOME</span>/standalone/configuration/
</span><span class='line'><span class="nv">JBOSS_CLI</span><span class="o">=</span><span class="nv">$JBOSS_HOME</span>/bin/jboss-cli.sh
</span><span class='line'><span class="nv">JBOSS_MODE</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="s2">&quot;standalone&quot;</span><span class="k">}</span>
</span><span class='line'><span class="nv">JBOSS_CONFIG</span><span class="o">=</span><span class="k">${</span><span class="nv">2</span><span class="k">:-</span><span class="s2">&quot;$JBOSS_MODE.xml&quot;</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function </span>wait_for_server<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">until</span> <span class="sb">`</span><span class="nv">$JBOSS_CLI</span> -c <span class="s2">&quot;:read-attribute(name=server-state)&quot;</span> 2&gt; /dev/null | grep -q running<span class="sb">`</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span>sleep 1
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=&gt; Starting WildFly server&quot;</span>
</span><span class='line'><span class="nv">$JBOSS_HOME</span>/bin/<span class="nv">$JBOSS_MODE</span>.sh -b 0.0.0.0 -c <span class="nv">$JBOSS_CONFIG</span> &amp;
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=&gt; Waiting for the server to boot&quot;</span>
</span><span class='line'>wait_for_server
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=&gt; Executing the commands&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">STUDENTS_DS</span><span class="o">=</span><span class="s2">&quot;java:/StudentsDS&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">H2_URI</span><span class="o">=</span><span class="s2">&quot;jdbc:h2:mem:STUDENTS_DB;DB_CLOSE_DELAY=-1&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">H2_USER</span><span class="o">=</span><span class="s2">&quot;sa&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">H2_PWD</span><span class="o">=</span><span class="s2">&quot;sa&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$JBOSS_CLI</span> -c <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">batch</span>
</span><span class='line'>
</span><span class='line'><span class="s">echo &quot;Connection URL: &quot; $CONNECTION_URL</span>
</span><span class='line'>
</span><span class='line'><span class="s"># First step : Add the datasource</span>
</span><span class='line'><span class="s">data-source add --name=StudentsDS --driver-name=h2 --jndi-name=$STUDENTS_DS --connection-url=$H2_URI --user-name=$H2_USER --password=$H2_PWD --use-ccm=false --max-pool-size=25 --blocking-timeout-wait-millis=5000 </span>
</span><span class='line'>
</span><span class='line'><span class="s"># Then configure a realm that relies on property files</span>
</span><span class='line'><span class="s">/subsystem=security/security-domain=jee7-demo-realm:add(cache-type=default)</span>
</span><span class='line'><span class="s">/subsystem=security/security-domain=jee7-demo-realm/authentication=classic:add()</span>
</span><span class='line'><span class="s">/subsystem=security/security-domain=jee7-demo-realm/authentication=classic/login-module=UsersRoles       \</span>
</span><span class='line'><span class="s">    :add(code=UsersRoles, flag=required,                                                        \</span>
</span><span class='line'><span class="s">         module-options={&quot;usersProperties&quot;=&gt;&quot;${JBOSS_CUSTOMIZATION}/jee7-demo-realm-users.properties&quot;,   \</span>
</span><span class='line'><span class="s">                         &quot;rolesProperties&quot;=&gt;&quot;${JBOSS_CUSTOMIZATION}/jee7-demo-realm-roles.properties&quot;})</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Execute the batch</span>
</span><span class='line'><span class="s">run-batch</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Finally, let&#39;s add an admin that can be used by the IDE to deploy the tests</span>
</span><span class='line'>/opt/jboss/wildfly/bin/add-user.sh admin admin
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=&gt; Shutting down WildFly&quot;</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$JBOSS_MODE&quot;</span> <span class="o">=</span> <span class="s2">&quot;standalone&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>  <span class="nv">$JBOSS_CLI</span> -c <span class="s2">&quot;:shutdown&quot;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nv">$JBOSS_CLI</span> -c <span class="s2">&quot;/host=*:shutdown&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next step is to enhance the official Wildfly image called <code>jboss/wildfly:latest</code> with the specific configurations we need for integration testing. This following Dockerfile describes how to build the image that we will use for testing.
First, it adds the previous configuration files <code>./config_wildfly.sh ./jee7-demo-realm-roles.properties ./jee7-demo-realm-users.properties</code> to the <code>/opt/jboss/wildfly/customization/</code> of the image. Then we tell Docker to run the configuration <code>config_wildfly.sh</code> and to do some cleanup. After what, it will record the states as a new image.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM jboss/wildfly:latest
</span><span class='line'>
</span><span class='line'>ADD ./config_wildfly.sh ./jee7-demo-realm-roles.properties ./jee7-demo-realm-users.properties /opt/jboss/wildfly/customization/
</span><span class='line'>
</span><span class='line'>RUN <span class="o">[</span><span class="s2">&quot;/opt/jboss/wildfly/customization/config_wildfly.sh&quot;</span><span class="o">]</span>
</span><span class='line'>RUN rm -rf  /opt/jboss/wildfly/standalone/configuration/standalone_xml_history
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;/opt/jboss/wildfly/bin/standalone.sh&quot;</span>, <span class="s2">&quot;--debug&quot;</span>, <span class="s2">&quot;-b&quot;</span>, <span class="s2">&quot;0.0.0.0&quot;</span>, <span class="s2">&quot;-bmanagement&quot;</span>, <span class="s2">&quot;0.0.0.0&quot;</span><span class="o">]</span>
</span><span class='line'>EXPOSE 8787
</span></code></pre></td></tr></table></div></figure>


<p>Now we can build an image called <code>jee7-test-wildfly</code> using the following command (in the directory where the <code>Dockerfile</code> lives):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker build --no-cache -rm -t jee7-test-wildfly .
</span></code></pre></td></tr></table></div></figure>


<p>The following command runs the image we just built, exposes the port 8080, 9090 and 8787, and mount the local directory <code>/Users/XXXXXXXXXX/tmp/docker-deploy</code> on the image&#8217;s <code>/opt/jboss/wildfly/standalone/deployments/</code> directory. This is of course the directory in which the integration tests are to be deployed..</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker run -d  -p 8080:8080 -p 9990:9990 -p 8787:8787 -v /Users/XXXXXXXXXX/tmp/docker-deploy:/opt/jboss/wildfly/standalone/deployments/:rw jee7-test-wildfly
</span></code></pre></td></tr></table></div></figure>


<p>Now that we do have a container running an application server with in memory database and a simple realm, we can configure the test harness.</p>

<h2>How to configure Arquillian</h2>

<p><a href="http://arquillian.org/">Arquillian</a> is a JEE integration test framework. It allows to test JEE components such as EJBs or web services.
The first step it to tell Arquillian where the Wildfly server lives. The following <code>arquillian.xml</code> file states that the integration tests should deploy on a Wildfly container that listens at <code>192.168.99.100</code> (which is the Docker container address) on port <code>9990</code> (which is the administration port). Furthermore, it declares the admin username and password.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;arquillian</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>  <span class="na">xmlns=</span><span class="s">&quot;http://jboss.org/schema/arquillian&quot;</span>
</span><span class='line'>  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://jboss.org/schema/arquillian</span>
</span><span class='line'><span class="s">  http://jboss.org/schema/arquillian/arquillian_1_0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;container</span> <span class="na">qualifier=</span><span class="s">&quot;wildfly&quot;</span> <span class="na">default=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;managementAddress&quot;</span><span class="nt">&gt;</span>192.168.99.100<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;managementPort&quot;</span><span class="nt">&gt;</span>9990<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>admin<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>admin<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>      <span class="nt">&lt;protocol</span> <span class="na">type=</span><span class="s">&quot;Servlet 3.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;host&quot;</span><span class="nt">&gt;</span>192.168.99.100<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;port&quot;</span><span class="nt">&gt;</span>8080<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/protocol&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/container&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;extension</span> <span class="na">qualifier=</span><span class="s">&quot;jacoco&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;includes&quot;</span><span class="nt">&gt;</span>ch.demo.*<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/extension&gt;</span>
</span><span class='line'><span class="nt">&lt;/arquillian&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>A simple integration Test</h2>

<p>Let us now write a simple integration test. First, we must tell Arquillian the it is in charge of running the test (<code>@RunWith(Arquillian.class)</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Arquillian</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceImplTest</span> <span class="o">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>To test a given component (let&#8217;s say an EJB), arquillian expects a well-formed Java component (either a jar or a war).
The following test is composend of a package contaning the EJB under test (<code>ch.demo</code>), an empty <code>beans.xml</code> to enable CDI and finally a <code>persistence.xml</code> to enable JPA.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Deployment</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">JavaArchive</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">ShrinkWrap</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">JavaArchive</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;integration-test-demo.jar&quot;</span><span class="o">).</span><span class="na">addPackages</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="s">&quot;ch.demo&quot;</span><span class="o">)</span>
</span><span class='line'>          <span class="o">.</span><span class="na">addAsManifestResource</span><span class="o">(</span><span class="n">EmptyAsset</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="s">&quot;beans.xml&quot;</span><span class="o">)</span>
</span><span class='line'>          <span class="o">.</span><span class="na">addAsManifestResource</span><span class="o">(</span><span class="s">&quot;test-persistence.xml&quot;</span><span class="o">,</span> <span class="s">&quot;persistence.xml&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The previous JAR as well as the tests are packaged as a WAR and deployed on the application server declared in the <code>arquillian.xml</code> file. The following test injects the EJB under test implementing the <code>StudentService</code> interface and tests its <code>add</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Inject</span>
</span><span class='line'><span class="n">StudentService</span> <span class="n">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldAddReturnAllWithTheNewStudent</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Integer</span> <span class="n">nbStudentsBeforeTest</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getNbStudent</span><span class="o">();</span>
</span><span class='line'>  <span class="n">service</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="s">&quot;Doe&quot;</span><span class="o">,</span> <span class="s">&quot;Jane&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(),</span> <span class="k">new</span> <span class="n">PhoneNumber</span><span class="o">(</span><span class="s">&quot;+33698075273&quot;</span><span class="o">)));</span>
</span><span class='line'>  <span class="n">Integer</span> <span class="n">nbStudentsAfterTest</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>  <span class="n">Assert</span><span class="o">.</span><span class="na">assertSame</span><span class="o">(</span><span class="n">nbStudentsBeforeTest</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">nbStudentsAfterTest</span><span class="o">);</span>
</span><span class='line'>  <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">nbStudentsAfterTest</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">getLastName</span><span class="o">(),</span> <span class="s">&quot;Doe&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Maven, IDE Integration and Coverage</h2>

<p>Finally, let me add that it is possible to get coverage data from Arquillian by enabling extension. In the following, it enables<code>`jacoco</code> that can be used by the Eclipse ECL-EMMA plugin.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>   <span class="nt">&lt;extension</span> <span class="na">qualifier=</span><span class="s">&quot;jacoco&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;includes&quot;</span><span class="nt">&gt;</span>ch.demo.*<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/extension&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Docker and Arquillian provide a nice and seamless way for JEE integration testing. Nevertheless, I had a hard time at the beginning because Arquillian error handling in case of undeployable test archive is not very good. In this case, make sure that you package your test correctly (in the method annotated <code>@Deployment</code>). In particular, double check <code>beans.xml</code>, <code>web.xml</code> and the JAR/WAR structure. It really helped me to unzip the deployed test archive to figure out what when wrong in my code.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Steve Hostettler</span></span>

      








  


<time datetime="2016-01-30T23:38:50+01:00" pubdate data-updated="true">Jan 30<span>th</span>, 2016</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/arquillian/'>Arquillian,</a>, <a class='category' href='/blog/categories/docker/'>Docker</a>, <a class='category' href='/blog/categories/integration/'>Integration</a>, <a class='category' href='/blog/categories/jee7/'>JEE7,</a>, <a class='category' href='/blog/categories/tests/'>Tests,</a>, <a class='category' href='/blog/categories/tests/'>Tests,</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/12/02/cleaning-intermediate-docker-images/" title="Previous Post: Cleaning Intermediate Docker Images">&laquo; Cleaning Intermediate Docker Images</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/30/integration-tests-with-docker-and-arquillian/">Integration Tests With Docker and Arquillian</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/02/cleaning-intermediate-docker-images/">Cleaning Intermediate Docker Images</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/26/communication-between-java-enterprise-applications/">Communication Between Java Enterprise Applications</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/18/fakes-stubs-dummy-mocks-doubles-and-all-that/">Fakes, Stubs, Dummy, Mocks, Doubles and All That...</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/18/testing-levels/">Testing Levels</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/31/jee6-tutorial/">JEE6 Tutorial</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/05/servicelocator/">Context Dependency Injection and the Rich Object Model</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/20/multi-tenancy/">Multi-Tenancy With EJB 3.1 and JPA 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/10/Sessions-GC-Conversations/">About Sessions, Conversations, and the Garbage Collector</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/24/moxy/">Object-XML Mapping With JAXB & MOXy</a>
      </li>
    
  </ul>
</section>




<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/116636069211041664299?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Steve Hostettler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hostettlerblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://hostettler.github.io/blog/2016/01/30/integration-tests-with-docker-and-arquillian/';
        var disqus_url = 'http://hostettler.github.io/blog/2016/01/30/integration-tests-with-docker-and-arquillian/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

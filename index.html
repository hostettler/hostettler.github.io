
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Steve Hostettler</title>
  <meta name="author" content="Steve Hostettler">

  
  <meta name="description" content="In this post, I look at the different kind of objects used for test purposes. By this, I mean objects that are used to make a test running. This &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hostettler.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Steve Hostettler" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30751319-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Steve Hostettler</a></h1>
  
    <h2>JEE and test automation</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hostettler.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about-me/">About Me</a></li>
  <li><a href="http://publicationslist.org/steve.hostettler">Publications</a></li>
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/18/fakes-stubs-dummy-mocks-doubles-and-all-that/">Fakes, Stubs, Dummy, Mocks, Doubles and All That&#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-18T10:58:00+02:00" pubdate data-updated="true">May 18<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/05/18/fakes-stubs-dummy-mocks-doubles-and-all-that/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post, I  look at the different kind of objects used for test purposes. By this, I mean objects that are used to make a test running. This article focuses on component testing, a.k.a. unit testing (I do not like the term unit testing because it is too often misunderstood with the technology behind, e.g., JUnit, testNG).
Although there already exists a great number of resources on that subject, it was very difficult to me to understand the differences between the different kinds of test objects. This is partly due to the fact that different authors use different terms for the same object and the same term for different objects [1]. To be as didactic as possible, I also chose to add some blocks of code. Please note, that these blocks are only here for the sake of clarity. This is not the way I would recommend to do stubbing, faking, and mocking. Consider  <a href="https://code.google.com/p/mockito/">Mockito</a> and PowerMockito for that. These are amazing tools to that purpose. They deserve a post on their own to discuss good practices.
This post is in no way an exhaustive state of the art, I only tried to select the terms that, in my opinion, are clear and are consensual enough. To that end I used a number of sources that can be found in the bibliography section.</p>

<p>Here are the main reasons to use different objects during the test phase and in production:</p>

<ul>
<li><p>Performances: the actual object contains slow algorithms and heavy calculation that may impair the test performances. A test should always be fast to not discourage regular run and therefore to identify problems as soon as possible. The worst case being the one in which the developer must deploy and run the entire application to test a single use case.</p></li>
<li><p>States: sometimes the constellation under test happens rarely. This is for instances that occur with a low probability  such as race conditions, network failure, etc..</p></li>
<li><p>Non-deterministic: this is the case of components that have interactions with the real-world such as sensors.</p></li>
<li><p>The actual object does not exist: for instance, another team is working on it and is not yet ready.</p></li>
<li><p>To instrument the actual dependency: for instance to spy the calls of the CUT to one of its dependencies.</p></li>
</ul>


<h2>Doubles objects</h2>

<p>Test double is the generic term that groups all the categories of objects that are used to fulfill one or several of the previous requirements.
The term comes has been coined by Gerard Meszaros in [2]
In rough terms, test doubles look like the actual object they double. They satisfy, to different extends the original interface and propose a sub-set of the behaviors that is expected by the specification. This helps to isolate the problem and reduce the double implementation to the strict minimum.</p>

<p>There exists different kind of test doubles for different purposes. The have in common that they can be use instead of the actual component without breaking the contract syntactically.</p>

<p>The next figure describes a simple test setup that do not use test doubles. To test the Component Under Test (CUT), the following test setup uses its actual dependencies (another component). This setup phase is trivial as there is nothing to do. The exercise phase calls the CUT with the proper parameters (direct inputs) that in turn calls it dependency (indirect outputs). Another Component returns its result to the CUT (indirect inputs) that uses it to complete the work and then finally returns the overall result (direct outputs). The terms &#8220;direct inputs&#8221;, &#8220;indirect outputs&#8221;, and so on come from [2].</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestSetup.png' width='' height='' alt='Overview of a test setup' title='Overview of a test setup'><span class='caption-text'>Overview of a test setup</span></span></p>

<p>Now let us say that &#8220;AnotherComponent&#8221; is either too complex, not already implemented or has a non-deterministic behavior. In those cases, it is easier to use another implementation of &#8220;AnotherComponent&#8221; that behaves exactly has expected for a specific scenario.</p>

<p>Hereafter, a simple example to illustrate the rest of the post. The class <code>CUTImpl</code> that realizes the contract <code>CUT</code> implements  the component under test. The CUT uses a component that realizes the interface <code>AnotherComponent</code>.
For the sake of clarity, the following example injects the dependencies through the constructor.
To improve loose coupling, it is possible to rely on dependency injection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTImpl</span> <span class="kd">implements</span> <span class="n">CUT</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">AnotherComponent</span> <span class="n">component</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">CUTImpl</span><span class="o">(</span><span class="n">AnotherComponent</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">component</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">doBusiness</span><span class="o">(</span><span class="n">String</span> <span class="n">param</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">delta</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">component</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">param</span><span class="o">)).</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CUT</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">doBusiness</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">delta</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AnotherComponent</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Integer</span> <span class="nf">inc</span><span class="o">(</span><span class="n">Integer</span> <span class="n">param</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherComponentImpl</span> <span class="kd">implements</span> <span class="n">AnotherComponent</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">inc</span><span class="o">(</span><span class="n">Integer</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">param</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;Param must be not null!&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">param</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_INTEGER</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Incrementing MAX_INTEGER will result in overflow!&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">param</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following test uses real implementations of the the different components.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInc</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">(</span><span class="k">new</span> <span class="n">AnotherComponentImpl</span><span class="o">()).</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The question is what if:</p>

<ol>
<li><code>AnotherComponentImpl</code> is not ready yet</li>
<li><code>AnotherComponentImpl</code> depends itself on external services or specific hardware resources</li>
<li><code>AnotherComponentImpl</code> has non-deterministic behaviors.</li>
</ol>


<h2>Dummy objects</h2>

<p>Dummy objects are meant to satisfy compile-time check and runtime execution. Dummies do not take part to the test scenario.
Some method signatures of the CUT may require objects as parameters. If neither the test nor the CUT care about these objects, we may choose to pass in a Dummy Object. This can be a null reference, an empty object or a constant. Dummy objects are passed around (to dependencies for instance) but never actually used. Usually they are just used to fill parameter lists. They are meant to replace input/output parameters of the components that the CUT interacts with.</p>

<p>In the current example, the parameter <code>delta</code> of the <code>doBusiness</code> method can be set to <code>null</code> or any <code>Integer</code> value without interfering with the test. Of course, this might be different for another test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInc</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">(</span><span class="k">new</span> <span class="n">AnotherComponentImpl</span><span class="o">()).</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Stub objects</h2>

<p>Stub objects provide simple answers to the CUT invocations. It does answer to scenarii that are not foreseen by the current test. In other terms it is a simplified fake object. Stub objects may trigger paths in the CUT that would otherwise not been executed.</p>

<p>The next figure presents a test that relies on a test stub. First, the test case setups a stub object. This object responds to the expected CUT invokation in order to enact a given scenario. This is very useful to check indirect inputs with seldom values.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestSTUB.png' width='' height='' alt='Test setup that uses a test stub' title='Test setup that uses a test stub'><span class='caption-text'>Test setup that uses a test stub</span></span></p>

<p>Back to the example, the following program illustrates how to use a stub to check specific indirect inputs.
This stub shows that the CUT relies on the fact that <code>AnotherComponent</code> does not return <code>null</code>, as it
would otherwise raise a <code>NullPointerException</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherComponentStub</span> <span class="kd">implements</span> <span class="n">AnotherComponent</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">inc</span><span class="o">(</span><span class="n">Integer</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIncWhenAnotherComponentReturnsNull</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">//Without any modification of the CUT implement, this would raise an exception</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">(</span><span class="k">new</span> <span class="n">AnotherComponentStub</span><span class="o">()).</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Fake objects</h2>

<p>Fake objects have working implementations, but  they may simplify some behaviors. This makes them not suitable for prime time. The idea is that the object actually displays some real behavior but not everything. While a Fake Object is typically built specifically for testing, it is not used as either a control point or an observation point by the test. The most common reasons for using fake objects is that the real component is not available yet, is too slow or cannot be used during tests because of side effects.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestFAKE.png' width='' height='' alt='Test setup that uses a fake' title='Test setup that uses a fake'><span class='caption-text'>Test setup that uses a fake</span></span></p>

<p>The following fake simulates most of the behaviors except for the limits (MAX_INTEGER, null, etc&#8230;)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherComponentFake</span> <span class="kd">implements</span> <span class="n">AnotherComponent</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">inc</span><span class="o">(</span><span class="n">Integer</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">param</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As the fake covers many scenarios, it can be used to test the general behavior of the CUT.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIncWhenAnotherComponentIsFake</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">CUT</span> <span class="n">cut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">(</span><span class="k">new</span> <span class="n">AnotherComponentFake</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(123) != 124&quot;</span><span class="o">,</span> <span class="mi">124</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Mock objects</h1>

<p>Partially implements the interface and provides a way to verify that the calls to the mock objects validate the specification.
Mock objects are pre-programmed with expectations that form a specification of the calls they are expected to receive.
In fact mocks are a certain kind of stub or fake. However, the additional feature mock objects offer on top of acting as simple stubs or fakes is that they provide a flexible way to specify more directly how your function under test should actually operate. In this sense they also act as a kind of recording device: They keep track of which of the mock object&#8217;s methods are called, with what kind of parameters, and how many times.</p>

<p>Whenever the assertions are made on the fake object and not the CUT, then it is a mock.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestMOCK.png' width='' height='' alt='Test setup that uses a mock' title='Test setup that uses a mock'><span class='caption-text'>Test setup that uses a mock</span></span></p>

<p>The following example uses <a href="https://code.google.com/p/mockito/">Mockito</a> to provide easy Mocking. Note that the last assertion <code>Mockito.verify</code> checks whether the mock was called with a given parameters. In other words, we check that the CUT did not filter the input parameter.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Mock</span>
</span><span class='line'>  <span class="n">AnotherComponent</span> <span class="n">ac</span><span class="o">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nd">@InjectMocks</span>
</span><span class='line'>  <span class="n">CUT</span> <span class="n">cut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIncWhenAnotherComponentReturnsNull</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">ac</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_INTEGER</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_INTEGER</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>      <span class="n">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">ac</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
</span><span class='line'>      <span class="n">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">ac</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">123</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">124</span><span class="o">);</span>
</span><span class='line'>      
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(Integer.MIN_INTEGER) != Integer.MIN_INTEGER + 1&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_INTEGER</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MIN_INTEGER</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(123) != 124&quot;</span><span class="o">,</span> <span class="mi">124</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//Verifies that the method inc of AnotherComponent was called with parameter Integer.MAX_INTEGER</span>
</span><span class='line'>        <span class="n">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">ac</span><span class="o">).</span><span class="na">inc</span><span class="o">(</span><span class="n">Matchers</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_INTEGER</span><span class="o">));</span>
</span><span class='line'>        <span class="c1">//Verifies that the inc method has been called three times.</span>
</span><span class='line'>        <span class="n">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">ac</span><span class="o">,</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">times</span><span class="o">(</span><span class="mi">3</span><span class="o">)).</span><span class="na">inc</span><span class="o">(</span><span class="n">anyInt</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Test Spy</h2>

<p>According to Meszaros [2], a test spy is basically a recorder that is able to save the interactions between the CUT and the spy for later verifications.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestSPY.png' width='' height='' alt='Test setup that uses a test spy' title='Test setup that uses a test spy'><span class='caption-text'>Test setup that uses a test spy</span></span></p>

<p>On the other hand, <a href="https://code.google.com/p/mockito/">Mockito</a> considers that a spy is an real implementation in which you change only some specific behaviors. Instead of specifying every behavior one by one, you take an existing object that does most of it and you only change very specific behaviors.</p>

<h2>Conclusion</h2>

<p>To sum up:</p>

<ul>
<li>A dummy is just there to enable compilation and is not supposed to be part of the test.</li>
<li>A fake is a partial implementation that can be used either in a component test or in a deployed setting.</li>
<li>A mock is a partial implementation that enables asserting on the component interactions.</li>
<li>A spy is either a recorder for later use or a proxy on a real implementation that is used to override some specific behaviors.</li>
</ul>


<h2>Bibliography</h2>

<ul>
<li>[1] Martin Fowler <a href="http://martinfowler.com/articles/mocksArentStubs.html">Mock aren&#8217;t stubs</a></li>
<li>[2] Meszaros, Gerard (2007). xUnit Test Patterns: Refactoring Test Code. Addison-Wesley. ISBN 978-0-13-149505-0.</li>
<li>[3] <a href="https://storage.googleapis.com/gtb/TotT-2008-06-12.pdf">Friends you can depend on</a></li>
<li>[4] <a href="http://en.wikipedia.org/wiki/Mock_object">Wikipedia Mock Object</a></li>
<li>[5] <a href="http://en.wikipedia.org/wiki/Test_double">Wikipedia Test Doubles</a></li>
<li>[6] <a href="http://en.wikipedia.org/wiki/Fake_object">Wikipedia Fakes</a></li>
<li>[7] <a href="http://en.wikipedia.org/wiki/Test_stubs">Wikipedia Stubs</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/18/testing-levels/">Testing Levels</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-18T10:52:00+02:00" pubdate data-updated="true">Apr 18<span>th</span>, 2014</time>
        
         | <a href="/blog/2014/04/18/testing-levels/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Introduction</h2>

<p>In this post, I would like to discuss number of definitions around the testing activity. Having these definitions in mind helps to organize this crucial activity. In a previous post, I discussed the difference between <a href="">verification and validation</a>. If the difference is not clear to you, please have a look at it prior reading this post.</p>

<p>Let me start with the definition of what is testing. Software testing helps to measure the quality of a software in terms of defects. It is crucial to understand that
&#8220;testing shows the presence, not the absence of bugs&#8221; [1].</p>

<p>This comes from the fact that exhaustive testing is not possible  due to a phenomena called the state space explosion [2]. The idea is that doing exhaustive testing would require a structure in memory that remembers all the tested states of the system. A state of the system being the concatenation of its variables. For instance, let us take a program that has two variables:
- an integer (4 bytes = 32 bits)
- an array of ASCII characters of length 10 (10 bytes =  80 bits)
The number of states to explore is  2<sup>112</sup> ~ 5x10<sup>33</sup> states (remember that the number of atoms in the observable universe is 10<sup>80</sup>) and the required amount of memory would be 7.2x10<sup>22</sup> Terabytes. Although many optimizations can be brought to a brute force approach [1,2], the problem remains huge. Therefore, exhaustive testing is not an option.</p>

<p>Another important point about defects is to understand from where they originate.
A (software) defect originates in a human <strong>mistake</strong> (e.g., a misunderstanding) that produces a <strong>fault</strong> (i.e., a defect, a bug). Under certain circumstances, the faulty code will end up doing something unexpected with respect to the user requirements. This is called a <strong>failure</strong>.</p>

<p>To sum up, there is the following causality chain : Mistake &#8211;> Fault &#8211;> Failure.</p>

<p>This demonstrates that testing is not only a matter of detecting the failure but that it can be done earlier. Of course the earlier the defect is detected the cheaper is it to address it. For instance, informing the developer about the business may avoid a mistake. Using automated code checker may detect some faults.</p>

<h2>Testing dimensions</h2>

<p>Testing can be characterized in terms of dimensions. These dimensions help to categorized the test types.</p>

<ol>
<li><p>What : This dimension describes what are the objectives of the tests. Test objectives vary from one approach to another.
Usually the objectives are the verification or  the validation of functionnal (e.g., portfolio performance) and non-functionnal (e.g., performance, security) requirements.</p></li>
<li><p>How : This defines how the test objective is achieved. For instance, tests can be either static or dynamic, in isolation or in integration, or knowing the implementation.</p></li>
<li><p>When : Test can be executed at different moment of the development process. For instance, component testing can be done very early in the development process, while user acceptance test can only be performed when the software is ready for prime time.</p></li>
<li><p>Who : Different kind of tests are run by different people (e.g., developer, testers , end-users, &#8230;) For instance, component testing can be done by programmers, while user acceptance test are performed by end-users.</p></li>
</ol>


<h3>Testing level</h3>

<p>Testing levels have been addressed in a number of publications, blog posts and talks [3], [4], [5]. Testing levels describe test types by their quantity and when they occur in the software lifecycle. At the base, tests are done early in the development and extensively. The higher the level, the later the test occurs in the lifecycle. Moreover, while lower levels are usually done the the software supplier, higher levels tend to be performed by the customer.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TESTING_LEVELS.png' width='' height='' alt='Testing Levels' title='Testing Levels'><span class='caption-text'>Testing Levels</span></span></p>

<h4>Static testing</h4>

<p>This sort of testing do not require to execute the code. Tools crawl the code and look for patterns that can lead to fault. Example of tools are <a href="http://findbugs.sourceforge.net/">Findbugs</a>, <a href="http://sourceforge.net/p/pmd/bugs/">PMD</a>. This kind of testing is especially useful to detect complex mistakes involving thread-safety or typing.</p>

<h4>Unit testing</h4>

<p>Test objects are isolated components (classes, packages, programs, &#8230;)  To promote isolation, test objects such as stubs, fakes or mocks can be used. for more information see <a href="">Fakes, Stubs, Dummies, Mocks and all that</a>. These tests happen during development and discovered bugs are fixed right away. Therefore, the management overhead is minimal. Both verification of functional and non.functional requirements can be addressed.</p>

<h4>Integration testing</h4>

<p>Integration testing (a.k.a. assembly testing) verifies the integration between several components. At this level, some components can still be faked to ease deployment and isolation.
Both verification of functional and non.functional requirements can be addressed.</p>

<h4>API testing</h4>

<p>This is the first test level that addresses validation instead of verification. It tests the software using its contracts (API). This is pure blackbox testing usually by using webservices. Tools such as SoapUI are very good at testing the software API and semantics.</p>

<h4>GUI testing</h4>

<p>This level acts on the graphical user interface. Example of tools are <a href="http://www.seleniumhq.org/">Selenium</a></p>

<h4>System testing</h4>

<p>This test level aims the system as a whole with every internal and external components.
Both verification of functional and non.functional requirements can be addressed.</p>

<h4>Acceptance testing</h4>

<p>Both verification of functional and non.functional requirements can be addressed.</p>

<h3>Bibliography</h3>

<p>[1 ]Dijkstra (1969) J.N. Buxton and B. Randell, eds, Software Engineering Techniques, April 1970, p. 16. Report on a conference sponsored by the NATO Science Committee, Rome, Italy, 27–31 October 1969. Possibly the earliest documented use of the famous quote.</p>

<p>[2] Antti Valmari. The state explosion problem. In Wolfgang Reisig and Grzegorz Rozenberg, editors, Lectures on Petri Nets I: Basic
Models, volume 1491 of Lecture Notes in Computer Science, pages 429D528. Springer, 1998.</p>

<p>[3] Martin Fowler. TestPyramid. http://martinfowler.com/bliki/TestPyramid.html</p>

<p>[4] Alister Scott. Yet another software testing pyramid. http://watirmelon.com/2011/06/10/yet-another-software-testing-pyramid/
[5] Alister Scott. Introducing the software testing ice-cream cone (anti-pattern). http://watirmelon.com/2012/01/31/introducing-the-software-testing-ice-cream-cone/</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/31/jee6-tutorial/">JEE6 Tutorial</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-31T09:43:00+01:00" pubdate data-updated="true">Dec 31<span>st</span>, 2012</time>
        
         | <a href="/blog/2012/12/31/jee6-tutorial/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I hereby start a series of tutorial on the major (IMHO) JEE 6 features. As a lecturer, I teach the JEE stack at the University of Geneva. This tutorial represents most of the topics that I cover during the EJB, CDI, and JPA lessons.</p>

<p>There already exists a bunch of very complete tutorials and books on the subject. Let me cite the excellent <a href="http://docs.oracle.com/javaee/6/tutorial/doc/" title="Oracle's official JEE6 tutorial">Oracle JEE tutorial</a> and
Antonio Goncalvez&#8217;s books that are available both in <a href="http://www.amazon.com/Beginning-GlassFish-Experts-Voice-Technology/dp/143022889X/ref=sr_1_1?ie=UTF8&amp;qid=1356945347&amp;sr=8-1&amp;keywords=JEE6+antonio+goncalves" title="Antonio's Book in English">English</a> and in <a href="http://www.amazon.com/Java-EE6-GlassFish-Antonio-Goncalves/dp/2744024236/ref=sr_1_fkmr2_1?s=books&amp;ie=UTF8&amp;qid=1356945440&amp;sr=1-1-fkmr2&amp;keywords=JEE6+et+glassfish" title="Antonio's Book in French">French</a>. For advanced JEE developers, Adam Bien&#8217;s <a href="http://press.adam-bien.com/real-world-java-ee-night-hacks-dissecting-the-business-tier.htm" title="Real World Java EE Night Hacks--Dissecting the Business Tier">Real World Java EE Night Hacks</a> is a must read.</p>

<p>As the <a href="http://jcp.org/aboutJava/communityprocess/final/jsr318/index.html" title="EJB 3.1 specification">EJB 3.1 specification</a> is rather well written, I encourage people to read it or at least to look at specifics when needed.</p>

<p>To support this tutorial you can find a JEE6-Demo on GitHub. It contains a simple enterprise application that demonstrates many of the
aspects I discuss hereafter. The first step of this tutorial is to prepare the environment:</p>

<p>1) Install GlassFish and integrate it to your favorite development environment (eclipse in my case). You can get GlassFish from <a href="http://glassfish.java.net/downloads/3.1.2.2-final.html" title="Glassfish Download Page">here</a>. Grab the zip version and install it by unzipping the archive.</p>

<p>2) Run GlassFish and check that it works. Locate the script named <code>asadmin</code> in the <code>bin</code> directory, start it and at the prompt, execute the command <code>start-domain</code>. This starts the GlassFish instance.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>localhost:bin ~$ ./asadmin
</span><span class='line'>Use "exit" to exit and "help" for online help.
</span><span class='line'>asadmin&gt; start-domain
</span><span class='line'>Waiting for domain1 to start ...
</span><span class='line'>Successfully started the domain : domain1
</span><span class='line'>domain  Location: ~/Applications/glassfish3/glassfish/domains/domain1
</span><span class='line'>Log File: ~/Applications/glassfish3/glassfish/domains/domain1/logs/server.log
</span><span class='line'>Admin Port: 4848
</span><span class='line'>Command start-domain executed successfully.
</span><span class='line'>asadmin&gt; </span></code></pre></td></tr></table></div></figure>


<p>Now the server is started and it listens to the ports 8080 and 4848. The first being the application port while the second is the administrative console.</p>

<p>Start a browser and navigate to <a href="http://localhost:4848/common/index.jsf"><code>http://localhost:4848/common/index.jsf</code></a>. Depending of the server configuration, you may have to log in.</p>

<p>3) Do a Git checkout of the jee6-demo project that is available <a href="https://github.com/hostettler/JEE6-Demo">here</a>.</p>

<p>4) Perform a <code>mvn clean install</code> at the project root</p>

<p>This compiles the project and builds the artifacts. It should end up in something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[INFO] ------------------------------------------------------------------------
</span><span class='line'>[INFO] Reactor Summary:
</span><span class='line'>[INFO] 
</span><span class='line'>[INFO] jee6-demo ......................................... SUCCESS [0.480s]
</span><span class='line'>[INFO] Service Layer ..................................... SUCCESS [3.650s]
</span><span class='line'>[INFO] Presentation Layer ................................ SUCCESS [1.725s]
</span><span class='line'>[INFO] Application ....................................... SUCCESS [0.663s]
</span><span class='line'>[INFO] ------------------------------------------------------------------------
</span><span class='line'>[INFO] BUILD SUCCESS
</span><span class='line'>[INFO] ------------------------------------------------------------------------
</span><span class='line'>[INFO] Total time: 6.923s
</span><span class='line'>[INFO] Finished at: Sun Jan 06 16:41:29 CET 2013
</span><span class='line'>[INFO] Final Memory: 19M/81M
</span><span class='line'>[INFO] --------------------------------------------------------------------</span></code></pre></td></tr></table></div></figure>


<p>5) In the GlassFish installation directory, there is a <code>javadb</code> directory that contains, Derby, a Java-based database. Starts the network server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;$ pwd
</span><span class='line'>/~/Applications/glassfish3/javadb/bin
</span><span class='line'>localhost:bin ~$ ./startNetworkServer
</span><span class='line'>Mon Jan 07 06:02:54 CET 2013 : Security manager installed using the Basic server security policy.
</span><span class='line'>Mon Jan 07 06:02:54 CET 2013 : Apache Derby Network Server - 10.8.1.2 - (1095077) started and ready to accept connections on port 1527</span></code></pre></td></tr></table></div></figure>


<p>The database server listens to the port <code>1527</code>.</p>

<p>Now that the database is started. It is time to populate the database with the database creation scripts as well as some data.
In the project, under the ejb components, there is a sql file that initializes the database structure as well as some data.</p>

<p>Derby provides a command line tool called <code>ij</code> to connect to the database and to execute sql scripts:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>localhost:bin ~$ pwd
</span><span class='line'>~/Applications/glassfish3/javadb/bin
</span><span class='line'>localhost:bin ~$./ij ~/git/jee6demo/jee6-ejb/src/main/resources/sql/createStudentsDB_DERBY.sql
</span><span class='line'>...
</span><span class='line'>ij&gt; QUIT;</span></code></pre></td></tr></table></div></figure>


<p>Now the database is ready to use.</p>

<p>6) Create a datasource in GlassFish that points to the  database server that has been started previously:</p>

<p>First, let us create a connection pool:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-jdbc-connection-pool  --datasourceclassname=org.apache.derby.jdbc.ClientDataSource40 --restype=javax.sql.DataSource --property user=DEV:DatabaseName=StudentsDB:Password=DEV:ServerName=localhost:PortNumber=1527:create=true StudentsDB
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>222JDBC connection pool StudentsDB created successfully.
</span><span class='line'>Command create-jdbc-connection-pool executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>The connection pool provides a &#8230; pool of connection that is managed by the application server. A major benefit being that the developer does not have to open and close connections.
The server opens n connections and allocate them on demand. It ensures that there will not be 1000 open connections to the database thus improving the performances.
Then, we create a datasource that uses the previous connection pool:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-jdbc-resource --connectionpoolid StudentsDB --enabled jdbc/StudentsDS
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>JDBC resource jdbc/StudentsDS created successfully.
</span><span class='line'>Command create-jdbc-resource executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>7) Configure the messaging resources.</p>

<p>The tutorial uses JMS (Java Messaging Service) to implement the publish/subscribe pattern. The following script builds a connection factory for JMS queues.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-jms-resource --restype javax.jms.QueueConnectionFactory --enabled  MyConnectionFactory
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Connector resource MyConnectionFactory created.
</span><span class='line'>Command create-jms-resource executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>The following snippet declares the JMS queue. That is the message endpoint.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-jms-resource --restype javax.jms.Queue MyQueue
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Administered object MyQueue created.
</span><span class='line'>Command create-jms-resource executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>8) Configure the security</p>

<p>Authentication and authorization is another major feature that is provided by the application server.
First let us create the realm with two groups user and manager.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-auth-realm --classname com.sun.enterprise.security.auth.realm.file.FileRealm  --property assign-groups=manager,user:file=jee6-tutorial-file-realm:jaas-context=fileRealm jee6-tutorial-file-realm
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Command create-auth-realm executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>Then, we add a user that belongs two groups: user and manager.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-file-user --authrealmname jee6-tutorial-file-realm --groups user:manager user1
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Enter the user password&gt; 
</span><span class='line'>Enter the user password again&gt; 
</span><span class='line'>Command create-file-user executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>The second user only belongs to the group user.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-file-user --authrealmname jee6-tutorial-file-realm --groups user user2
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Enter the user password&gt; 
</span><span class='line'>Enter the user password again&gt; 
</span><span class='line'>Command create-file-user executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>9) Deploy the application</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; deploy ~/git/jee6demo/jee6-ear/target/jee6-demo-ear-1.0.0-SNAPSHOT.ear
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Application deployed with name jee6-demo-ear-1.0.0-SNAPSHOT.
</span><span class='line'>Command deploy executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>10) Test the application</p>

<p>Once deployed, serve to <a href="http://localhost:8080/jee6-demo-web/facade/studentService/all"><code>http://localhost:8080/jee6-demo-web/facade/studentService/all</code></a> and you should get:
You must log yourself with one of the use that you created at step 8).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;studentsDto</span> <span class="na">xmlns:ns2=</span><span class="s">&quot;http://ch.demo.app&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;students&gt;</span>
</span><span class='line'>      <span class="nt">&lt;id&gt;</span>0<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>      <span class="nt">&lt;last_name&gt;</span>Doe<span class="nt">&lt;/last_name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;firstName&gt;</span>John<span class="nt">&lt;/firstName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;birthDate&gt;</span>1965-12-10T00:00:00+01:00<span class="nt">&lt;/birthDate&gt;</span>
</span><span class='line'>      <span class="nt">&lt;phoneNumber&gt;</span>
</span><span class='line'>      <span class="nt">&lt;areaCode&gt;</span>0<span class="nt">&lt;/areaCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;countryCode&gt;</span>0<span class="nt">&lt;/countryCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;number&gt;</span>0<span class="nt">&lt;/number&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/phoneNumber&gt;</span>
</span><span class='line'>      <span class="nt">&lt;address&gt;</span>
</span><span class='line'>          <span class="nt">&lt;number&gt;</span>22<span class="nt">&lt;/number&gt;</span>
</span><span class='line'>          <span class="nt">&lt;street&gt;</span>wisteria street<span class="nt">&lt;/street&gt;</span>
</span><span class='line'>          <span class="nt">&lt;city&gt;</span>Downtown<span class="nt">&lt;/city&gt;</span>
</span><span class='line'>          <span class="nt">&lt;postalCode&gt;</span>34343<span class="nt">&lt;/postalCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/address&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/students&gt;</span>
</span><span class='line'>  <span class="nt">&lt;students&gt;</span>
</span><span class='line'>      <span class="nt">&lt;id&gt;</span>1<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>      <span class="nt">&lt;last_name&gt;</span>Doe<span class="nt">&lt;/last_name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;firstName&gt;</span>Jane<span class="nt">&lt;/firstName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;birthDate&gt;</span>1985-12-10T00:00:00+01:00<span class="nt">&lt;/birthDate&gt;</span>
</span><span class='line'>      <span class="nt">&lt;phoneNumber&gt;</span>
</span><span class='line'>      <span class="nt">&lt;areaCode&gt;</span>0<span class="nt">&lt;/areaCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;countryCode&gt;</span>0<span class="nt">&lt;/countryCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;number&gt;</span>0<span class="nt">&lt;/number&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/phoneNumber&gt;</span>
</span><span class='line'>      <span class="nt">&lt;address&gt;</span>
</span><span class='line'>          <span class="nt">&lt;number&gt;</span>22<span class="nt">&lt;/number&gt;</span>
</span><span class='line'>          <span class="nt">&lt;street&gt;</span>wisteria street<span class="nt">&lt;/street&gt;</span>
</span><span class='line'>          <span class="nt">&lt;city&gt;</span>Downtown<span class="nt">&lt;/city&gt;</span>
</span><span class='line'>          <span class="nt">&lt;postalCode&gt;</span>34343<span class="nt">&lt;/postalCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/address&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/students&gt;</span>
</span><span class='line'><span class="nt">&lt;/studentsDto&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you are ready to follow me in the EJB world.</p>

<p>The tutorial is organized in three parts. First, in this post, we will look at the EJB stack. In following posts, we will cover both the Context and Dependency Injection and the Java Persistence API.</p>

<h1><a id="ejbs"></a>EJBs</h1>

<p>The EJB API provides useful non-functional services to Java Enterprise Applications such as transactionality, security, pooling, and thread-safety.
Server side components that implement this API and wrap up business logic are called Enterprise Java Beans (EJBs). While the first versions were infamously known for the boilerplate code as well as their low testability,
EJB 3.x are rather easy to use thanks to a new design paradigms called <a href="http://en.wikipedia.org/wiki/Convention_over_configuration" title="Convention over Configuration on Wikipedia">Convention over Configuration</a>. The idea is to specify unconventional aspects rather than everything. This dramatically reduces the boilerplate code and improves readability.</p>

<p>Furthermore, the massive usage of annotations instead of XML descriptor greatly improves the productivity. In the sequel, I mostly rely on annotations. Nevertheless, every annotation has its counterpart in a configuration descriptor that is called <code>ejb-jar.xml</code>.</p>

<blockquote><p>In case there is two different value for the same property, remember that one from the <code>ejb-jar.xml</code> always overrides the annotation.</p></blockquote>

<p>Enterprise Java Beans are of three kinds:</p>

<ul>
<li><strong>Session Beans</strong>: components whose execution is triggered by a client call. The call can be local (within the JVM) or remote (by another JVM).</li>
<li><strong>Message Beans</strong>: execution is triggered by a message and the business logic is processed asynchronously. Please note that, since JEE6 there are other (simpler) ways to process logic asynchronously. Nevertheless, Message Beans
remain very useful to implement bus and/or publish-subscribe patterns and to enforce loose coupling between the client and the server component.</li>
<li><strong>Entity Beans</strong>: I will not discuss entity beans as they have been replaced by the <a href="http://jcp.org/aboutJava/communityprocess/final/jsr317/index.html" title="JPA 2.0 specification">JPA 2.0 specification</a>.</li>
</ul>


<h2><a id="sb"></a>Session Beans</h2>

<p>As mentioned previously, session beans (merely) react on client invocation. Henceforth, the bean can either take the client session into account (thus it shares a state between multiple client invocations) or it can treat each call as unrelated.
In the first case, the EJB is called <strong>Stateful</strong> while in the latter it is called <strong>Stateless</strong>.</p>

<h3><a id="slsb"></a>Stateless Session Beans</h3>

<p>Let us start with a <strong>Stateless</strong> bean. The following Java class describes a Stateless EJB.
The most important part is the annotation <code>@Stateless</code> at the top of the class.
This marks the class as an EJB. When the container instantiates this class, it knows that
it is a so-called <strong>Managed Bean</strong>. By this, it means that the container manages the bean&#8217;s lifecycle (e.g., instantiation, passivation). Furthermore, as an EJB, it has access to the container services such as security and transactionality.</p>

<p>The following snippet describes a Stateless Session bean that computes a grade distribution. The method is secured and only authorized to client that have the role <code>user</code> through the <code>@RolesAllowed({ "user" })</code> annotation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceJPAImpl</span> <span class="kd">implements</span> <span class="n">StudentService</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="nd">@RolesAllowed</span><span class="o">({</span> <span class="s">&quot;user&quot;</span> <span class="o">})</span> <span class="c1">// This a role-based security.</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Integer</span><span class="o">[]</span> <span class="nf">getDistribution</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">numberOfAccess</span><span class="o">++;</span>
</span><span class='line'>        <span class="n">Integer</span><span class="o">[]</span> <span class="n">grades</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">[</span><span class="n">n</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">Student</span> <span class="n">s</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">getAll</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">grades</span><span class="o">[(</span><span class="n">s</span><span class="o">.</span><span class="na">getAvgGrade</span><span class="o">().</span><span class="na">intValue</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="n">TOTAL</span> <span class="o">/</span> <span class="n">n</span><span class="o">)]++;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">grades</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'> <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note that the previous EJB implements an interface. An EJB can be local (invokable from within the container),
remote (invokable from another JVM) or both. In the previous case, it is a local interface and therefore the bean is only
invokable locally.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Local</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudentService</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">  * @return an array that contains the distribution of the grades. It</span>
</span><span class='line'><span class="cm">  *         partitions the grades in &quot;n&quot; parts.</span>
</span><span class='line'><span class="cm">  * @param n : number of parts</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kt">int</span><span class="o">[]</span> <span class="nf">getDistribution</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">n</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Adding a remote invocation to the implementation amounts to add an interface that is annotated <code>@Remote</code>.
Of course, the interface may be different and may exposes different services locally and remotely.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Remote</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudentServiceRemote</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * @param lastname</span>
</span><span class='line'><span class="cm">     *            of the student</span>
</span><span class='line'><span class="cm">     * @return the student with the given lastname.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">Student</span> <span class="nf">getStudentByLastName</span><span class="o">(</span><span class="n">String</span> <span class="n">lastname</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The implementation must be changed as follow to be remotely invokable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceJPAImpl</span> <span class="kd">implements</span> <span class="n">StudentService</span><span class="o">,</span> <span class="n">StudentServiceRemote</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>To use this EJB, we need a client code. The easiest possible interaction is either via a JAX-RS service or via a servlet.
In the JEE6-Demo, under the JEE6-WEB project the JAX-RS facade is called <code>StudentFacade.java</code>. It implements a JAX-RS facade over the <code>StudentService</code>.</p>

<p>The method <code>getDistribution()</code> uses the student service that is injected via <code>@EJB</code> in the
facade. <a href="http://en.wikipedia.org/wiki/Dependency_injection" title="Dependency Injection on Wikipedia">Dependency injection</a>  is now a first class citizen in the JEE6 stack.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@ApplicationScoped</span> <span class="c1">// This sets the scope to application level</span>
</span><span class='line'><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/studentService&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceFacade</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="nd">@EJB</span>
</span><span class='line'>  <span class="n">StudentService</span> <span class="n">studentService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@GET</span>
</span><span class='line'>  <span class="nd">@Produces</span><span class="o">({</span> <span class="s">&quot;application/xml&quot;</span><span class="o">,</span> <span class="s">&quot;application/json&quot;</span> <span class="o">})</span>
</span><span class='line'>  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;distribution&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">getDistribution</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Integer</span><span class="o">[]</span> <span class="n">distrib</span> <span class="o">=</span> <span class="n">studentService</span><span class="o">.</span><span class="na">getDistribution</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="k">new</span> <span class="n">DistributionDto</span><span class="o">(</span><span class="n">distrib</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following snippet illustrates the injection of a Stateless EJB into a Servlet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">&quot;/student&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@EJB</span>
</span><span class='line'>  <span class="n">StudentService</span> <span class="n">studentService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()</span>
</span><span class='line'>              <span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;There are #&quot;</span> <span class="o">+</span> <span class="n">studentService</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; students in the database&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">arg1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">doGet</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, implementing EJBs (and invoking them) is rather easy. So far, we did not talk much about transactionality and security so you might wonder why using EJBs for such simple business services. The answer is pooling and thread-safety. As the container manages a pool of EJBs, it handles the invocation queue and you do not have to manager re-entrance and thread-safety.</p>

<blockquote><p>Remember that there is a <strong>one to many relationship</strong> between a stateless session bean and the clients. In other words, one instance may manage different clients. Hence, there must be not field that represent a client state in a <strong>Stateless</strong> EJB because there is no guarantee that a given client will get the same SLSB accross two invokations. Nevertheless, within a given invokation the client is guaranteed to be the only user.</p></blockquote>

<p>Consider the following exercises.</p>

<blockquote><p><em>Exercise 1:</em> Add a new method to the StudentService service that computes the standard deviation and use this method in the JAX-RS facade.</p>

<p><em>Exercise 2:</em> Add a counter that is incremented each and every time a method is invoked. Print out the thread-id (and if possible the session-id) and explain why the so-called stateless beans must be without state. Add a rest service to interface this method.</p></blockquote>

<h4><a id="trx"></a>Transactionality</h4>

<p><a href="http://en.wikipedia.org/wiki/Database_transaction" title="Transactions on wikipedia">Transactions</a> are important concepts when dealing with enterprise applications. It is of vital importance that whenever something goes wrong, the transaction is roll-backed. This preserves the <a href="http://en.wikipedia.org/wiki/ACID" title="ACID in wikipedia">ACID</a> properties. Managing database transactions with JDBC is complex to say the least. Remember that we often have to manage transactions over several databases and even between databases and messaging queues. If the processing of a message leads to a database exception, we might want to put the message back in the queue.</p>

<p>Lucky for us, JEE 6 manages (almost) everything by itself. By default a bean is transactional and each method either reuse a running transaction or creates a new one if necessary.</p>

<blockquote><p>By default the transaction (or transaction context) is propagated to other business methods that are called from within a transactional method.</p></blockquote>

<p>In JEE, there is two types of transaction management:</p>

<ul>
<li><p><strong>Bean Managed</strong> : In this case the bean is annotated with <code>@TransactionManagement(TransactionManagementType.BEAN)</code>. In this mode, the developer must manage the transaction himself.</p></li>
<li><p><strong>Container Managed</strong>: this is the default behavior and it corresponds to marking the bean <code>@TransactionManagement(TransactionManagementType.CONTAINER)</code>. This mode is called <strong>Container Managed Transaction Demarcation</strong>. This idea is that every public method is transactional and is marked as <code>@Required</code>.</p></li>
</ul>


<p>The following snippet shows how to use bean demarcation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MessageDriven</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@TransactionManagement</span><span class="o">(</span><span class="n">TransactionManagementType</span><span class="o">.</span><span class="na">BEAN</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentRegistrationService</span> <span class="kd">implements</span> <span class="n">MessageListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PersistenceContext</span>
</span><span class='line'>  <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">inMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">TextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>          <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextMessage</span><span class="o">)</span> <span class="n">inMessage</span><span class="o">;</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;MESSAGE BEAN: Message received: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and now the exact same class using container demarcation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MessageDriven</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentRegistrationService</span> <span class="kd">implements</span> <span class="n">MessageListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PersistenceContext</span>
</span><span class='line'>  <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">inMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">TextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>          <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextMessage</span><span class="o">)</span> <span class="n">inMessage</span><span class="o">;</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;MESSAGE BEAN: Message received: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because the previous snippet relies on the default convention, it is equivalent to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MessageDriven</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@TransactionManagement</span><span class="o">(</span><span class="n">TransactionManagementType</span><span class="o">.</span><span class="na">CONTAINER</span><span class="o">)</span>
</span><span class='line'><span class="nd">@TransactionAttribute</span><span class="o">(</span><span class="n">TransactionAttributeType</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentRegistrationService</span> <span class="kd">implements</span> <span class="n">MessageListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Inject</span> <span class="c1">// Let&#39;s ignore this for the moment</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">transient</span> <span class="n">Logger</span> <span class="n">logger</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PersistenceContext</span>
</span><span class='line'>  <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Resource</span> <span class="c1">// Let&#39;s ignore this for the moment</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">MessageDrivenContext</span> <span class="n">mdbContext</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">inMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">TextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>          <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextMessage</span><span class="o">)</span> <span class="n">inMessage</span><span class="o">;</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;MESSAGE BEAN: Message received: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In other terms, it uses container managed transaction demarcation <code>@TransactionManagement(TransactionManagementType.CONTAINER)</code>.
Moreover, each and every public method either reuses an existing transaction or creates a new one if none has been started <code>@TransactionAttribute(TransactionAttributeType.REQUIRED)</code></p>

<p>The <code>@TransactionAttribute</code> annotation can also be put directly on the method. Valid options are:</p>

<ul>
<li><code>REQUIRED</code>: if there is an existing transaction then it reuses it, otherwise it creates a new one.</li>
<li><code>REQUIRES_NEW</code>: it always creates a new transaction</li>
<li><code>NEVER</code>: if there is an existing transaction then it fails</li>
<li><code>MANDATORY</code>: if there is an existing transaction then it reuses it, otherwise it fails</li>
<li><code>NOT_SUPPORTED</code>: If there is a transaction then it suspends it and it does not propagate the transaction to other business methods, otherwise it does nothing.</li>
<li><code>SUPPORTS</code>: If a transaction exists then it works as for <code>REQUIRED</code>, otherwise it works as for <code>NOT_SUPPORTED</code>.</li>
</ul>


<p>Consider the following exercises.</p>

<blockquote><p><em>Exercise 3:</em> Test the different types of transaction attribute and observe their respective behavior.</p>

<p><em>Exercise 4:</em> Are the snippets 1 and 2 semantically equivalent?</p>

<p><em>Exercise 5:</em> Mix the two types of transaction management.</p></blockquote>

<h4><a id="secu"></a>Security</h4>

<p>Another great feature of EJBs is their ability for declarative authorization and the integration in the JAAS framework. JAAS is the Java Authentication and Authorization Service
It provides unified services to access user directories for user authentication and their authorization. As the client is already authenticated, at the EJB level, only authorization matters.</p>

<p>After authentication, a principal (e.g., user name, role) is set in the context. This principal is used for authorization.</p>

<p>The main annotation is <code>@RolesAllowed</code> followed by a list of authorized roles. As an example, look at the method <code>getDistribution</code> of <code>StudentServiceJPAImpl.java</code>. The method is only allowed for client that belongs to the group/role <code>user</code>.</p>

<p>Sometimes, a method of an EJB is not executed in the context of an authenticated user or the authenticated user has not enough credentials. If it is still important to run the method, you can use the <code>@RunAs</code> annotation. This basically overrides the current security context (and the associated principal) similarly to <code>sudo</code> for UNIX.</p>

<p>In any EJB, it is possible to get the current client session and therefore the principal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Resource</span>
</span><span class='line'><span class="n">SessionContext</span> <span class="n">ctx</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// obtain the principal. </span>
</span><span class='line'>  <span class="n">Principal</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getCallerPrincipal</span><span class="o">();</span>
</span><span class='line'>  <span class="c1">// obtain the name. </span>
</span><span class='line'>  <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">callerPrincipal</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'>  <span class="c1">// Is the caller an admin?</span>
</span><span class='line'>  <span class="n">ctx</span><span class="o">.</span><span class="na">isCallerInRole</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 6:</em> Change the method getDistribution to only allow client that belong to the <code>admin</code> group. Log as a user and as an admin, check the servlet as well as the JAX-RS service. What do you observe?</p>

<p><em>Exercise 7:</em> Add a new Role to the application, and use it. Warning, some configurations are vendor specific.</p>

<p><em>Exercise 8:</em> Create a service that uses <code>@RunAs</code> to upgrade the credentials of a standard user in order to call another service that requires the admin level.</p></blockquote>

<h4><a id="callbacks"></a> Callbacks and Interceptors</h4>

<p>Interceptors are used to enhance the business method invocations and the beans&#8217; lifecycle events. Interceptors implements the AOP paradigm.</p>

<p>Interceptors are of two kinds:
- Lifecycle event interceptors such as <code>@PostConstruct</code>, <code>@PostActivate</code>, and <code>@PrePassivate</code>, and <code>@PreDestroy</code> enable to add logic when the bean is created or destroyed.
- Call-based interceptors that relies on the <code>@AroundInvoke</code> annotation.</p>

<p>In the first case, adding the annotation before the method declaration is enough. It will then be called when the lifecycle event occurs.
In the latter case, in addition to the annotation the developer must configure the <code>ejb-jar.xml</code> file.</p>

<p>Here is a simple interceptor that prints out the time consumed by a method call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@AroundInvoke</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Object</span> <span class="nf">intercept</span><span class="o">(</span><span class="n">InvocationContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>   <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
</span><span class='line'>   <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">StringBuilder</span> <span class="n">str</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&quot;******  &quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">str</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>      <span class="n">str</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; took :&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">str</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
</span><span class='line'>      <span class="n">str</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; ms  ******&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">mLogger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In addition to the interceptor declaration, it must be activated by mean of either an annotation on the target EJB or via the <code>ejb-jar.xml</code> file. If several interceptors are declared, then the order of declaration is the order of execution: the last is the most nested interceptor.</p>

<p>The following example presents the annotation based declaration.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="nd">@Interceptor</span><span class="o">({</span><span class="n">PerformanceEJBInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">StudentServiceJPAImpl</span> <span class="kd">implements</span> <span class="n">StudentService</span><span class="o">,</span> <span class="n">StudentServiceRemote</span> <span class="o">{</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>In the following snippet, the interceptor is applied to all methods whose name is like <code>get*</code> and EJB&#8217;s name is like <code>Student*</code>. It is also possible to specify the parameters&#8217; type in case of overloading.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;assembly-descriptor&gt;</span>
</span><span class='line'> <span class="c">&lt;!-- Default interceptor that will apply to all methods for all beans in deployment --&gt;</span>
</span><span class='line'> <span class="nt">&lt;interceptor-binding&gt;</span>
</span><span class='line'>      <span class="nt">&lt;ejb-name&gt;</span>Student*<span class="nt">&lt;/ejb-name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;method&gt;</span>
</span><span class='line'>           <span class="nt">&lt;method-name&gt;</span>get*<span class="nt">&lt;/method-name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/method&gt;</span>
</span><span class='line'>      <span class="nt">&lt;interceptor-class&gt;</span>ch.demo.business.interceptors.PerformanceEJBInterceptor<span class="nt">&lt;/interceptor-class&gt;</span>
</span><span class='line'>   <span class="nt">&lt;/interceptor-binding&gt;</span>
</span><span class='line'>   ...
</span><span class='line'><span class="nt">&lt;/assembly-descriptor&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 9:</em> Add an interceptor that for all public methods of <code>StudentServiceJPAImpl.java</code> to increments an overall (common to all clients) usage counter using the annotation based approach.</p>

<p><em>Exercise 10:</em> Do the same, but using the <code>`ejb-jar.xml</code>.</p></blockquote>

<h4><a id="timers"></a> Timers</h4>

<p>Some services are not directly linked to a client session. This is the case for batch processes that must run every x hours. To that end, EJB 3.1 provides the annotation <code>@Schedule</code> to specify how often a service method must be called. This is similar to the CRON  feature on UNIX systems.</p>

<p>The following example runs the method <code>doSomethingUseful</code> every 30 minutes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Schedule</span><span class="o">(</span><span class="n">minute</span><span class="o">=</span><span class="s">&quot;*/30&quot;</span><span class="o">,</span> <span class="n">hour</span><span class="o">=</span><span class="s">&quot;*&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomethingUseful</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 11:</em>  Add a scheduler that runs a method every minutes to print out the number of students in the database.</p>

<p><em>Exercise 12:</em>  <code>@Schedule</code> is often used in conjunction with <code>@RunAs</code>. Why?</p></blockquote>

<h4><a id="async"></a> Asynchronous calls</h4>

<p>Asynchronous calling means that the control is returned to the caller before the process has been completed. For instance, a batch job that loads 1000 customers description from one database, processes them and finally save them in another database. From a performances point of view, it is better to split the process in x batches and then to wait until every thing is finished. Firstly, if the asynchronous call is made to another EJB, it is possible to leverage the pool to have parallel treatments without managing multi-threading and race conditions. Secondly, as the different call may use different database connections, it will limit the database bottleneck.</p>

<p>To do this, JEE provides the <code>@Asynchronous</code> annotation. Any method that returns either nothing (<code>void</code>) or an instance of type <code>Future&lt;T&gt;</code> can be run asynchronously.</p>

<p>The <code>Future</code> interface exposes the method <code>get</code> that blocks until the job is over.
The following class, exposes the method <code>processJob</code> that runs asynchronously.</p>

<p>The methods <code>processJobs</code> starts 10 times the method processJob and put the resulting <code>Future&lt;String&gt;</code> in an array. Then it iterates of the pool and wait until all calls have returned.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BatchProcessor</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processJobs</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;[]</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;[</span><span class="mi">10</span><span class="o">];</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">pool</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">processJob</span><span class="o">(</span><span class="s">&quot;Job #&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">pool</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>    
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@Asynchronous</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">processJob</span><span class="o">(</span><span class="n">String</span> <span class="n">jobName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">();</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="n">AsyncResult</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">jobName</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 13:</em> Create an EJB that invoke an asynchronous method that runs 100 times. The asynchronous method should wait a random time between 5 and 10 seconds  before returning a the actual waiting time. Collect all the waiting times and compute the average.</p></blockquote>

<h3>Singleton Beans</h3>

<p>Singleton beans (<code>@Singleton</code>) are special kind of EJBS that exist only in one instance in the container. This is for instance useful to initialize the application. Thus, <code>@Singleton</code> can be associated with <code>@Startup</code> to start the EJB during container&#8217;s startup.</p>

<p>As there is only one instance, it means the bean is meant to be shared. Therefore, it is important to specify the locking policy. There are two types of locking:
- Container managed concurrency management <code>@ConcurrencyManagement(ConcurrencyManagementType.CONTAINER)</code>. This is the default behavior and it is highly recommended to stick to it. Annotating a method (or the class) with <code>@Lock(LockType.READ)</code> means that the method can be safely access concurrently. <code>@Lock(LockType.WRITE)</code> requires the calls to the method to be serialized. The methods are <code>@Lock(LockType.WRITE)</code> by default.
- Bean managed concurrency management <code>@ConcurrencyManagement(ConcurrencyManagementType.BEAN)</code>. This requires the developer to use synchronized and volatile to achieve good concurrency.</p>

<blockquote><p>By default the class is marked as <code>@Lock(LockType.WRITE)</code>, thus EVERY CALL is synchronized. This is probably not the expected behavior (at least most of the time) and produces a huge bottleneck. Make sure to set the proper lock policy on the class and to only put <code>@Lock(LockType.WRITE)</code> where needed.</p></blockquote>

<p>The following bean initialize a shared variable during container startup and lock the access to the modification to only one thread (client) at a time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Singleton</span>
</span><span class='line'><span class="nd">@Startup</span>
</span><span class='line'><span class="nd">@Lock</span><span class="o">(</span><span class="n">LockType</span><span class="o">.</span><span class="na">READ</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StatusBean</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">status</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PostConstruct</span>
</span><span class='line'>  <span class="kt">void</span> <span class="n">init</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="s">&quot;Ready&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getStatus</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">status</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Lock</span><span class="o">(</span><span class="n">LockType</span><span class="o">.</span><span class="na">WRITE</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStatus</span><span class="o">(</span><span class="n">String</span> <span class="k">new</span> <span class="n">Status</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="n">newStatus</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Lock</span><span class="o">(</span><span class="n">LockType</span><span class="o">.</span><span class="na">WRITE</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@AccessTimeout</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="mi">360000</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="n">doTediousOperation</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 14:</em> Write a singleton that reads the postal code from the database during startup, update them every 30 minutes. Take care of the concurrency aspects.</p></blockquote>

<h3><a id="sfsb"></a>Stateful Session Beans</h3>

<p>Unlike stateless session beans, stateful session beans maintain a state across several client invocation. This is because there is a one to one relationship between a client and a stateful session bean.</p>

<p>The following code snippet describes a stateful session bean that maintains a counter across several invocations.
A stateful session bean is annotated with <code>@Stateful</code>. As it is stateful, it maintains a session state and it is therefore important to set a timeout. Otherwise, the number of open session will raise and it will consume the server memory.
The timeout is defined using the <code>@StatefulTimeout</code> annotation.</p>

<blockquote><p>Because there is no instance sharing among several client, Stateful session beans are more resource-demanding than stateless session beans. Therefore, they should be used with great care.</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateful</span>
</span><span class='line'><span class="nd">@StatefulTimeout</span><span class="o">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">30</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentStatisticsServiceImpl</span> <span class="kd">implements</span> <span class="n">StudentStatisticsService</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Long</span> <span class="n">numberOfAccess</span> <span class="o">=</span> <span class="mi">0</span><span class="n">l</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getStatistics</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="s">&quot;The student service has been invoked #&quot;</span> <span class="o">+</span> <span class="n">numberOfAccess</span>
</span><span class='line'>              <span class="o">+</span> <span class="s">&quot; in this session&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">count</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">numberOfAccess</span><span class="o">++;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a stateful session bean is not per se linked to an HTTP session, the application client code must ensure to remember which instance of the EJB is dedicated to which client.
When used in conjunction with a Servlet, Stateful beans are often put in the HTTP session for further reuse.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">StudentStatisticsService</span> <span class="n">statistics</span> <span class="o">=</span> <span class="o">(</span><span class="n">StudentStatisticsService</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span>
</span><span class='line'>              <span class="n">StudentStatisticsService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">statistics</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">InitialContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span><span class='line'>              <span class="n">statistics</span> <span class="o">=</span> <span class="o">(</span><span class="n">StudentStatisticsService</span><span class="o">)</span> <span class="n">ctx</span>
</span><span class='line'>                      <span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;java:global/JEE6-EAR/JEE6-EJB-0.0.1-SNAPSHOT/StudentStatisticsServiceImpl&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">StudentStatisticsService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">statistics</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">statistics</span><span class="o">.</span><span class="na">count</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;There are #&quot;</span> <span class="o">+</span> <span class="n">studentService</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; students in the database&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="n">statistics</span><span class="o">.</span><span class="na">getStatistics</span><span class="o">());</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="n">studentService</span><span class="o">.</span><span class="na">getStatistics</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Either the EJB is looked-up with JNDI and then put into the HTTP session or, when using CDI, the link is made based on the caller scope.
The class <code>StudentServiceFacade.java</code> describes how the injection automatically links the correct instance of a stateful session bean to a given based on the <code>@SessionScoped</code> annotation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@SessionScoped</span>
</span><span class='line'><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/studentService&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceFacade</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1318211294294344900L</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@EJB</span>
</span><span class='line'>  <span class="n">StudentService</span> <span class="n">studentService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@EJB</span>
</span><span class='line'>  <span class="n">StudentStatisticsService</span> <span class="n">studentServiceStatistics</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@GET</span>
</span><span class='line'>  <span class="nd">@Produces</span><span class="o">({</span> <span class="s">&quot;application/xml&quot;</span><span class="o">,</span> <span class="s">&quot;application/json&quot;</span> <span class="o">})</span>
</span><span class='line'>  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;session&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">getSessionStatistics</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">studentServiceStatistics</span><span class="o">.</span><span class="na">getStatistics</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Consider the following exercise.</p>

<blockquote><p><em>Exercise 15:</em> Show that two sessions share the same overall count but not the same per session count.</p></blockquote>

<p>As the container does not share the stateful instances, it might run out of memory and therefore it will try to save the state of the bean on disk (or database). This operation is called <strong>Passivation</strong>. Afterwards, when the client comes back and requires its stateful instance, the container loads it from the disk. This operation is called <strong>Activation</strong>.</p>

<p>Some operations such as initializing/cleaning File, a socket connection, or a database connection can be made before activation and/or after activation using the following
<code>@PrePassivate</code> and the <code>@PostActivate</code> annotations.</p>

<p>Consider the following exercises:</p>

<blockquote><p><em>Exercise 16:</em> Stop the server and observe that the bean has been passivated.</p>

<p><em>Exercise 17:</em> Start the server and observe that the bean has been activated.</p></blockquote>

<p>Whenever the user logs out and thus invalidate the HTTP Session, you might want to clean up the EJB state and release the resources. To achieve this, the client must call a method annotated with <code>@Remove</code>. As soon as the client call is over the container can garbage the bean. The idea is simply to get ahead of the timeout.</p>

<blockquote><p><em>Exercise 18:</em> Implements two methods with <code>@Remove</code> with two different behaviors. Check that both will discard the current instance. Hint: you can use <code>@PreDestroy</code> to check the bean&#8217;s destruction.</p></blockquote>

<h2>Message Driven Beans</h2>

<p>Message driven beans (MDB) are very useful for asynchronous process and for decoupling the client from the processor. MDB implement a typical publish/subscribe architecture.</p>

<p>There are two kinds of objects, a MDB can listen to:</p>

<ul>
<li><strong>Topics</strong>: pure publish/subscribe semantics. A new message will be processed by every listeners.</li>
<li><strong>Queue</strong>: more of a load balancer, once the message is consumed by one of the listeners, it
is removed from the queue.</li>
</ul>


<p>Although, there is, in JEE6, another mechanism for asynchronous processing, MDBs remain the best alternative if you do not want the client to be aware of the asynchronous logic and processor.</p>

<p>The idea is that there is a queue (or a topic) in between. Therefore, the client as no knowledge whatsoever of the message processor contract or semantics.</p>

<p>The first step is to configure a Queue Connection Factory as well as a Queue in the application server.</p>

<p>The following servlet gets  the connection factory as well as the queue injected. As always with dependency injection, the same result can be achieved using JNDI lookups.
For each request to the servlet 100 messages are generated and put in the Queue called <code>MyQueue</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">&quot;/registration&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegistrationServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>      
</span><span class='line'>  <span class="nd">@Resource</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyConnectionFactory&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">ConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Resource</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Queue</span> <span class="n">queue</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span>  <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">Connection</span> <span class="n">connection</span><span class="o">;</span>
</span><span class='line'>          <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
</span><span class='line'>          <span class="n">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">TextMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">message</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;This is message &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>              <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following MDB listens to <code>MyQueue</code> (thanks to the annotation <code>@MessageDriven(mappedName = "MyQueue")</code> and because it implements the <code>MessageListener</code> interface it takes a message when available.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MessageDriven</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentRegistrationService</span> <span class="kd">implements</span> <span class="n">MessageListener</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Resource</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">MessageDrivenContext</span> <span class="n">mdbContext</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">inMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">TextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">inMessage</span> <span class="k">instanceof</span> <span class="n">TextMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextMessage</span><span class="o">)</span> <span class="n">inMessage</span><span class="o">;</span>
</span><span class='line'>              <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;MESSAGE BEAN: Message received: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Message of wrong type: &quot;</span>
</span><span class='line'>                      <span class="o">+</span> <span class="n">inMessage</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">mdbContext</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">();</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is a sample output. As you can see, the messages are processed according to their input order but not necessarily by the same EJB (worker).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">1</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">2</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">3</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">1</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">2</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">5</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">6</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">4</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">5</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>


<p>Consider the following exercises:</p>

<blockquote><p><em>Exercise 19:</em> Compare Message Driven Beans and Session Beans with asynchronous calls.</p>

<p><em>Exercise 20:</em> Print out the thread-id. What do you observe?</p>

<p><em>Exercise 21:</em> Create another MDB that consumes the same queue. What do you observe?</p>

<p><em>Exercise 22:</em> Do the same (2 consumers) but using a <code>Topic</code> instead of a <code>Queue</code>.</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/05/servicelocator/">Context Dependency Injection and the Rich Object Model</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-05T06:59:00+01:00" pubdate data-updated="true">Dec 5<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/12/05/servicelocator/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>[Rich object model] vs [anemic object model] is long running debate. While the latter encourages to use simple and stupid objects with little or no business in them, the rich object model advocates for a clean object design with inheritance, polymorphism and so on.
The anemic object model is very popular among JEE partitioners because, in the past, the specification did not provide any mean to invoke services in business objects. Therefore, the anemic pattern uses so called &#8220;managers&#8221; that maintain references to other &#8220;managers&#8221;. A direct benefit is the clear separation of concerns between the different kind of objects. Basically, it splits processing and data. As this is anti-object oriented, the abstract design of such system is often very different from the actual implementation.</p>

<h2>The portfolio example</h2>

<p>As example, let us take a portfolio that contains a set of financial position. A financial position can be either a set of stock, or an amount in a given currency. To evaluate the actual portfolio value, we go through the positions and for each of them we ask the current quote for stock to the service <code>QuoteService</code> or the current value of a given currency to the <code>CurrencyService</code>.
The next figure presents the &#8220;ideal&#8221; design.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/portfolio-business.png' width='' height='' alt='An object oriented class diagram of the Portfolio management component.' title='An object oriented class diagram of the Portfolio management component.'><span class='caption-text'>An object oriented class diagram of the Portfolio management component.</span></span></p>

<p>To achieve this, one need to access services from within business objects. Since EJB 3.1,  Context and Dependency Injection (CDI) provides such a mechanism via the <code>@Inject</code> annotation. The only requirement is that the object that requires the service as well as the service to inject are so called &#8220;managed beans&#8221;. The trick is that not all objects are meant to be managed. Furthermore, having managed lists of object is very tricky to say the least. Fortunately, the EJB 3.1 and more specifically the CDI 1.0 specification provide a way to solve this.
In CDI, the main component is the bean manager. This manager keeps track of the beans to inject via @Inject and other means. Instead of relying on annotations to provide injection, it is possible to use the good old Service Locator pattern. CDI 1.0 exposes the bean manager on JNDI with the name <code>java:comp/BeanManager</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLocator</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">getInstance</span><span class="o">(</span><span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">T</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Access to the current context.</span>
</span><span class='line'>          <span class="n">InitialContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span><span class='line'>          <span class="c1">//Resolve the bean manager</span>
</span><span class='line'>          <span class="n">BeanManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">BeanManager</span><span class="o">)</span> <span class="n">ctx</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;java:comp/BeanManager&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="c1">//Retrieve all beans of that type</span>
</span><span class='line'>          <span class="n">Set</span><span class="o">&lt;</span><span class="n">Bean</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">beans</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">getBeans</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
</span><span class='line'>          <span class="n">Bean</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">bean</span> <span class="o">=</span> <span class="o">(</span><span class="n">Bean</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;)</span> <span class="n">manager</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">beans</span><span class="o">);</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">CreationalContext</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">context</span> <span class="o">=</span> <span class="n">manager</span>
</span><span class='line'>                      <span class="o">.</span><span class="na">createCreationalContext</span><span class="o">(</span><span class="n">bean</span><span class="o">);</span>
</span><span class='line'>              <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">manager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The client code is very simple. It consists in calling the <code>ServiceLocator</code>with the desired interface.
For the sake of clarity, I did not show the ServiceLocator that takes a qualifier in addition to the interface. To add this feature, look at the <code>getBeans(Type beanType, Annotation... qualifiers)</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StockPos</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Long</span> <span class="n">qty</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">stockId</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Double</span> <span class="nf">evaluate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">StockQuoteService</span> <span class="n">sqs</span> <span class="o">=</span> <span class="n">ServiceLocator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">StockQuoteService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">qty</span> <span class="o">*</span> <span class="n">sqs</span><span class="o">.</span><span class="na">getQuoteValue</span><span class="o">(</span><span class="n">stockId</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Similarly, here is the code of the <code>CurrencyPos</code> object.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CurrencyPos</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Double</span> <span class="n">amount</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">currencyId</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Double</span> <span class="nf">evaluate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">CurrencyQuoteService</span> <span class="n">sqs</span> <span class="o">=</span> <span class="n">ServiceLocator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">CurrencyQuoteService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">sqs</span><span class="o">.</span><span class="na">getQuoteValue</span><span class="o">(</span><span class="n">stockId</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Some thoughts on the Demeter law</h2>

<p>Let me be clear, I do <strong>not</strong> recommend this approach everywhere. It is very important to not mix the objects responsabilities. Furthermore,
in order to respect the Demeter law, a business must <strong>not</strong> directly call something outside of the current component. Calls to other components are always to be done through so-called consumers to have clear components boundaries.
For instance, putting to much intelligence in JPA entities that can be detached and serialized may cause problems on the client side.</p>

<h2>Conclusion</h2>

<p>In this post, I showed a solution to consume services that are exposed via the CDI BeanManager. These services can be pure POJOs or EJBs.
Nevertheless, this approach must be used with great care as it can blur the components boundaries and responsabilities.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/20/multi-tenancy/">Multi-Tenancy With EJB 3.1 and JPA 2.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-20T05:18:00+01:00" pubdate data-updated="true">Nov 20<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/11/20/multi-tenancy/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Multi-tenancy is a recurrent non functional requirement. Indeed, many important IT-systems are meant to be shared among multiple tenants. The data are often distributed over several databases or schemas. This, for different reasons:</p>

<ul>
<li>Security: The data belong to different customers and some level of isolation is required;</li>
<li>Performances: Distributing the data over multiple systems may help to master performance issues;</li>
<li>Legacy: Sometimes, old and new systems must cohabit for a (long) time;</li>
<li>Maintenability: A database or a schema can be updated without putting the rest of the application at risk.</li>
</ul>


<p>Although data are distributed, the application code should remain tenant agnostic. Furthermore, choosing between the different tenants is often made at runtime based on credentials (e.g. user Joe has access to customer AAAA while user Jane sees data of customer BBB). <a href="/https://blogs.oracle.com/arungupta/entry/java_ee_7_key_features">Java EE 7 will address this problem and much more</a>, but in the mean time here is the way that I use to address this problematic using EJB 3.1 and JPA 2.0</p>

<h2>Overall architecture</h2>

<p>First, let me start with the overall architecture as described below.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/multi-tenancy-architecture.png' width='' height='' alt='Multi-tenancy architecture with serveral datasources' title='Multi-tenancy architecture with serveral datasources'><span class='caption-text'>Multi-tenancy architecture with serveral datasources</span></span></p>

<p>In the above figure, the database is organized in schemas, with one application server datasource (DS) per schema and one persistence unit (PU) per datasource.
It is also possible to use only one datasoure and to discriminate between schemas by setting the <code>&lt;property name="openjpa.jdbc.Schema" value="TenantX" /&gt;</code> property for each persistence unit (PU). This sets the default schema for the PU.
Here is a <code>persistence.xml</code> file that provides one persistence unit per tenant.</p>

<p>The following code has been tested for Open-JPA but there is nothing specific to this implementation outside of the <code>&lt;provider&gt;</code>tag in the <code>persistence.xml</code>file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;persistence</span> <span class="na">version=</span><span class="s">&quot;2.0&quot;</span>
</span><span class='line'>  <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;Tenant1&quot;</span> <span class="na">transaction-type=</span><span class="s">&quot;JTA&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;provider&gt;</span>
</span><span class='line'>          org.apache.openjpa.persistence.PersistenceProviderImpl
</span><span class='line'>      <span class="nt">&lt;/provider&gt;</span>
</span><span class='line'>      <span class="nt">&lt;jta-data-source&gt;</span>jdbc/Tenant1_DS<span class="nt">&lt;/jta-data-source&gt;</span>
</span><span class='line'>      <span class="nt">&lt;exclude-unlisted-classes&gt;</span>false<span class="nt">&lt;/exclude-unlisted-classes&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/persistence-unit&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;Tenant2&quot;</span> <span class="na">transaction-type=</span><span class="s">&quot;JTA&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;provider&gt;</span>
</span><span class='line'>          org.apache.openjpa.persistence.PersistenceProviderImpl
</span><span class='line'>      <span class="nt">&lt;/provider&gt;</span>
</span><span class='line'>      <span class="nt">&lt;jta-data-source&gt;</span>jdbc/Tenant2_DS<span class="nt">&lt;/jta-data-source&gt;</span>
</span><span class='line'>      <span class="nt">&lt;exclude-unlisted-classes&gt;</span>false<span class="nt">&lt;/exclude-unlisted-classes&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/persistence-unit&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/persistence&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The basic idea is that, instead of using <code>@PersistenceContext</code>, we inject our &#8220;own&#8221; multi tenant entity manager wraper.
Then, at runtime, the multi-tenant entity manager loads the persistence context that corresponds to the current user context from JNDI.
Please note that this only works for JTA-based persistence-units. Otherwise, the persistence context is not container-basd and therefore not exposed to JNDI. Moreover, without JTA, we loose container based transaction demarcation.</p>

<p>Let us first start with the client code. In other words, how to use the Multi-Tenant Entity manager.</p>

<h2>Client Code</h2>

<p>Here is the client code. In order to preserve thread-safety and transactionality, Data access objects are EJBs (<code>@Stateless</code>, <code>@Stateful</code>, <code>@Singleton</code>). The presented solution uses an entity manager that is wrapped and then injected using <code>@Inject</code> or <code>@EJB</code>.  Thread-safety, transactionnality and performances are guaranted by the <code>EJB 3.1</code> and <code>JPA 2.0</code> specification as explained in the section <code>Thread-safety and Transactionality</code>. As shown below, the <code>MultiTenancyWrapper</code> delegates to a real entity manager and implements the <code>EntityManager</code> interface. Therefore, its use is very similar to a normal <code>EntityManager</code> injected via <code>@PersistenceContext</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyEJB</span> <span class="kd">implements</span> <span class="n">MyEJBLocal</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Inject</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">MultiTenancyWrapper</span> <span class="n">emWrapper</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@TransactionAttribute</span><span class="o">(</span><span class="n">TransactionAttributeType</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">emWrapper</span><span class="o">.</span><span class="na">findAll</span><span class="o">(...);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The Multi-Tenant EntityManager EJB</h2>

<p>The <code>MultiTenanEntityManagertWrapper</code> simply wraps the entity manager that corresponds to the current user context. The trick is to configure it as an EJB in order to get the xml configuration feature via <code>ejb-jar.xml</code>. Another alternative would be to use the <code>@PersistenceContexts</code> and <code>@PersistenceContext</code> annotations. The main drawback being that, for each new tenant, not only the <code>persistence.xml</code> and <code>ejb-jar.xml</code> must be changed but also the <code>Java</code> code.</p>

<p>The JNDI context that is linked to the current request is injected in the <code>MultiTenantEntityManager</code> using the <code>@Resource</code>annotation.
As there is no creation of a new <code>InitialContext</code> the overhead is not significant. Actually, the <code>@PersistentContext</code> annotation does the exact same thing except that it is not specific to the user context. The <code>MultiTenanEntityManagertWrapper</code> implements the delegate pattern. This allows to use it (almost) transparently in client code.
The main difference being the use of <code>@Inject</code> or <code>@EJB</code> over <code>@PersistenceContext</code> in the client code.</p>

<p>Using the session context that is specific to the caller bean (and thus the caller request/session) enables transparent support for thread-safety, security and transactionality.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ejb</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.persistence.EntityManager</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MultiTenanEntityManagertWrapper</span> <span class="kd">extends</span> <span class="n">EntityManager</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The method <code>getMultiTenantEntityManager</code> of the <code>MultiTenanEntityManagertWrapperImpl</code> extracts the <code>EntityManager</code> that corresponds to the current request from JNDI (we will see later how it has been put there). To that end, the method <code>getMultiTenantEntityManager</code>first extracts the prinipal from the current EJB context (<code>SessionContext</code>). After what, the tenant that corresponds to the current user is used to obtain the JNDI name of the corresponding entity manager. <code>MultiTenanEntityManagertWrapperImpl</code> simple delegates every call to the this Request specific <code>EntityManager</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiTenanEntityManagertWrapperImpl</span> <span class="kd">implements</span> <span class="n">MultiTenanEntityManagertWrapper</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">JNDI_ENV</span> <span class="o">=</span> <span class="s">&quot;java:comp/env/persistence/&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Resource</span>
</span><span class='line'>  <span class="n">SessionContext</span> <span class="n">context</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">private</span> <span class="n">EntityManager</span> <span class="nf">getMultiTenantEntityManager</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">//Extract the name of the current user.</span>
</span><span class='line'>      <span class="n">Principal</span> <span class="n">p</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getCallerPrincipal</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//Lookup the tenant name for the current user</span>
</span><span class='line'>      <span class="c1">//This is application specific</span>
</span><span class='line'>      <span class="n">Users</span> <span class="n">u</span> <span class="o">=</span> <span class="n">Users</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//Produces either TENANT1 or TENANT2       </span>
</span><span class='line'>      <span class="n">String</span> <span class="n">tenantName</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getSite</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">String</span> <span class="n">jndiName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">(</span><span class="n">JNDI_ENV</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">tenantName</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>      <span class="c1">//Lookup the entity manager</span>
</span><span class='line'>      <span class="n">EntityManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">EntityManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">jndiName</span><span class="o">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">manager</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Tenant unknown&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">manager</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//The delegates</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">persist</span><span class="o">(</span><span class="n">Object</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">getMultiTenantEntityManager</span><span class="o">().</span><span class="na">persist</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">merge</span><span class="o">(</span><span class="n">T</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nf">getMultiTenantEntityManager</span><span class="o">().</span><span class="na">merge</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Object</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">getMultiTenantEntityManager</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let us see how to put the entity manager references in JNDI.
In order to avoid a lot of annotations (one per tenant) and therefore to be able to handle a huge number of tenans, I propose to use the <code>ejb-jar.xml</code> file to configure the EJB intead of the <code>PersistenceContext</code> annotation. The <code>MultiTenantEntityWrapper</code>EJB is configured as a stateless EJB. Ther persistence contexts are simply exposed to JNDI with the following pattern: <code>java:comp/env/persistence/TENANTX</code>. For more information please look at the EJB 3.1 specification chapter 16.11.1.</p>

<p><code>&lt;persistence-unit-name&gt;Tenant1&lt;/persistence-unit-name&gt;</code> is the name of the PU as defined in the <code>persistence.xml</code> file. <code>&lt;persistence-context-ref-name&gt;persistence/TENANT1&lt;/persistence-context-ref-name&gt;</code>defines the name of the entity manager that is exposed via JNDI.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;ejb-jar</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="na">xmlns:ejb=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee/ejb-jar_3_0.xsd&quot;</span> <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd&quot;</span> <span class="na">version=</span><span class="s">&quot;3.1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;enterprise-beans&gt;</span>
</span><span class='line'>      <span class="nt">&lt;session&gt;</span>
</span><span class='line'>          <span class="nt">&lt;ejb-name&gt;</span>MultiTenantEntityWrapper<span class="nt">&lt;/ejb-name&gt;</span>   
</span><span class='line'>          <span class="nt">&lt;ejb-class&gt;</span>ejb.MultiTenantWrapperImpl<span class="nt">&lt;/ejb-class&gt;</span>
</span><span class='line'>          <span class="nt">&lt;session-type&gt;</span>Stateless<span class="nt">&lt;/session-type&gt;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c">&lt;!-- Persistece contexts --&gt;</span>
</span><span class='line'>          <span class="nt">&lt;persistence-context-ref&gt;</span>
</span><span class='line'>              <span class="nt">&lt;description&gt;</span>Tenant 1<span class="nt">&lt;/description&gt;</span>             
</span><span class='line'>              <span class="nt">&lt;persistence-context-ref-name&gt;</span>persistence/TENANT1<span class="nt">&lt;/persistence-context-ref-name&gt;</span>        
</span><span class='line'>              <span class="nt">&lt;persistence-unit-name&gt;</span>Tenant1<span class="nt">&lt;/persistence-unit-name&gt;</span>
</span><span class='line'>              <span class="nt">&lt;persistence-context-type&gt;</span>Transaction<span class="nt">&lt;/persistence-context-type&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/persistence-context-ref&gt;</span>
</span><span class='line'>
</span><span class='line'>          <span class="nt">&lt;persistence-context-ref&gt;</span>
</span><span class='line'>              <span class="nt">&lt;description&gt;</span>Tenant 2<span class="nt">&lt;/description&gt;</span>             
</span><span class='line'>              <span class="nt">&lt;persistence-context-ref-name&gt;</span>persistence/TENANT2<span class="nt">&lt;/persistence-context-ref-name&gt;</span>        
</span><span class='line'>              <span class="nt">&lt;persistence-unit-name&gt;</span>Tenant2<span class="nt">&lt;/persistence-unit-name&gt;</span>
</span><span class='line'>              <span class="nt">&lt;persistence-context-type&gt;</span>Transaction<span class="nt">&lt;/persistence-context-type&gt;</span>                
</span><span class='line'>          <span class="nt">&lt;/persistence-context-ref&gt;</span>
</span><span class='line'>          
</span><span class='line'>      <span class="nt">&lt;/session&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/enterprise-beans&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/ejb-jar&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thread-safety and Transactionality</h2>

<p>As this is compliant with both the EJB 3.1 and JPA 2.0 specification, thread-safety and transactionnaly are guaranteed by the container. For more details please look at the EJB 3.1 specification
at chapters 16.10, 16.11 and the JPA 2.0 specification at chapter 7.6. Of course, the wrapper has to be an EJB in order to have access to the current JNDI context without having to create it.
Furthermore, because the <code>EntityManager</code>is not <code>per se</code> thread-safe (JPA 2.0, chapter 7.2), the serialization of the invokations that is provided by the container for EJBs is essential the thread-safety aspect (EJB 3.1, chapter 4.10.13).</p>

<h2>Conclusion</h2>

<p>In this post, I showed how to leverage EJB 3.1 and JPA 2.0 standard features to provide multi-tenancy. The presented approach is thead-safe, it preserves transactionaly and does not induce
a significant overhead.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/10/Sessions-GC-Conversations/">About Sessions, Conversations, and the Garbage Collector</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-10T18:51:00+02:00" pubdate data-updated="true">Jun 10<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/06/10/Sessions-GC-Conversations/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A couple of days ago, I had a discussion with a developer about the notion of web conversation.
More precisely, about its utility. During this discussion, we ran into some basic misconceptions
that, IMHO, no web developer must do. Conversation (or flows) are good features of the recent
frameworks (Spring, JSF) because they allow to save information across several user requests without
putting them into the session. For instance, this can be very useful for wizards. Putting these
information into the session asks for manual maintenance, and in particular for manual collection.
This is usual error prone and should be avoided. The problem being that the user rarely logs out
before closing the browser. Thus, <code>HttpSession.invalidate()</code> does not get a chance to be called
and the session remains active until the timeout occurs (usually 20 minutes later).</p>

<p>The person I was talking with, though that it is not necessary to care about that. In his view,
the garbage collector will take care of this and that it can be forced. We discuss the matter a bit
deeper and here are some myths that I think must be rebutted.</p>

<h2>First assumption: I can force the garbage collection</h2>

<p>This is not true, actually according to the Java documentation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Calling the gc method suggests that the Java Virtual Machine expend effort toward recycling unused objects in order to make the memory they currently occupy available for quick reuse. When control returns from the method call, the Java Virtual Machine has made a best effort to reclaim space from all discarded objects.</span></code></pre></td></tr></table></div></figure>


<p><code>System.gc()</code> <strong>suggests</strong> the garbage collection, it does not enforce it. This signals that you
would like the garbage collector to do its job, but there is no guarantee whatsoever. It is only
possible to enforce garbage collection by writing your own garbage collector, but you cannot expect
all garbage collectors of all the possible VM to act similarly. Therefore, relying on this
assumption is not portable.</p>

<h2>Second assumption: If I close the browser the session and its objects are collected</h2>

<p>Even If it would be possible to enforce the garbage collection, it is of no use as long as there
remains a single reference to the objects to collect. Again, this is absolutely not the case.
Remember that closing the browser does not mean anything to the server. It would, in theory possible
to imagine something with an ajax call that traps the close event of the browser and does a
<code>HttpSession.invalidate()</code> . This is quite complex to do in a cross-browser manner and gives no
guarantee. Therefore, the data attached to the session will be kept in memory until the session
timeout. This is precisely the beauty of conversation scopes, the developer just tells when the
conversation starts and when it ends. Usually, user do not stop in the middle of a conversation,
they tend to finish it. At least, more often that they click on logout.</p>

<h2>Third assumption: Anyway this does not represent a huge amount of memory.</h2>

<p>Let us take a simple example: a standard business application that, at some point in the business
process, requires a tree for shop selection. This kind of interactions requires several client-server
communications and therefore several requests. A temptation would be to put the tree in the session
scope. Let us say that 10,000 (logical) users log into the application, for instance from 09:00 am to 09:30
am. If each session requires 100 KB (trees are huge even with lazy loading), we end up with 1G memory(only for the tree).
As most of the users do not click on logout, you rely on the timeout to free these objects.</p>

<h2>Conclusion</h2>

<p>Using request scope of conversation scope over session scope is a good practice as it frees you
from managing the garbage collection. The code is therefore cleaner and more efficient.
This can be done with JSF&#8217;s <code>@ConversationScoped</code> or with Spring Webflow&#8217;s <code>Conversation</code>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/24/moxy/">Object-XML Mapping With JAXB & MOXy</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-24T19:17:00+02:00" pubdate data-updated="true">May 24<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/24/moxy/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Object-Relational mapping is around for a while and its last incarnation, JPA 2.0, is easy to use
yet powerful and adapted to most of the real-life situations. A problem that is similar to
Object-Relational mapping (ORM) is Object-XML mapping (OXM). More precisely, it aims at mapping XML
schemas to JAVA classes. JAXB (JSR 222) specifies how to maps classes to xml schemas.
In this post, I demonstrate the ease of use of this approach using <a href="http://www.eclipse.org/eclipselink/moxy.php">MOXy</a>. MOXy is the Eclipse implementation of JAXB and I found it really easy to use.</p>

<p>As always let us first look at the Maven dependencies:</p>

<figure class='code'><figcaption><span>Maven dependencies for using MOXy</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;repositories&gt;</span>
</span><span class='line'>        <span class="nt">&lt;repository&gt;</span>
</span><span class='line'>            <span class="nt">&lt;id&gt;</span>EclipseLink Repo<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>            <span class="nt">&lt;name&gt;</span>EclipseLink Repository<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>            <span class="nt">&lt;url&gt;</span>http://download.eclipse.org/rt/eclipselink/maven.repo<span class="nt">&lt;/url&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/repository&gt;</span>
</span><span class='line'><span class="nt">&lt;/repositories&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;dependencies&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>        <span class="nt">&lt;groupId&gt;</span>org.eclipse.persistence<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;artifactId&gt;</span>eclipselink<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>        <span class="nt">&lt;version&gt;</span>2.3.2<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>        <span class="nt">&lt;scope&gt;</span>compile<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'>    ...
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Eclipse-link provides an implementation for JAXB. The rest is in the JEE 6 SDK.</p>

<p>In this post I only consider the case in which we have control over the schema.
In this case, it is sufficient to annotate the fields and the classes you want to marshall to XML.
Let us use the <a href="http://code.google.com/p/jee6-demo/">JEE-6-Demo</a> project that can be found on Google
Code. The following snippet shows a simple model that represents a student.</p>

<p>As you can see there are few annotations. The first one <code>@XmlRootElement</code> simply declares what the  root element is. The second annotation specifies the mapping policy. We will come back on that later. The fields are either not annotated or annotated with @Transient. In the first case, they
are marshaled if not null and in the second they are simply ignored. The only tricky part is that transient fields (in the Java sense) are ignored. For instance, this is the case of the <code>gender</code> property.</p>

<figure class='code'><figcaption><span>A simple mapping from object to XML</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@XmlRootElement</span>
</span><span class='line'><span class="nd">@XmlAccessorType</span><span class="o">(</span><span class="n">XmlAccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Date</span> <span class="n">birthDate</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@XmlTransient</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">PhoneNumber</span> <span class="n">phoneNumber</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">transient</span> <span class="n">Gender</span> <span class="n">gender</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@XmlTransient</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@XmlTransient</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Grade</span><span class="o">&gt;</span> <span class="n">grades</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@XmlTransient</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Badge</span> <span class="n">badge</span><span class="o">;</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let us now test the mapping. The code below, creates a new <code>Student</code> and fills the associated
fields. The second part of the snippet marshals the object into XML and streams it to <code>System.out</code>.</p>

<figure class='code'><figcaption><span>Creation of student and its marshaling to XML</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="s">&quot;Lion Hearth&quot;</span><span class="o">,</span> <span class="s">&quot;Richard&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">());</span>
</span><span class='line'><span class="n">Address</span> <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Address</span><span class="o">();</span>
</span><span class='line'><span class="n">address</span><span class="o">.</span><span class="na">setCity</span><span class="o">(</span><span class="s">&quot;Carouge&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">address</span><span class="o">.</span><span class="na">setNumber</span><span class="o">(</span><span class="s">&quot;7&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">address</span><span class="o">.</span><span class="na">setPostalCode</span><span class="o">(</span><span class="s">&quot;1227&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">address</span><span class="o">.</span><span class="na">setStreet</span><span class="o">(</span><span class="s">&quot;Drize&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">student</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
</span><span class='line'><span class="n">Badge</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Badge</span><span class="o">();</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="na">setSecurityLevel</span><span class="o">(</span><span class="mi">30L</span><span class="o">);</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="na">setStudent</span><span class="o">(</span><span class="n">student</span><span class="o">);</span>
</span><span class='line'><span class="n">student</span><span class="o">.</span><span class="na">setBadge</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'><span class="n">student</span><span class="o">.</span><span class="na">setPhoneNumber</span><span class="o">(</span><span class="k">new</span> <span class="n">PhoneNumber</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">));</span>
</span><span class='line'><span class="k">for</span> <span class="o">(</span><span class="n">Discipline</span> <span class="n">d</span> <span class="o">:</span> <span class="n">Discipline</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Grade</span> <span class="n">g</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Grade</span><span class="o">(</span><span class="n">d</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
</span><span class='line'>    <span class="n">student</span><span class="o">.</span><span class="na">getGrades</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">g</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">JAXBContext</span> <span class="n">jaxbContext</span> <span class="o">=</span> <span class="n">JAXBContext</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="n">Marshaller</span> <span class="n">marshaller</span> <span class="o">=</span> <span class="n">jaxbContext</span><span class="o">.</span><span class="na">createMarshaller</span><span class="o">();</span>
</span><span class='line'><span class="n">marshaller</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">Marshaller</span><span class="o">.</span><span class="na">JAXB_FORMATTED_OUTPUT</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'><span class="n">marshaller</span><span class="o">.</span><span class="na">marshal</span><span class="o">(</span><span class="n">student</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, the result looks like the XML below. As you can see, it is pretty easy and straight-forward
to produce XML from a Class description. Most of the fields that have been populated are not
marshaled to XML. This is due to the <code>@XMLTransient</code> annotation that tells JAXB not to consider
them for output.</p>

<figure class='code'><figcaption><span>Marshaled version of the previous Student object.</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;student&gt;</span>
</span><span class='line'>    <span class="nt">&lt;lastName&gt;</span>Lion Hearth<span class="nt">&lt;/lastName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;firstName&gt;</span>Richard<span class="nt">&lt;/firstName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;birthDate&gt;</span>2012-06-04T11:12:34.751+02:00<span class="nt">&lt;/birthDate&gt;</span>
</span><span class='line'><span class="nt">&lt;/student&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Mapping Overview</h3>

<p>The previous example was as simple as possible. Obviously, sometimes it is important to be able to
tweak the mapping. Let us look at some simple mapping options.</p>

<h4>Element naming</h4>

<p>The default mapping rule is to use the field name as XML element name. This policy can be overridden
by the <code>@XmlElement(name = ...)</code> annotation. Applying the annotation <code>@XmlElement(name="last_name")</code> on the <code>lastName</code> field of the previous example would result in:</p>

<figure class='code'><figcaption><span>Example of named element</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;student&gt;</span>
</span><span class='line'>    <span class="nt">&lt;last_name&gt;</span>Lion Hearth<span class="nt">&lt;/last_name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;firstName&gt;</span>Richard<span class="nt">&lt;/firstName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;birthDate&gt;</span>2012-06-04T11:12:34.751+02:00<span class="nt">&lt;/birthDate&gt;</span>
</span><span class='line'><span class="nt">&lt;/student&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Attributes vs elements</h4>

<p>By default fields are marshaled as XML elements. It is possible to ask JAXB to transform them to
XML attributes by using <code>@XmlAttribute</code> annotation. Putting <code>@XmlAttribute</code> on the <code>lastName</code>
field of the previous example would produce the following XML:</p>

<figure class='code'><figcaption><span>Example of using an attribute instead of an element</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;student</span> <span class="na">lastName=</span><span class="s">&quot;Lion Hearth&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;firstName&gt;</span>Richard<span class="nt">&lt;/firstName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;birthDate&gt;</span>2012-06-04T11:12:34.751+02:00<span class="nt">&lt;/birthDate&gt;</span>
</span><span class='line'><span class="nt">&lt;/student&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note that as for an element, the attribute name can be customized.</p>

<h4>Mapping strategy</h4>

<p>As mentioned before, the default mapping strategy is declared by using the <code>@XmlAccessorType(XmlAccessType.*)</code> annotation.</p>

<p>There exists four mapping policies. For more details, look at the <a href="http://docs.oracle.com/javaee/6/api/javax/xml/bind/annotation/XmlAccessType.html">Javadoc</a> for <code>XmlAccessorType</code>. Here is an excerpt
from the Java doc.</p>

<ol>
<li><code>FIELD</code>: Every non static, non transient field in a JAXB-bound class will be automatically bound to XML, unless annotated by XmlTransient.</li>
<li><code>NONE</code>: None of the fields or properties is bound to XML unless they are specifically annotated with some of the JAXB annotations.</li>
<li><code>PROPERTY</code>: Every getter/setter pair in a JAXB-bound class will be automatically bound to XML, unless annotated by XmlTransient.</li>
<li><code>PUBLIC_MEMBER</code>: Every public getter/setter pair and every public field will be automatically bound to XML, unless annotated by XmlTransient.</li>
</ol>


<h4>Name spaces</h4>

<p>An important aspect of XML is its modularity. In particular, namespaces bring a nice way to organize
the XML and the schemas. Namespaces can be specified at different levels. For more details look at the <a href="http://wiki.eclipse.org/EclipseLink/UserGuide/MOXy/Type_Level/Setting_Up_Namespace_Information">MOXy documentation</a>. For now, it is sufficient to known that the <code>@XmlType</code>, <code>@XmlElement</code>, and <code>@XmlAttribute</code> annotations support a namespace attribute.</p>

<h3>One to one mapping</h3>

<p>Now that we have mapped simple field, let us look at more complex mappings. First, a 1-1 mapping.
The following example maps an address.</p>

<figure class='code'><figcaption><span>Add a one to one mapping</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@XmlRootElement</span>
</span><span class='line'><span class="nd">@XmlAccessorType</span><span class="o">(</span><span class="n">XmlAccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Address</span> <span class="n">address</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To that end, it is sufficient to add the following annotations to the Address type.</p>

<figure class='code'><figcaption><span>Add a one to one mapping</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@XmlRootElement</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;address&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@XmlAccessorType</span><span class="o">(</span><span class="n">XmlAccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Address</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="cm">/** house number. */</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">number</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** the name of the street. */</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">street</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** the city name. */</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">city</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** the postal code. */</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">postalCode</span><span class="o">;</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the rest is handled by JAXB to produce the following result.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;student&gt;</span>
</span><span class='line'>    ...
</span><span class='line'>    <span class="nt">&lt;address&gt;</span>
</span><span class='line'>        <span class="nt">&lt;number&gt;</span>7<span class="nt">&lt;/number&gt;</span>
</span><span class='line'>        <span class="nt">&lt;street&gt;</span>Drize<span class="nt">&lt;/street&gt;</span>
</span><span class='line'>        <span class="nt">&lt;city&gt;</span>Carouge<span class="nt">&lt;/city&gt;</span>
</span><span class='line'>        <span class="nt">&lt;postalCode&gt;</span>1227<span class="nt">&lt;/postalCode&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/address&gt;</span>
</span><span class='line'><span class="nt">&lt;/student&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Bi-directional one to one</h4>

<p>The next example is more tricky. The problem with bi-directional mapping is that they produce
graphs. Of course, since XML are trees, we must avoid cycles. The solution is to annotate the reverse mapping (<code>Student student</code> in this case) with <code>@XMLTransient</code> causing the property to be ignored by JAXB.</p>

<figure class='code'><figcaption><span>Add a one to one bidirectional mapping</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@XmlRootElement</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;student&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@XmlAccessorType</span><span class="o">(</span><span class="n">XmlAccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Badge</span> <span class="n">badge</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following type describes the <code>Badge</code> that has a reverse mapping to <code>Student</code>.</p>

<figure class='code'><figcaption><span>Mapping of the type &#8220;Badge&#8220;</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@XmlRootElement</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;badge&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@XmlAccessorType</span><span class="o">(</span><span class="n">XmlAccessType</span><span class="o">.</span><span class="na">FIELD</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Badge</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** The unique id. */</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** The student&#39;s security level. */</span>
</span><span class='line'>    <span class="nd">@XmlAttribute</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Long</span> <span class="n">securityLevel</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/** The student that owns this badge. */</span>
</span><span class='line'>    <span class="nd">@XmlTransient</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Student</span> <span class="n">student</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, here is the result.</p>

<figure class='code'><figcaption><span>Result of the bi-directional mapping</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;student&gt;</span>
</span><span class='line'>    ...
</span><span class='line'>    <span class="nt">&lt;badge</span> <span class="na">securityLevel=</span><span class="s">&quot;30&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/student&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>One to many mapping</h3>

<p>One to many mappings are handled automatically. There is nothing special to do. In our example,
removing the <code>@XmlTransient</code> annotation on the <code>grades</code> property will generate the following output:</p>

<figure class='code'><figcaption><span>One to many example</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;student&gt;</span>
</span><span class='line'>    <span class="nt">&lt;last_name&gt;</span>Lion Hearth<span class="nt">&lt;/last_name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;firstName&gt;</span>Richard<span class="nt">&lt;/firstName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;birthDate&gt;</span>2012-06-05T10:57:36.699+02:00<span class="nt">&lt;/birthDate&gt;</span>
</span><span class='line'>    <span class="nt">&lt;phoneNumber&gt;</span>+00-0000-0000<span class="nt">&lt;/phoneNumber&gt;</span>
</span><span class='line'>    <span class="nt">&lt;address&gt;</span>
</span><span class='line'>        <span class="nt">&lt;number&gt;</span>7<span class="nt">&lt;number&gt;</span>
</span><span class='line'>        <span class="nt">&lt;street&gt;</span>Drize<span class="nt">&lt;/street&gt;</span>
</span><span class='line'>        <span class="nt">&lt;city&gt;</span>Carouge<span class="nt">&lt;/city&gt;</span>
</span><span class='line'>        <span class="nt">&lt;postalCode&gt;</span>1227<span class="nt">&lt;/postalCode&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/address&gt;</span>
</span><span class='line'>    <span class="nt">&lt;grades&gt;</span>
</span><span class='line'>        <span class="nt">&lt;discipline&gt;</span>MATHEMATICS<span class="nt">&lt;/discipline&gt;</span>
</span><span class='line'>        <span class="nt">&lt;grade&gt;</span>10<span class="nt">&lt;/grade&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/grades&gt;</span>
</span><span class='line'>    <span class="nt">&lt;grades&gt;</span>
</span><span class='line'>        <span class="nt">&lt;discipline&gt;</span>BIOLOGY<span class="nt">&lt;/discipline&gt;</span>
</span><span class='line'>        <span class="nt">&lt;grade&gt;</span>10<span class="nt">&lt;/grade&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/grades&gt;</span>
</span><span class='line'> ...
</span><span class='line'>    <span class="nt">&lt;badge</span> <span class="na">securityLevel=</span><span class="s">&quot;30&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/student&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Custom mapping</h2>

<p>Sometimes, it is difficult to map a given type to a given XML structure. This is the case of the <code>PhoneNumber</code> type in our example. To that end, it is possible to define a <code>XMLJavaTypeAdatper</code>
that will convert XML to object and objects to XML manually. The adapter is not very difficult to implement. It is composed of two methods that respectively unmarshal from XML and marshal to XML.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PhoneNumberAdapter</span> <span class="kd">extends</span> <span class="n">XmlAdapter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">PhoneNumber</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">PhoneNumber</span> <span class="nf">unmarshal</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">PhoneNumber</span><span class="o">.</span><span class="na">getAsObject</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">value</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">marshal</span><span class="o">(</span><span class="kd">final</span> <span class="n">PhoneNumber</span> <span class="n">value</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">PhoneNumber</span><span class="o">.</span><span class="na">getAsString</span><span class="o">((</span><span class="n">PhoneNumber</span><span class="o">)</span> <span class="n">value</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, it is required to annotated the property with this adapter:</p>

<figure class='code'><figcaption><span>Using a custom XML-Object Adapter</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="nd">@XmlJavaTypeAdapter</span><span class="o">(</span><span class="n">PhoneNumberAdapter</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">private</span> <span class="n">PhoneNumber</span> <span class="n">mPhoneNumber</span><span class="o">;</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will produce the following result:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;student&gt;</span>
</span><span class='line'>    <span class="nt">&lt;last_name&gt;</span>Lion Hearth<span class="nt">&lt;/last_name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;firstName&gt;</span>Richard<span class="nt">&lt;/firstName&gt;</span>
</span><span class='line'>    <span class="nt">&lt;birthDate&gt;</span>2012-06-05T10:57:36.699+02:00<span class="nt">&lt;/birthDate&gt;</span>
</span><span class='line'>    <span class="nt">&lt;phoneNumber&gt;</span>+00-0000-0000<span class="nt">&lt;/phoneNumber&gt;</span>
</span><span class='line'>    ...
</span><span class='line'><span class="nt">&lt;/student&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>What about XML schemas</h2>

<p>As mentioned previously, we assumed that you have total control over the schema. Nevertheless, it can
be useful to be able to produce this schema. This is done by the following snippet.</p>

<figure class='code'><figcaption><span>Output the underlying schema</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">SchemaOutputResolver</span> <span class="n">sor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SchemaOutputResolver</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Result</span> <span class="nf">createOutput</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">namespaceUri</span><span class="o">,</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">String</span> <span class="n">suggestedFileName</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Result</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamResult</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
</span><span class='line'>        <span class="n">result</span><span class="o">.</span><span class="na">setSystemId</span><span class="o">(</span><span class="s">&quot;System.out&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'><span class="n">jaxbContext</span><span class="o">.</span><span class="na">generateSchema</span><span class="o">(</span><span class="n">sor</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<h2>Write XML</h2>

<p>Writing XML is fairly easy, just populate the objects that you want to marshal and then
use the following code:</p>

<figure class='code'><figcaption><span>How to marshal a given object</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">JAXBContext</span> <span class="n">jaxbContext</span> <span class="o">=</span> <span class="n">JAXBContext</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="n">Marshaller</span> <span class="n">marshaller</span> <span class="o">=</span> <span class="n">jaxbContext</span><span class="o">.</span><span class="na">createMarshaller</span><span class="o">();</span>
</span><span class='line'><span class="n">marshaller</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">Marshaller</span><span class="o">.</span><span class="na">JAXB_FORMATTED_OUTPUT</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'><span class="n">marshaller</span><span class="o">.</span><span class="na">marshal</span><span class="o">(</span><span class="n">student</span><span class="o">,</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Read XML</h2>

<p>The reverse operation is as easy and straightforward (provided that use the same schema):</p>

<figure class='code'><figcaption><span>How to unmarshal a given XML file to objects</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">InputStream</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">StudentOXTest</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&quot;/student.xml&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">JAXBContext</span> <span class="n">jaxbContext</span> <span class="o">=</span> <span class="n">JAXBContext</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'><span class="n">Unmarshaller</span> <span class="n">unmarshaller</span> <span class="o">=</span> <span class="n">jaxbContext</span><span class="o">.</span><span class="na">createUnmarshaller</span><span class="o">();</span>
</span><span class='line'><span class="n">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="o">(</span><span class="n">Student</span><span class="o">)</span> <span class="n">unmarshaller</span><span class="o">.</span><span class="na">unmarshal</span><span class="o">(</span><span class="n">stream</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>We have seen how to use MOXy to map objects to XML. Using JAXB annotations, it is very easy to read and write XML. The examples used in this blog are to be found in the <a href="http://code.google.com/p/jee6-demo/">JEE-6-Demo</a> project on <a href="http://code.google.com">Google code hosting</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/18/verification-validation-and-all-that/">Verification & Validation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-18T10:51:00+02:00" pubdate data-updated="true">May 18<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/18/verification-validation-and-all-that/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&#8217;ve read many articles (tutorials, books, courses, forums&#8230;) about
Verification &amp; Validation. One think that really strikes me is the lack of consistency and the
fuzziness among the definitions or more precisely among the interpretations. As I do think that
something cannot be understood completely if it is not be expressed clearly, I propose a mini-serie of blog posts to clarify Verification &amp; Validation and the associated
activities. I will try to give simple and consistent (at least in my point of view) definitions. Sure, this is a rehash of well-known stuff but putting everything at the same place seems worth to me. I do not pretend to know best and thus feel free to comment on this post to correct me or to suggest other explanations and definitions. My only purpose is to help to better understand these words and the underlying concepts.</p>

<h2>Verification &amp; Validation</h2>

<p>Most of the literature on the subject distinguish between <strong>Verification</strong> and <strong>Validation</strong>. The
usual way (taken from Barry Boehm) to sum up the difference between the two is to say that:</p>

<p><code>Verification  consist in checking that we are building the product right, and validation
 consists in checking building the right product.</code></p>

<p>I am not very satisfied with this definition. Although it sounds good, it raises the question of
what it does mean to built a product right and what the right product is. Let&#8217;s go back to the roots
by looking at the definitions of these words in the <a href="http://www.merriam-webster.com/">Merriam-Webster</a> dictionary.</p>

<!---
###Oxford dictionary
**Verification**: the process of establishing the truth, accuracy, or validity of something.  
**Validation**: check or prove the validity or accuracy of something.

###Cambridge dictionary
**Verification**: to prove that something exists or is true, or to make certain that something is correct.  
**Validation**: to make something officially acceptable or approved, especially after examining it.
-->


<p><strong>Verification</strong>: the act or process of &#8220;establishing the truth, accuracy, or reality of a claim&#8221;.<br/>
<strong>Validation</strong>: the act or process of &#8220;making legally valid&#8221;.</p>

<!--- All three dictionaries agree (as far as I understand it) on the definition of verification.
The 
[Oxford] (http://oxforddictionaries.com/) dictionary does not really distinguish the two words.

[Cambridge] (http://dictionary.cambridge.org/) and [Merriam-Webster]
(http://www.merriam-webster.com/), on the other hand, describe **validation** as the act of making
something legal or official. As French is my mother tongue and both **verification** and **validation**
come from the middle French, I checked the definitions in a French dictionary ([Larousse](http://www.larousse.com/en/dictionaries/french/)).
The Larousse's definition also makes a clear distinction that is along the same lines as the Cambridge 
and the Merriam-Webster dictionary. 
-->


<p>To summarize, my understanding is that the general sense of <strong>verification</strong> is to prove a claim
whereas <strong>validation</strong> aims at declaring something legal or official (i.e. something that comply to a
set of rules or regulations). Of course this raises the question of what, in the context of software
systems, is a claim and what is legal/official. This leads us to the next section that defines terms
such as requirements, and specification.</p>

<h2>Requirements &amp; Specification</h2>

<!---
###Oxford dictionary
**Requirement**:   
**Specification**: 

###Cambridge dictionary
**Requirement**:   
**Specification**: 
-->


<p>Again, let&#8217;s lookup the meaning of these words in the <a href="http://www.merriam-webster.com/">Merriam-Webster</a> dictionary:</p>

<p><strong>Requirement</strong>: the need for a particular purpose; depend on for success or survival.<br/>
<strong>Specification</strong>: the act of describing or identifying something precisely or of stating a precise requirement.</p>

<p>A requirement expresses a need upon which the success of the project depends. Whereas, a
specification is a precise description of a requirement. Now let us look at the standard definitions
in Software Engineering.</p>

<h2>Software Requirements &amp; Specification</h2>

<p>As a software systems is usually developed in response to someone needs (or supposed needs), it
must satisfy that person, that group of person, or that organization needs. Furthermore, it must
often comply to a set of regulations or other expectations. This leads us to the following concept:</p>

<p><strong>Requirements</strong>  represent what the stakeholders expect from the system. It is important to note
   that the stakeholders can be end-users, power-users or even internal or external regulatory
   entities such as government agencies that enforce laws and regulations. Stakeholder requirements
   do not take the feasibility into account nor do they take technical details into account. They
   only state their problem or expectations.</p>

<p>As it is not possible to have access to all stakeholders at any time during the development process
(for instance, to ask questions), it is necessary to capture their requirements in a persistent form.
In the following, I call the role that capture the stakeholder requirements: the business analyst.</p>

<p><strong>Specifications</strong>  capture in a written form what a business analyst understood from the
 requirements. This written form is usually expressed in natural language or is a mixed of natural
 language and semi-formal, or formal description. The specifications describe implementable requirements and how to meet them. Therefore, they propose a solution to the problem.</p>

<p>Interestingly enough, there is the same kind of semantical difference between <strong>requirements</strong> and <strong>specifications</strong>
as between <strong>verification</strong> and <strong>validation</strong>. This is the basis that helps to understand the subtle
yet important difference between the two terms, in particular in the context of the development of
software systems.</p>

<p> It is important to understand is that the specifications are derived from the interpreted <strong>requirements</strong>
 and therefore <strong>specifications</strong> cannot be sound and complete. In other words, there may be things
 that are over-specified (not sound) and things that are under-specified (not complete).</p>

<p>Let&#8217;s imagine for a second that a perfect business analyst did capture exactly what the
stakeholders had in mind. This perfect specification must still be implemented and therefore we must
ensure that implementation does satisfy the specification (and by transitivity the stakeholders
needs).</p>

<p>A software system does reflect the stakeholder requirements if the following hypotheses hold:</p>

<ol>
<li>All stakeholders expresses their needs in a sound and complete set of requirements;</li>
<li>a business analyst captures these requirements in a sound and complete specification (with respect to the requirements);</li>
<li>the development team understands and implements this specification in a sound and complete way;</li>
</ol>


<p>Of course non of these hypotheses hold in a real industrial setting but we have to admit them to be
able to realize a system. In order to minimize the risk of diverging from the stakeholders
requirements to much we need a process to ensure that the final system agrees to a certain degree to
the stakeholders requirements. This a the role of verification and validation.</p>

<h2>Software Verification &amp; Validation</h2>

<p>The figure below illustrates the difference between <strong>verification</strong> and <strong>validation</strong> and where
they take place in the development process. Building a software system consists in capturing the
stakeholders&#8217; requirements into a persistent description, called <strong>informal specifications</strong> (e.g.,
Use Cases, storyboards, &#8230;). This specifies <strong>what</strong> problems the system addresses. At this stage a
number of interpretation mistakes may have occurred leading to incorrect specifications. To limit
these problems, the <strong>informal specifications</strong> must be explained to the user and validated.
Developers require non-ambiguous specification to work on. Thus, a design (e.g., UML diagrams) are
derived from the <strong>informal specifications</strong> . Similarly, the quality assurance team derives a <strong>formal
specification</strong> (e.g, Petri nets, test cases, metrics, &#8230;). The design and later the implementation
are then verified with respect to this <strong>formal specification</strong>. To a certain extend, the formal specification
must itself be validated by the stakeholders.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/V&V.png' width='' height='' alt='Verification and Validation' title='Verification and Validation'><span class='caption-text'>Verification and Validation</span></span></p>

<p><strong>Verification</strong>    stands for the process of evaluating whether a software system satisfies the <strong>specified
requirements</strong>. On the design level, it can be achieved by simulation or model checking. On the implementation
   level, it can be achieved by different kind of testing, code review, static analysis, and
   metrics. In other words: &#8220;Did we build the system right (with respect to specified
   requirements)?&#8221;.</p>

<p><strong>Validation</strong>    stands for the process of evaluating whether a software system satisfies the <strong>stakeholder requirements</strong>
   and <strong>intended uses</strong> . This is, for instance, achieved by <strong>User Acceptance Tests</strong> and by
   submitting the final system to certification authorities. In other words: &#8220;Did we build the right
   (with respect to stakeholder requirements) system?&#8221;.</p>

<!---
Validation is necessary because there will always be a gap (or discrepancy) between what the customer wants, and what has been captured and expressed in the requirements. There is inevitably some loss, or corruption, of information in its transmission between the customer and the analyst/developer.
The essential point is that the customer or user must be directly involved in validation.
--->


<h2>Conclusion</h2>

<p>Stakeholders cannot be available at any time of the development. Therefore, it is necessary to
build a persistent view (i.e., specification) of their needs (i.e., requirements). The activity of
checking whether the design and the implementation fulfill the specification is called
<strong>Verification</strong>
Some details may be lost in the translation from the requirements to the specification. Therefore,
at each phase of the development of a software systems, we must check that what has been specified
and later implemented during that phase reflect the stakeholders&#8217; expectations. This activity is
called <strong>validation</strong> . Integrating these two concepts as first class citizen, is one of the major
benefits of agile methods. Because the interpretation of the <strong>stakeholder requirements</strong> and later
the translation from the <strong>informal specifications</strong> to the <strong>formal specifications</strong> may be
incomplete or incorrect, it is necessary to often go back to the customer or the stakeholders to
confirm that the product is on the good track. This is one of the major benefits of iterative and
incremental development.</p>

<!---
The [Food and Drug Administration]() 

**Software verification**  provides objective evidence that the design outputs of a particular phase
 of the software development life cycle meet all of the specified requirements for that phase.
 Software verification looks for consistency, completeness, and correctness of the software and its
 supporting documentation, as it is being developed, and provides support for a subsequent
 conclusion that software is validated. Software testing is one of many verification activities
 intended to confirm that software development output meets its input requirements. Other
 verification activities include various static and dynamic analyses, code and document inspections,
 walkthroughs, and other techniques.

**Software validation**  is a part of the design validation for a finished device, but is not
 separately defined in the Quality System regulation. For purposes of this guidance, FDA considers
 software validation to be ``confirmation by examination and provision of objective evidence that
 software specifications conform to user needs and intended uses, and that the particular
 requirements implemented through software can be consistently fulfilled.'' In practice, software
 validation activities may occur both during, as well as at the end of the software development life
 cycle to ensure that all requirements have been fulfilled. Since software is usually part of a
 larger hardware system, the validation of software typically includes evidence that all software
 requirements have been implemented correctly and completely and are traceable to system
 requirements. A conclusion that software is validated is highly dependent upon comprehensive
 software testing, inspections, analyses, and other verification tasks performed at each stage of
 the software development life cycle. Testing of device software functionality in a simulated use
 environment, and user site testing are typically included as components of an overall design
 validation program for a software automated device.

IEEE-829-2008 3.1.53 validation: (A) The process of evaluating a system or component during or at
the end of the development process to determine whether it satisfies specified requirements.
(adopted from IEEE Std 610.12-1990 [B3] ) (B) The process of providing evidence that the software and
its associated products satisfy system requirements allocated to software at the end of each life
cycle activity, solve the right problem (e.g., correctly model physical laws, implement business
rules, or use the proper system assumptions), and satisfy intended use and user needs.

3.1.54 verification: (A) The process of evaluating a system or component to determine whether the
products of a given development phase satisfy the conditions imposed at the start of that phase.
(adopted from IEEE Std 610.12-1990 [B3] ) (B) The process of providing objective evidence that the
software and its associated products comply with requirements (e.g., for correctness, completeness,
consistency, and accuracy) for all life cycle activities during each life cycle process
(acquisition, supply, development, operation, and maintenance), satisfy standards, practices, and
conventions during life cycle processes, and successfully complete each life cycle activity and
satisfy all the criteria for initiating succeeding life cycle activities (e.g., building the
software correctly).


1. [IEEE-829-2008]()
2. [ISTQB foundation]() and [advanced]() syllabus
3. [ISO 9000:2000]()
4. [ISO 8402:1994]()
5. [ISO/IEC 14971-1 and IEC 60601-1-4]() 
6. [General Principles of Software Validation; Final Guidance for Industry and FDA Staff]()
-->

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/02/a-jee6-security-interceptor-for-tomcat-7/">A JEE6 Security Interceptor for Tomcat 7</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-02T18:23:00+02:00" pubdate data-updated="true">May 2<span>nd</span>, 2012</time>
        
         | <a href="/blog/2012/05/02/a-jee6-security-interceptor-for-tomcat-7/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Security in Java EE is a well-known subject and JAAS, the framework that manages security, is
stable and reliable. Nevertheless, its API is quite low level and not always very convenient. For
that reason, there exist a number of frameworks that have been built on top of JAAS that provide
nice abstractions and convenient tools. This is especially true for the JEE application servers such as <a href="http://glassfish.java.net/">Glassfish</a>, <a href="http://www.jboss.org/">JBoss</a> and the like.</p>

<p>In servlet containers such as <a href="http://tomcat.apache.org/">Tomcat</a> or <a href="http://jetty.codehaus.org/jetty/">Jetty</a> however, only the web components are secured and it is not trivial to secure services and the data access layer. This can be solved by integrating framework such as <a href="http://static.springsource.org/spring-security/site/">Spring Security</a>, <a href="http://shiro.apache.org/">Apache Shiro</a>.</p>

<p>As always it is not always possible to put a new framework or library in place. I will not
discuss whether it is a good or a bad idea to develop a new security mechanism. Nevertheless, a good
rule of thumb is to reuse existing components and not reinvent the wheel &#8230; when possible. If for
let&#8217;s say licensing reasons, it is not possible: here is a way to provide a simple declarative
authorisation procedure based on JAAS and the JEE6 interceptors. The objective is to propagate the
authorisation to non-web layers such as services or data access layer through a thread-local
variable.</p>

<p>The goal is to be able to write something similar to the following snippet. The idea is to annotate
a method (or a class) with a list of roles that are authorised. If the method executes in a context
in which a user has not enough rights, it raises an exception.</p>

<figure class='code'><figcaption><span>Example of a service layer protected by JEE6 interceptor</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Secure</span><span class="o">(</span><span class="n">roles</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;user&quot;</span> <span class="o">})</span>
</span><span class='line'><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="nf">getAll</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span><span class="err"></span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Secure</span><span class="o">(</span><span class="n">roles</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;admin&quot;</span> <span class="o">})</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">add</span><span class="o">(</span><span class="kd">final</span> <span class="n">Student</span> <span class="n">student</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Java Authentication and Authorisation System</h3>

<p>Java Authentication and Authorisation System (JAAS) provides a security infrastructure for JAVA.
Both <strong>authentication</strong> (are you who you pretend to be?) and <strong>authorisation</strong> (are you allowed to do something you would like to do?) are covered. JAAS relies on the concept of principal.
A principal is a particular identity of a user (e.g. social security id, driver licence id, &#8230;).
By default, in JAVA SE, there is no easy way to have the list of roles granted to a given user.
To solve that problem, we need a bean that knows to which role a given Principal is authorised.
This is the role of <code>MyPrincipal</code>.</p>

<figure class='code'><figcaption><span>A custom principal that contains the roles</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyPrincipal</span> <span class="kd">implements</span> <span class="n">Principal</span><span class="o">,</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">MyPrincipal</span><span class="o">(</span><span class="kd">final</span> <span class="n">Principal</span> <span class="n">pPrincipal</span><span class="o">,</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">pRoles</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">principal</span> <span class="o">=</span> <span class="n">pPrincipal</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">roles</span> <span class="o">=</span> <span class="n">pRoles</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isUserInRole</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">pRole</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">roles</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">pRole</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>JEE6 Interceptors</h3>

<p>Since JEE6, a feature called interceptors enables simple
<a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">Aspect Oriented Programming</a> without
using any specific framework. It works, of course, only on managed classes. Namely, classes that are instantiated by <a href="http://docs.oracle.com/javaee/6/tutorial/doc/giwhb.html">CDI</a> through dependency injection.</p>

<p>Just to fix the vocabulary, here some definition about Aspect Oriented Programming:</p>

<ul>
<li>Advice: code at it executed at a certain point in the code. This point is called a join point;</li>
<li>Join point: place in the code at which a given advice is executed.;</li>
<li>Pointcut: set of join point, usually described by a meta data that can be internal or external to the program (xml, annotations);</li>
<li>Aspect: advice + its pointcut;</li>
</ul>


<p>In Java EE6, an interceptor is made of an annotation that characterizes an aspect and an
implementation for that annotation. The annotation is placed at a join point, that is a place in the code where a specific advice must be executed. Usually around a method call. However, JEE6
interceptors are not as powerful as advanced AOP frameworks such as AspectJ, it provides enough
facility to decouple non-functional behaviors from the business code. That is exactly what we want
to achieve here. Let us now illustrate JEE6 interceptors through the implementation of a declarative security annotation that protects calls to the service layer.</p>

<h4>A meta data that asks for security</h4>

<p>The first thing is to declare an annotation that is parametrized by an array of <code>String</code> that
represents roles. This is presented in the following snippet. The annotation <code>InterceptorBinding</code>
is required to mark the annotation as a pointcut. The <code>@Retention(RetentionPolicy.RUNTIME)</code>
declares that Then <code>@Target({ ElementType.METHOD, ElementType.TYPE })</code> tells that the annotation
can be applied at both method level and type level. Finally, the member <code>String[] roles();</code>
declares that the annotation has a parameter called <code>roles</code>.</p>

<figure class='code'><figcaption><span>Secure.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@InterceptorBinding</span>
</span><span class='line'><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span><span class='line'><span class="nd">@Target</span><span class="o">({</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">,</span> <span class="n">ElementType</span><span class="o">.</span><span class="na">TYPE</span> <span class="o">})</span>
</span><span class='line'><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">Secure</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Nonbinding</span>
</span><span class='line'>    <span class="n">String</span><span class="o">[]</span> <span class="nf">roles</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>The interceptor (advice) that check the authorisation</h4>

<p>The next step is to program an advice. To that end, a
simple class must be annotated by the annotation <code>@Interceptor</code> and by the annotation that it
implements <code>@Secure(roles = { })</code> (i.e. the pointcut). The method that is annotated by
<code>@AroundInvoke</code> is executed by the container when it encounters a method annotated by <code>@Secure</code>
(i.e. join point). The name of the method (e.g. <code>invoke</code> ) does not matter as long as it returns an
<code>Object</code> and it accepts an <code>InvocationContext</code> as a parameter. This context contains information
about the intercepted method.</p>

<p>About the method itself, <code>getRoles</code> is a private method (given hereafter) that extract the list
of roles that are authorised to this method. The <code>SecurityContext</code> is described below and is
container for the <code>ThreadLocal</code> variable that contains the principal of the current user. The
method <code>principal.isUserInRoles(roles)</code> returns true if one the roles matches the expected
authorisation. If it is not the case an exception is raised and the interceptor stops there without
having executed the intercepted method. Otherwise, the interceptor goes on and executes the
intercepted method and finally returns its return value by executing <code>return context.proceed()</code> .</p>

<figure class='code'><figcaption><span>SecurityInterceptor.java CDI Interceptor</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Secure</span><span class="o">(</span><span class="n">roles</span> <span class="o">=</span> <span class="o">{</span> <span class="o">})</span>
</span><span class='line'><span class="nd">@Interceptor</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityInterceptor</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span><span class="err"></span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@AroundInvoke</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="kd">final</span> <span class="n">InvocationContext</span> <span class="n">context</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span><span class="o">[]</span> <span class="n">roles</span> <span class="o">=</span> <span class="n">getRoles</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getMethod</span><span class="o">());</span>
</span><span class='line'>        <span class="n">MyPrincipal</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">SecurityContext</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">principal</span><span class="o">.</span><span class="na">isUserInRoles</span><span class="o">(</span><span class="n">roles</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalAccessException</span><span class="o">(</span><span class="s">&quot;Current user not autorised!&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">getRoles</span><span class="o">(</span><span class="kd">final</span> <span class="n">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The private method getRoles scans the class of the method that has been intercepted in order to
discover the list of roles. First it scans at method level (<code>method.isAnnotationPresent</code> ) to
find the annotation <code>Secure.class</code> that has been described above. If it does not find the proper
annotation then it scans at class level (<code>method.getDeclaringClass().isAnnotationPresent</code> ).
Remember that we allow to put the annotation at the method level AND at the class level.</p>

<figure class='code'><figcaption><span>Method that scans the caller for annotation parameters</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">getRoles</span><span class="o">(</span><span class="kd">final</span> <span class="n">Method</span> <span class="n">method</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="n">Secure</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Secure</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">roles</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span><span class="err"></span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">isAnnotationPresent</span><span class="o">(</span><span class="n">Secure</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">method</span><span class="o">.</span><span class="na">getDeclaringClass</span><span class="o">().</span><span class="na">getAnnotation</span><span class="o">(</span><span class="n">Secure</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">roles</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>The last step to activate the interceptor is to declare it in the <code>beans.xml</code> file. Remember that it works
thanks to CDI and only for the beans managed by CDI. By default, interceptors are disabled.</p>

<figure class='code'><figcaption><span>beans.xml CDI descriptor</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>    <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://jboss.org/schema/cdi/beans_1_0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;interceptors&gt;</span>
</span><span class='line'>        <span class="nt">&lt;class&gt;</span>ch.demo.business.interceptors.SecurityInterceptor<span class="nt">&lt;/class&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/interceptors&gt;</span>
</span><span class='line'><span class="nt">&lt;/beans&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>How to populate the ThreadLocal variable with principal information</h4>

<p>So far, we did intercept the method call and check whether the current principal associated with
the thread is authorised to access to a the intercepted method. The problem is that in servlet
containers the security is at web level and we would to propagate this information. To that end, we
will use the concept of <a href="http://en.wikipedia.org/wiki/Thread-local_storage">thread local</a>
variables.</p>

<p>The following class contains a thread-local variable <code>principalHolder</code> that holds the current
(thread-local) principal. This assumes that a thread is processed by one and only one thread from A
to Z. This is the case for servlet engines but not always for application servers. In the latter
case, the vendor-specific security mechanism is much better as it takes things such as clustering
into account. The method <code>setPrincipal</code> is invoked at the beginning of a new request when it is
authenticated and authorised at the web level. <code>removePrincipal</code> cleans up the Thread-Local value
at the end of the request processing.</p>

<figure class='code'><figcaption><span>SecurityContext.java Thread-local container for the principal</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">SecurityContext</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span><span class="err"></span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">InheritableThreadLocal</span><span class="o">&lt;</span><span class="n">MyPrincipal</span><span class="o">&gt;</span> <span class="n">principalHolder</span> <span class="o">=</span>
</span><span class='line'>                <span class="k">new</span> <span class="n">InheritableThreadLocal</span><span class="o">&lt;</span><span class="n">MyPrincipal</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">SecurityContext</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MyPrincipal</span> <span class="nf">getPrincipal</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">principalHolder</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">principalHolder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="n">MyPrincipal</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">(</span><span class="n">MyPrincipal</span><span class="o">)</span> <span class="n">principalHolder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">setPrincipal</span><span class="o">(</span><span class="kd">final</span> <span class="n">MyPrincipal</span> <span class="n">principal</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">principalHolder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">principal</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">removePrincipal</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">principalHolder</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last step is to populate the principal and its associated roles to the thread-local container
when the request is initialized. For that purpose, we use a request listener that is invoked when a new
request has been submit and just before its destruction. On initialization, the method
<code>getMyPrincipal</code> extracts the principal from the request <code>request.getUserPrincipal()</code>. The
resulting principal is put in the thread-local by <code>SecurityContext.setPrincipal</code>.</p>

<p><code>getMyPrincipal</code> also goes through the list of roles and adds the authorised roles using <code>request.isUserInRole</code> from <code>HttpServletRequest</code>.</p>

<figure class='code'><figcaption><span>SecurityListener.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecurityListener</span> <span class="kd">implements</span> <span class="n">ServletRequestListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">roles</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">requestInitialized</span><span class="o">(</span><span class="kd">final</span> <span class="n">ServletRequestEvent</span> <span class="n">sre</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">SecurityContext</span><span class="o">.</span><span class="na">setPrincipal</span><span class="o">(</span><span class="n">getMyPrincipal</span><span class="o">((</span><span class="n">HttpServletRequest</span><span class="o">)</span> <span class="n">sre</span><span class="o">.</span><span class="na">getServletRequest</span><span class="o">()));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">requestDestroyed</span><span class="o">(</span><span class="kd">final</span> <span class="n">ServletRequestEvent</span> <span class="n">sre</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">SecurityContext</span><span class="o">.</span><span class="na">removePrincipal</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="n">MyPrincipal</span> <span class="nf">getMyPrincipal</span><span class="o">(</span><span class="kd">final</span> <span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">roles</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">roles</span> <span class="o">=</span> <span class="n">getSecurityRoles</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Principal</span> <span class="n">principal</span> <span class="o">=</span> <span class="o">(</span><span class="n">Principal</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getUserPrincipal</span><span class="o">();</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">currentRoles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">role</span> <span class="o">:</span> <span class="n">roles</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">isUserInRole</span><span class="o">(</span><span class="n">role</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">currentRoles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">role</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">MyPrincipal</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="n">currentRoles</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getSecurityRoles</span><span class="o">(</span><span class="kd">final</span> <span class="n">ServletContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next method is not very elegant but this is the only way that have found to extract the role
list that is required by the current web application. It parses the <code>web.xml</code>, looking for
<code>role-name</code> elements that describe a role.</p>

<figure class='code'><figcaption><span>Extract the role list from web.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">synchronized</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getSecurityRoles</span><span class="o">(</span><span class="kd">final</span> <span class="n">ServletContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>    <span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&quot;/WEB-INF/web.xml&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">DocumentBuilderFactory</span> <span class="n">dbFactory</span> <span class="o">=</span> <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
</span><span class='line'>    <span class="n">dbFactory</span><span class="o">.</span><span class="na">setNamespaceAware</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">DocumentBuilder</span> <span class="n">dBuilder</span> <span class="o">=</span> <span class="n">dbFactory</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
</span><span class='line'>        <span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">dBuilder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
</span><span class='line'>        <span class="n">doc</span><span class="o">.</span><span class="na">getDocumentElement</span><span class="o">().</span><span class="na">normalize</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">NodeList</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">getElementsByTagName</span><span class="o">(</span><span class="s">&quot;role-name&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">elements</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">r</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">elements</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getTextContent</span><span class="o">().</span><span class="na">trim</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">new</span> <span class="nf">IllegalAccessException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">r</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, the listener is enabled by putting the following lines in <code>web.xml</code>.</p>

<figure class='code'><figcaption><span>web.xml</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;listener&gt;</span>
</span><span class='line'>    <span class="nt">&lt;listener-class&gt;</span>ch.demo.web.SecurityListener<span class="nt">&lt;/listener-class&gt;</span>
</span><span class='line'><span class="nt">&lt;/listener&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whenever there is not redirect (that triggers a new request) after login or there is a manual call to JAAS, the
principal must be manually set into thread-local right after the login. This is because if the
security is checked right after authentication and the listener has already been called (at the beginning of the
request) it has been set to an invalid principal.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">request</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
</span><span class='line'><span class="n">SecurityContext</span><span class="o">.</span><span class="na">setPrincipal</span><span class="o">(</span><span class="n">SecurityListener</span><span class="o">.</span><span class="na">getMyPrincipal</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>In this post, we have seen how to write a JEE6 interceptor to authorise access to service level methods in servlet containers. The examples used in this blog are to be found in the <a href="http://code.google.com/p/jee6-demo/">JEE-6-Demo</a> project on <a href="http://code.google.com">Google code hosting</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/16/using-selenium-for-web-integration-testing/">Using Selenium for Web Integration Testing</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-16T18:57:00+02:00" pubdate data-updated="true">Apr 16<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/04/16/using-selenium-for-web-integration-testing/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Following up on my previous posts (<a href="/blog/2012/04/09/embedded-jee-web-application-integration-testing-using-tomcat-7/">here</a>
and <a href="/blog/2012/04/05/programmatically-build-web-archives-using-shrinkwrap/">here</a> about integration testing
of JEE web applications, I will present how to write smoke tests using Selenium. The idea is to
detect whether important regressions have been introduced. This is especially useful to detect
configuration and navigation problems. I&#8217;ve split the test in three parts:</p>

<ol>
<li>starting and stopping the container. Embedded Tomcat 7 in our case. This is described
<a href="/blog/2012/04/09/embedded-jee-web-application-integration-testing-using-tomcat-7">here</a>;</li>
<li>building the WAR file to test. To that end, you can look at this
<a href="/blog/2012/04/05/programmatically-build-web-archives-using-shrinkwrap">post</a> that describes how to
build such a test archive using Shrinkwrap;</li>
<li>finally, we must build the test case. This is the goal of this post.</li>
</ol>


<p>Testing a use case requires to be able to:</p>

<ol>
<li>get a page at a given URL;</li>
<li>input test data into the web elements;</li>
<li>assert whether the server answers as expected.</li>
</ol>


<p>Selenium provides an easy API to fetch URLs
As these are smoke tests, using the <code>HtmlUnitDriver</code> instead of a specific browser is sufficient.
We do not want to detect minor display problems but rather important functional problems.</p>

<p>Selenium has many different drivers for many different browser. The problem is that it opens the
browser in a new window. I prefer to have the continuous integration running headless.</p>

<p>The following dependencies are required to run the tests.</p>

<figure class='code'><figcaption><span>Maven dependencies</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>org.seleniumhq.selenium<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>selenium-java<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.20.0<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span><span class='line'><span class="nt">&lt;dependency&gt;</span>
</span><span class='line'>    <span class="nt">&lt;groupId&gt;</span>net.sourceforge.htmlunit<span class="nt">&lt;/groupId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;artifactId&gt;</span>htmlunit<span class="nt">&lt;/artifactId&gt;</span>
</span><span class='line'>    <span class="nt">&lt;version&gt;</span>2.9<span class="nt">&lt;/version&gt;</span>
</span><span class='line'>    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class='line'><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>First, let&#8217;s build a new headless driver. This object simulates the browser. It manages the HTTP part as
well as parsing the HTML and the javascript code that is returned.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WebDriver</span> <span class="n">driver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HtmlUnitDriver</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next step is to ask the driver to load the home page that we want to test. For
convenience, in my previous posts I defined a method that returns the current Tomcat port and the
application context.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">driver</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;http://localhost:&quot;</span> <span class="o">+</span> <span class="n">getTomcatPort</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">getApplicationId</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s assume that the home page redirects to a login page that has two text boxes (respectively
called <code>username</code> and password). The following snippet uses XPATH expressions to locate web elements.
First, it locates a HTML element of type <code>input</code> that has an
attribute  <code>id</code> set to <code>username</code>. If this web element is not present, the driver will raise an exception.
This allows to easily detect whether a widget has been accidentally removed.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WebElement</span> <span class="n">username</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">xpath</span><span class="o">(</span><span class="s">&quot;//input[contains(@id,&#39;username&#39;)]&quot;</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Now we can interact with the previous element. For instance, to simulate a user that types in its username (<code>admin</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">username</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>After that, Let&#8217;s do the same for the web element called <code>password</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WebElement</span> <span class="n">password</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">xpath</span><span class="o">(</span><span class="s">&quot;//input[contains(@id,&#39;password&#39;)]&quot;</span><span class="o">));</span>
</span><span class='line'><span class="n">password</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Finally, we locate a button called <code>login</code>and we simulate a click on it.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WebElement</span> <span class="n">login</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">xpath</span><span class="o">(</span><span class="s">&quot;//button[contains(@id,&#39;login&#39;)]&quot;</span><span class="o">));</span>
</span><span class='line'><span class="n">login</span><span class="o">.</span><span class="na">click</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>On successful login, our example redirects to a page that contains a list of students.
The following assertion checks that the string <code>Student list</code> exists somewhere is the returned
HTML source code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">driver</span><span class="o">.</span><span class="na">getPageSource</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;Student list&quot;</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this approach, it is also very easy to do trivial security testing. For instance, let&#8217;s check that
the application redirects (or forwards) the user to the login page upon unsuccessful login.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">WebElement</span> <span class="n">username</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">xpath</span><span class="o">(</span><span class="s">&quot;//input[contains(@id,&#39;username&#39;)]&quot;</span><span class="o">));</span>
</span><span class='line'><span class="n">username</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">WebElement</span> <span class="n">password</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">xpath</span><span class="o">(</span><span class="s">&quot;//input[contains(@id,&#39;password&#39;)]&quot;</span><span class="o">));</span>
</span><span class='line'><span class="n">password</span><span class="o">.</span><span class="na">sendKeys</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">WebElement</span> <span class="n">login</span> <span class="o">=</span> <span class="n">driver</span><span class="o">.</span><span class="na">findElement</span><span class="o">(</span><span class="n">By</span><span class="o">.</span><span class="na">xpath</span><span class="o">(</span><span class="s">&quot;//button[contains(@id,&#39;login&#39;)]&quot;</span><span class="o">));</span>
</span><span class='line'><span class="n">login</span><span class="o">.</span><span class="na">click</span><span class="o">();</span>
</span><span class='line'><span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">driver</span><span class="o">.</span><span class="na">getPageSource</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;username&quot;</span><span class="o">));</span>
</span><span class='line'><span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">driver</span><span class="o">.</span><span class="na">getPageSource</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;password&quot;</span><span class="o">));</span>
</span><span class='line'><span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">driver</span><span class="o">.</span><span class="na">getPageSource</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;login&quot;</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>In this post, we have seen how to write smoke integration tests with Selenium. This is especially
useful to detect whether an important functionality has been hindered. For instance, a change in the
navigation or a unexpected change of the status (availability, visibility) of one the buttons or web elements.
I recommend implementing the three or four major scenarios with this technique. This is usually enough to
detect major problems. The examples used in this blog are to be found in the <a href="http://code.google.com/p/jee6-demo/">JEE-6-Demo</a> project on <a href="http://code.google.com">Google code hosting</a>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/18/fakes-stubs-dummy-mocks-doubles-and-all-that/">Fakes, Stubs, Dummy, Mocks, Doubles and all that&#8230;</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/18/testing-levels/">Testing levels</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/31/jee6-tutorial/">JEE6 Tutorial</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/05/servicelocator/">Context Dependency Injection and the Rich Object Model</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/20/multi-tenancy/">Multi-Tenancy with EJB 3.1 and JPA 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/10/Sessions-GC-Conversations/">About Sessions, Conversations, and the Garbage Collector</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/24/moxy/">Object-XML Mapping with JAXB & MOXy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/18/verification-validation-and-all-that/">Verification & Validation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/05/02/a-jee6-security-interceptor-for-tomcat-7/">A JEE6 security interceptor for Tomcat 7</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/16/using-selenium-for-web-integration-testing/">Using Selenium for web integration testing</a>
      </li>
    
  </ul>
</section>




<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/116636069211041664299?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Steve Hostettler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hostettlerblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>

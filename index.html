
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Steve Hostettler</title>
  <meta name="author" content="Steve Hostettler">

  
  <meta name="description" content="In my current assignment, I had the opportunity to discuss with Data Warehouse (DW) experts about the DW integration with the rest of the information &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://hostettler.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Steve Hostettler" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-30751319-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Steve Hostettler</a></h1>
  
    <h2>JEE and test automation</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hostettler.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/02/10/data-warehouse/">A (Small) Hitchhiker&#8217;s Guide to the Data Warehousing</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-02-10T14:07:42+01:00" pubdate data-updated="true">Feb 10<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/02/10/data-warehouse/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2016/02/10/data-warehouse/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my current assignment, I had the opportunity to discuss with Data Warehouse (DW) experts about the DW integration with the rest of the information system.
I noticed that not every people (included Data Warehouse professionals) uses the same vocabulary.
During the discussions, people raised words such as &#8220;Data Warehouse&#8221;, &#8220;Data Marts&#8221;, ODS, &#8220;Data Lake&#8221; and so on. Some of the words were used interchangeably which does not help to follow the discussion. As I was not familiar  with several  of them, I decided to do my homework and to come up with a small glossary to provide a common ground for further discussions.</p>

<blockquote><p>Disclaimer : I am not an expert in the field, I only tried to come up with a couple of definitions to get a common ground for further discussions.  Please experts in the field, help me to improve this!</p></blockquote>

<h2>Business Intelligence (B.I.)</h2>

<blockquote><p>Business intelligence is a set of methodologies, processes, architectures, and technologies that transform raw data into meaningful and useful information. It allows business users to make informed business decisions with real-time data that can put a company ahead of its competitors.</p>

<p><cite>Boris Evelson - Forrester</cite></p></blockquote>

<p>Business Intelligence Systems usually (but not always) rely on a Data Warehouse to provide information out of raw operational data.
The following diagram shows the relationships between the different levels involved in making a  decision.
<span class='caption-wrapper center'><img class='caption' src='/figures/B.I.png' width='' height='' alt='How B.I. helps Decision making' title='How B.I. helps Decision making'><span class='caption-text'>How B.I. helps Decision making</span></span></p>

<p>Business Intelligence Systems have the following properties:</p>

<ul>
<li>It leverages raw heterogeneous operational data</li>
<li>It enables multi-dimensional information and operations on it</li>
<li>It is driven by the business</li>
<li>It has to be performant and must not interfere with daily operations</li>
</ul>


<h2>Data Warehouse (DWH)</h2>

<p>DWHs are central repositories of integrated data from one or more disparate sources. Its purpose is to organize and homogenize data into information. User can then leverage this information into knowledge and therefore make informed decision (see B.I.).</p>

<p>There are  three main approaches on how to build a data warehouse.</p>

<h3>William Inmon&#8217;s approach</h3>

<p>According to <a href="http://www.amazon.com/Building-Data-Warehouse-W-Inmon/dp/0471141615">William Inmon</a> that originally coined the term &#8220;Data Warehouse&#8221;, a data warehouse has the following properties:
- Subject oriented : This implies that data are organized around the business and not around the sources. For instance, several accounting data sources are consolidated into one accounting data warehouse. The purpose of which is to letting information emerge out of data.
- Integrated : Coming from different sources, data must be standardized to enable consistency and thus letting information emerge. For instance, customer identification must be normalized across different sources.
- Non-volatile : Once in the data warehouse, data must not be altered. Therefore, data is available for future comparison.
- Time-variant : Changes made on data over time are tracked. For instance, each and every change to a customer country of residence are tracked.</p>

<p>Inmon’s model follows a top-down approach. First, a complete (enterprise wide) Data Warehouse (DW) is created in 3NF and then, if required, datamarts (DM) are provisioned out of the DW. Datamarts in Inmon’s model are in 3NF from which the OLAP cubes are built.
For Inmon, data quality and coherency is paramount and thus the 3NF in the DW and the DMs.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/Imnon.png' width='' height='' alt='The Imnon Top-Down model' title='The Imnon Top-Down model'><span class='caption-text'>The Imnon Top-Down model</span></span></p>

<h3>Ralph Kimball&#8217;s approach</h3>

<p>According to <a href="http://www.amazon.com/The-Data-Warehouse-Toolkit-Dimensional-ebook/dp/B004GXBZFQ">Kimball</a> another prominent actor in this field, &#8220;Data Warehouse is a system that extracts, cleans, conforms, and delivers source data into a dimensional data store and then supports and implements querying and analysis for the purpose of decision making.&#8221; This definition does not contradict Inmon&#8217;s properties. The difference lies in the architecture.</p>

<p>Kimball’s model follows a bottom-up approach. First, some Datamarts (DM) emerge directly sourced from OLTP systems usually follow the company processes and organization.<br/>
The Datamarts are usually de-normalized star schemas. The OLAP cubes are built on top of them.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/Kimball.png' width='' height='' alt='The Kimball Bottum-Up model' title='The Kimball Bottum-Up model'><span class='caption-text'>The Kimball Bottum-Up model</span></span></p>

<h3>The Hybrid model - A typical architecture</h3>

<p>Both of these approaches have their pros and cons. Kimball’s model is easy to start with because of the bottom-up approach and hence you can start small and scale-up eventually. Moreover, the ROI is usually better with Kimball’s model.
Because of this approach it is difficult to created re-usable data structures and operations (extraction) for different datamarts. Finally, you may end-up with consistency problems.
On the other hand, Inmon’s approach is structured and easier to maintain at the cost of being rigid and more expensive.</p>

<p>Real-life DWH implementation often end-up using a hybrid architecure. The following architecture relies on the following biulding blocks:</p>

<ul>
<li>a staging layer to extract and sanitize data</li>
<li>an ODS to enable &#8220;close to the operation&#8221; data mining</li>
<li>an 3NF DWH with full history to enable the creation unanticipated datamarts</li>
<li>datamarts that rely on the star schema for better performances</li>
</ul>


<p><span class='caption-wrapper center'><img class='caption' src='/figures/DWHArchitecture.png' width='' height='' alt='A typical Hybrid Architecture' title='A typical Hybrid Architecture'><span class='caption-text'>A typical Hybrid Architecture</span></span></p>

<h2>Data Mart (DMT)</h2>

<p>A datamart is essentially a basic building block of the data warehouse.
The term &#8220;data mart&#8221; has become somewhat ambiguous, but it is traditionally associated with a subject-oriented subset of an organization&#8217;s information systems. Data mart does not explicitly imply the presence of a multi-dimensional technology such as OLAP and data mart does not explicitly imply the presence of summarized numerical data.</p>

<h2>Operational Data Store (ODS)</h2>

<p>An operational data store (ODS) is building block of Data warehouse used for immediate reporting with operational data.  An ODS contains lightly transformed and lightly integrated operational data with a (rather) short time window. The ODS is usually used when looking for specific events (settling a banking movement or looking for a specific operation). Full history is available in the DWH.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/30/integration-tests-with-docker-and-arquillian/">Integration Tests With Docker and Arquillian</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-30T23:38:50+01:00" pubdate data-updated="true">Jan 30<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/01/30/integration-tests-with-docker-and-arquillian/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2016/01/30/integration-tests-with-docker-and-arquillian/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last month I decided to add a touch of <a href="http://martinfowler.com/articles/microservices.html">microservices</a> to the JEE course I teach at the University of Geneva.
I ended up with a couple of microservices and as expected I came across the challenge of their integration testing.
This post is specifically about microservices. It rathers focuses on the JEE integration testing experience I encountered while building the microservices. A dedicated blog post will follow on my journey through the building of microservices with JEE.</p>

<h2>A short description of the architecture</h2>

<p>From a technological perspective, I am using JEE 7 on <a href="http://wildfly.org/">Wildfly</a> with <a href="http://wildfly.org/">MySql</a>. Therefore, my microservices are wars composed of 1-2 EJBs plus a restful service that exposes the logic. Typically, my microservices are composed of 4-5 classes of max 150 lines of codes each. On my laptop, a microservice deploys in less than 5 seconds. I mainly need to test EJBs and their database calls. I also want to test integration between microservices.</p>

<h3>Why Docker?</h3>

<p>As it serves as a example for a course, I want it to be super easy to install/re-install 20 times if necessary. Furthermore, I want fast-paced deployment. To that end, Docker is a great tool because I do not have to bother on what laptop/computer the students work (provided they can run <a href="https://www.docker.com/products/docker-toolbox">Docker Toolbox</a>). Moreover, all the tools/middlewares I am using for the course are already packaged as Docker images.</p>

<h2>Building a  Docker image for a Wildfly Integration Test Server</h2>

<p>As mentioned previously, I propose to use Wildfly +  MySql as the runtime environment. However, at test time, I do not want to start both an application server and a database. More important, I want to get a fresh database for each and every test suite. Futhermore, I would like to use on a simpler setup for the application server. For instance, I do prefer to use an in memory H2 database instead of MySql. I also do not want to bother with LDAP/JAAS configuration, clustering, etc&#8230;.
Of course, datasource name, realm name and more generally all the resources required by the microservices must be present with their production name.</p>

<p>Ones of Wildfly&#8217;s great features is its ability to be configured using the command line.
The first step is to configure a data source relying on H2 that has the same name as the production one.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># First step : Add the datasource</span>
</span><span class='line'>data-source add --name<span class="o">=</span>StudentsDS --driver-name<span class="o">=</span>h2 --jndi-name<span class="o">=</span><span class="nv">$STUDENTS_DS</span> --connection-url<span class="o">=</span><span class="nv">$H2_URI</span> --user-name<span class="o">=</span><span class="nv">$H2_USER</span> --password<span class="o">=</span><span class="nv">$H2_PWD</span> --use-ccm<span class="o">=</span><span class="nb">false</span> --max-pool-size<span class="o">=</span>25 --blocking-timeout-wait-millis<span class="o">=</span>5000
</span></code></pre></td></tr></table></div></figure>


<p>Then, let&#8217;s configure a realm.  This is helpful when integration tests rely on principals and do verify the security.
The file <code>jee7-demo-realm-users.properties</code> (resp. <code>jee7-demo-realm-roles.properties</code>) defines the users (resp. the roles) of the realm.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Add a property file realm</span>
</span><span class='line'>/subsystem<span class="o">=</span>security/security-domain<span class="o">=</span>jee7-demo-realm:add<span class="o">(</span>cache-type<span class="o">=</span>default<span class="o">)</span>
</span><span class='line'>/subsystem<span class="o">=</span>security/security-domain<span class="o">=</span>jee7-demo-realm/authentication<span class="o">=</span>classic:add<span class="o">()</span>
</span><span class='line'>/subsystem<span class="o">=</span>security/security-domain<span class="o">=</span>jee7-demo-realm/authentication<span class="o">=</span>classic/login-module<span class="o">=</span>UsersRoles       <span class="se">\</span>
</span><span class='line'>    :add<span class="o">(</span><span class="nv">code</span><span class="o">=</span>UsersRoles, <span class="nv">flag</span><span class="o">=</span>required,                                                        <span class="se">\</span>
</span><span class='line'>         module-options<span class="o">={</span><span class="s2">&quot;usersProperties&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;${JBOSS_CUSTOMIZATION}/jee7-demo-realm-users.properties&quot;</span>,   <span class="se">\</span>
</span><span class='line'>                         <span class="s2">&quot;rolesProperties&quot;</span><span class="o">=</span>&gt;<span class="s2">&quot;${JBOSS_CUSTOMIZATION}/jee7-demo-realm-roles.properties&quot;</span><span class="o">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, let&#8217;s add an admin user in order to allows Arquilian or an IDE to interact with this application server.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>/opt/jboss/wildfly/bin/add-user.sh admin admin
</span></code></pre></td></tr></table></div></figure>


<p>Hereafter the complete configuration <code>config_wildfly.sh</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Usage: execute.sh [WildFly mode] [configuration file]</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># The default mode is &#39;standalone&#39; and default configuration is based on the</span>
</span><span class='line'><span class="c"># mode. It can be &#39;standalone.xml&#39; or &#39;domain.xml&#39;.</span>
</span><span class='line'>
</span><span class='line'><span class="nv">JBOSS_HOME</span><span class="o">=</span>/opt/jboss/wildfly
</span><span class='line'><span class="nv">JBOSS_CUSTOMIZATION</span><span class="o">=</span><span class="nv">$JBOSS_HOME</span>/customization
</span><span class='line'><span class="nv">JBOSS_STANDALONE_CONFIG</span><span class="o">=</span><span class="nv">$JBOSS_HOME</span>/standalone/configuration/
</span><span class='line'><span class="nv">JBOSS_CLI</span><span class="o">=</span><span class="nv">$JBOSS_HOME</span>/bin/jboss-cli.sh
</span><span class='line'><span class="nv">JBOSS_MODE</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="k">:-</span><span class="s2">&quot;standalone&quot;</span><span class="k">}</span>
</span><span class='line'><span class="nv">JBOSS_CONFIG</span><span class="o">=</span><span class="k">${</span><span class="nv">2</span><span class="k">:-</span><span class="s2">&quot;$JBOSS_MODE.xml&quot;</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function </span>wait_for_server<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">until</span> <span class="sb">`</span><span class="nv">$JBOSS_CLI</span> -c <span class="s2">&quot;:read-attribute(name=server-state)&quot;</span> 2&gt; /dev/null | grep -q running<span class="sb">`</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span>sleep 1
</span><span class='line'>  <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=&gt; Starting WildFly server&quot;</span>
</span><span class='line'><span class="nv">$JBOSS_HOME</span>/bin/<span class="nv">$JBOSS_MODE</span>.sh -b 0.0.0.0 -c <span class="nv">$JBOSS_CONFIG</span> &amp;
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=&gt; Waiting for the server to boot&quot;</span>
</span><span class='line'>wait_for_server
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=&gt; Executing the commands&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">STUDENTS_DS</span><span class="o">=</span><span class="s2">&quot;java:/StudentsDS&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">H2_URI</span><span class="o">=</span><span class="s2">&quot;jdbc:h2:mem:STUDENTS_DB;DB_CLOSE_DELAY=-1&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">H2_USER</span><span class="o">=</span><span class="s2">&quot;sa&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">H2_PWD</span><span class="o">=</span><span class="s2">&quot;sa&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$JBOSS_CLI</span> -c <span class="s">&lt;&lt; EOF</span>
</span><span class='line'><span class="s">batch</span>
</span><span class='line'>
</span><span class='line'><span class="s">echo &quot;Connection URL: &quot; $CONNECTION_URL</span>
</span><span class='line'>
</span><span class='line'><span class="s"># First step : Add the datasource</span>
</span><span class='line'><span class="s">data-source add --name=StudentsDS --driver-name=h2 --jndi-name=$STUDENTS_DS --connection-url=$H2_URI --user-name=$H2_USER --password=$H2_PWD --use-ccm=false --max-pool-size=25 --blocking-timeout-wait-millis=5000 </span>
</span><span class='line'>
</span><span class='line'><span class="s"># Then configure a realm that relies on property files</span>
</span><span class='line'><span class="s">/subsystem=security/security-domain=jee7-demo-realm:add(cache-type=default)</span>
</span><span class='line'><span class="s">/subsystem=security/security-domain=jee7-demo-realm/authentication=classic:add()</span>
</span><span class='line'><span class="s">/subsystem=security/security-domain=jee7-demo-realm/authentication=classic/login-module=UsersRoles       \</span>
</span><span class='line'><span class="s">    :add(code=UsersRoles, flag=required,                                                        \</span>
</span><span class='line'><span class="s">         module-options={&quot;usersProperties&quot;=&gt;&quot;${JBOSS_CUSTOMIZATION}/jee7-demo-realm-users.properties&quot;,   \</span>
</span><span class='line'><span class="s">                         &quot;rolesProperties&quot;=&gt;&quot;${JBOSS_CUSTOMIZATION}/jee7-demo-realm-roles.properties&quot;})</span>
</span><span class='line'>
</span><span class='line'><span class="s"># Execute the batch</span>
</span><span class='line'><span class="s">run-batch</span>
</span><span class='line'><span class="s">EOF</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Finally, let&#39;s add an admin that can be used by the IDE to deploy the tests</span>
</span><span class='line'>/opt/jboss/wildfly/bin/add-user.sh admin admin
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;=&gt; Shutting down WildFly&quot;</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$JBOSS_MODE&quot;</span> <span class="o">=</span> <span class="s2">&quot;standalone&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>  <span class="nv">$JBOSS_CLI</span> -c <span class="s2">&quot;:shutdown&quot;</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>  <span class="nv">$JBOSS_CLI</span> -c <span class="s2">&quot;/host=*:shutdown&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next step is to enhance the official Wildfly image called <code>jboss/wildfly:latest</code> with the specific configurations required for integration testing. This following Dockerfile describes how to build the image that we will use for testing.
First, it adds the previous configuration files <code>./config_wildfly.sh ./jee7-demo-realm-roles.properties ./jee7-demo-realm-users.properties</code> to the <code>/opt/jboss/wildfly/customization/</code> of the image. Then we tell Docker to run the configuration <code>config_wildfly.sh</code> and to do some cleanup. After what, it will record the states as a new image.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM jboss/wildfly:latest
</span><span class='line'>
</span><span class='line'>ADD ./config_wildfly.sh ./jee7-demo-realm-roles.properties ./jee7-demo-realm-users.properties /opt/jboss/wildfly/customization/
</span><span class='line'>
</span><span class='line'>RUN <span class="o">[</span><span class="s2">&quot;/opt/jboss/wildfly/customization/config_wildfly.sh&quot;</span><span class="o">]</span>
</span><span class='line'>RUN rm -rf  /opt/jboss/wildfly/standalone/configuration/standalone_xml_history
</span><span class='line'>CMD <span class="o">[</span><span class="s2">&quot;/opt/jboss/wildfly/bin/standalone.sh&quot;</span>, <span class="s2">&quot;--debug&quot;</span>, <span class="s2">&quot;-b&quot;</span>, <span class="s2">&quot;0.0.0.0&quot;</span>, <span class="s2">&quot;-bmanagement&quot;</span>, <span class="s2">&quot;0.0.0.0&quot;</span><span class="o">]</span>
</span><span class='line'>EXPOSE 8787
</span></code></pre></td></tr></table></div></figure>


<p>Now we can build an image called <code>jee7-test-wildfly</code> using the following command (in the directory where the <code>Dockerfile</code> lives):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker build --no-cache -rm -t jee7-test-wildfly .
</span></code></pre></td></tr></table></div></figure>


<p>The following command runs the image we just built, exposes (and map) the port 8080, 9090 and 8787, and mount the local directory <code>/Users/XXXXXXXXXX/tmp/docker-deploy</code> on the image&#8217;s <code>/opt/jboss/wildfly/standalone/deployments/</code> directory. This is of course the directory in which the integration tests are to be deployed..</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>docker run -d  -p 8080:8080 -p 9990:9990 -p 8787:8787 -v /Users/XXXXXXXXXX/tmp/docker-deploy:/opt/jboss/wildfly/standalone/deployments/:rw jee7-test-wildfly
</span></code></pre></td></tr></table></div></figure>


<p>Now that we do have a container running an application server with in memory database and a simple realm, we can configure the test harness.</p>

<h2>How to configure Arquillian</h2>

<p><a href="http://arquillian.org/">Arquillian</a> is a JEE integration test framework. It allows to test JEE components such as EJBs or web services.
The first step it to tell Arquillian where the Wildfly server lives. The following <code>arquillian.xml</code> file states that the integration tests should deploy on a Wildfly container that listens at <code>192.168.99.100</code> (which is the Docker container address) on port <code>9990</code> (which is the administration port). Furthermore, it declares the admin username and password.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;arquillian</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>  <span class="na">xmlns=</span><span class="s">&quot;http://jboss.org/schema/arquillian&quot;</span>
</span><span class='line'>  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://jboss.org/schema/arquillian</span>
</span><span class='line'><span class="s">  http://jboss.org/schema/arquillian/arquillian_1_0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;container</span> <span class="na">qualifier=</span><span class="s">&quot;wildfly&quot;</span> <span class="na">default=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;configuration&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;managementAddress&quot;</span><span class="nt">&gt;</span>192.168.99.100<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;managementPort&quot;</span><span class="nt">&gt;</span>9990<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="nt">&gt;</span>admin<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>admin<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/configuration&gt;</span>
</span><span class='line'>      <span class="nt">&lt;protocol</span> <span class="na">type=</span><span class="s">&quot;Servlet 3.0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;host&quot;</span><span class="nt">&gt;</span>192.168.99.100<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>          <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;port&quot;</span><span class="nt">&gt;</span>8080<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/protocol&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/container&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;extension</span> <span class="na">qualifier=</span><span class="s">&quot;jacoco&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;includes&quot;</span><span class="nt">&gt;</span>ch.demo.*<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/extension&gt;</span>
</span><span class='line'><span class="nt">&lt;/arquillian&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>A simple integration Test</h2>

<p>Let us now write a simple integration test. First, we must tell Arquillian the it is in charge of running the test (<code>@RunWith(Arquillian.class)</code>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">Arquillian</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceImplTest</span> <span class="o">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>To test a given component (let&#8217;s say an EJB), arquillian expects a well-formed Java component (either a jar or a war).
The following test is composend of a package contaning the EJB under test (<code>ch.demo</code>), an empty <code>beans.xml</code> to enable CDI and finally a <code>persistence.xml</code> to enable JPA.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Deployment</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">JavaArchive</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">ShrinkWrap</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">JavaArchive</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;integration-test-demo.jar&quot;</span><span class="o">).</span><span class="na">addPackages</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="s">&quot;ch.demo&quot;</span><span class="o">)</span>
</span><span class='line'>          <span class="o">.</span><span class="na">addAsManifestResource</span><span class="o">(</span><span class="n">EmptyAsset</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">,</span> <span class="s">&quot;beans.xml&quot;</span><span class="o">)</span>
</span><span class='line'>          <span class="o">.</span><span class="na">addAsManifestResource</span><span class="o">(</span><span class="s">&quot;test-persistence.xml&quot;</span><span class="o">,</span> <span class="s">&quot;persistence.xml&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The previous JAR as well as the tests are packaged as a WAR and deployed on the application server declared in the <code>arquillian.xml</code> file. The following test injects the EJB under test implementing the <code>StudentService</code> interface and tests its <code>add</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Inject</span>
</span><span class='line'><span class="n">StudentService</span> <span class="n">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldAddReturnAllWithTheNewStudent</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Integer</span> <span class="n">nbStudentsBeforeTest</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getNbStudent</span><span class="o">();</span>
</span><span class='line'>  <span class="n">service</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="s">&quot;Doe&quot;</span><span class="o">,</span> <span class="s">&quot;Jane&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(),</span> <span class="k">new</span> <span class="n">PhoneNumber</span><span class="o">(</span><span class="s">&quot;+33698075273&quot;</span><span class="o">)));</span>
</span><span class='line'>  <span class="n">Integer</span> <span class="n">nbStudentsAfterTest</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>  <span class="n">Assert</span><span class="o">.</span><span class="na">assertSame</span><span class="o">(</span><span class="n">nbStudentsBeforeTest</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">nbStudentsAfterTest</span><span class="o">);</span>
</span><span class='line'>  <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">service</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">nbStudentsAfterTest</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">getLastName</span><span class="o">(),</span> <span class="s">&quot;Doe&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Maven, IDE Integration and Coverage</h2>

<p>Finally, let me add that it is possible to get coverage data from Arquillian by enabling extensions. In the following, it enables<code>`jacoco</code>. This produces coverage data that can be used by the Eclipse ECL-EMMA plugin.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>   <span class="nt">&lt;extension</span> <span class="na">qualifier=</span><span class="s">&quot;jacoco&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;includes&quot;</span><span class="nt">&gt;</span>ch.demo.*<span class="nt">&lt;/property&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/extension&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Docker and Arquillian provide a nice and seamless way for JEE integration testing. Nevertheless, I had a hard time at the beginning because Arquillian error handling in case of undeployable test archive is not very good. In this case, make sure that you package your test correctly (in the method annotated <code>@Deployment</code>). In particular, double check <code>beans.xml</code>, <code>web.xml</code> and the JAR/WAR structure. It really helped me to unzip the deployed test archive to figure out what when wrong in my code.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/02/cleaning-intermediate-docker-images/">Cleaning Intermediate Docker Images</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-02T01:56:34+01:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2015</time>
        
           | <a href="/blog/2015/12/02/cleaning-intermediate-docker-images/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2015/12/02/cleaning-intermediate-docker-images/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently started to use Docker. It is a great tool that significantly increases developer&#8217;s productivity. However, I regularly encounter disk space problems when developing new images. Indeed, I sometimes end up with dangling images and containers. Hereafter, a simple script that cleans up most of them.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>docker rmi -f <span class="sb">`</span>docker images | grep <span class="s2">&quot;^&lt;none&gt;&quot;</span> | cut -c41-52<span class="sb">`</span>
</span><span class='line'>docker rmi <span class="k">$(</span>docker images -q -f <span class="nv">dangling</span><span class="o">=</span><span class="nb">true</span><span class="k">)</span>
</span><span class='line'>docker rm -v <span class="k">$(</span><span class="nb">echo</span> <span class="k">$(</span>docker ps -q --no-trunc<span class="k">)</span> <span class="k">$(</span>docker ps -a -q --no-trunc<span class="k">)</span> | sed <span class="s1">&#39;s|\s|\n|g&#39;</span>  | sort | uniq -u<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/26/communication-between-java-enterprise-applications/">Communication Between Java Enterprise Applications</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-26T22:51:48+01:00" pubdate data-updated="true">Dec 26<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/12/26/communication-between-java-enterprise-applications/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2014/12/26/communication-between-java-enterprise-applications/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently I came across the following problem : How to propagate information from one enterprise application to another in a transparent manner? Transparent meaning without changing the API, that is without adding transversal information to the services&#8217; parameters. The typical use case is to propagate information such as the language, applicative security roles information (not the JAAS role), or the session-id. Moreover, I would like the information to be &#8220;request scoped&#8221; and to be automatically cleaned up at the end of the request. This is important to avoid memory leak and to enforce isolation for security reasons. Let me add that I currently work with JEE6 on WebSphere 8.5.5.</p>

<p>I did some research among blogs and forums and I found the following solutions:</p>

<p>1) Passing information in thread-local. This consists in putting information in a <code>Map</code> stored in <code>ThreadLocal</code>. Although this solution is very simple to implement, information is only transmitted inside the current thread. This means that <code>@Asynchronous</code> calls will not get access to the information. Similarly, it is not transmitted through RMI calls that spread on several VMs, as it is usually the case on distributed applications.</p>

<p>2) Using the JNDI. This solution does not suffer of the above limitations as it is distributed by nature but scoping must be implemented on top of the existing JNDI implementation. I think that it may be possible to implement something like a custom CDI scope but it seems rather complex.</p>

<p>3) TransactionSynchronizationRegistry (TSR). This alternative is well documented <a href="http://www.adam-bien.com/roller/abien/entry/how_to_pass_context_in">here</a>. This solution works on a JEE application servers. It looks great at the first sight but it does not support any use case in which there is different transactions (or no transaction) involved. This invalidates any information sharing before a transaction as started, when a transaction has been suspended, or when a new transaction is started. Again, I can imagine that it would possible to propagate the content using interceptors but it is too much plumber code to me.</p>

<p>4) Work Area Service (WAS). This is basically the IBM implementation of solution 2 with scoping. Documentation is clear and it seems easy to implement. Of course, the main drawback is that it is vendor-specific. IBM started a <a href="https://jcp.org/en/jsr/detail?id=149">JSR</a> long time ago but it was dropped.</p>

<p>Let us now enumerate several criteria to make a decision about which way to go:</p>

<p>1) Supports of asynchronous calls : during a request it may be necessary to dispatch the processing among several threads and I would like the shared information to be accessible by any threads involved in this request.</p>

<p>2) Is (automatically) &#8220;request scoped&#8221; : if the shared information is not automatically collected at the end the request we may end up with memory leaks. Manual collection is never a good option.</p>

<p>3) Supports Remote Calls : for a given request, we may end up calling several services (EJBs) on others servers and I would like to have an automatic propagation of the information among the clusters nodes.</p>

<p>3) Performance : to be useful, the information sharing must be ubiquitous and therefore it must cheap in terms of resources.</p>

<p>4) Vendor Independence : as far as possible an application must rely on known and portable APIs such as JEE. Locking the application to a specific vendor is, in my opinions, is essentially a problem for maintenance. Migrating from one application server to another only happens rarely.</p>

<table style="align:center;border-width:1px;border-style:solid;border-color:black;width:100%">
<tr style="border-width:1px;border-style:solid;border-color:black;"> <th style="text-align:left;">Solution</th> <th style="text-align:center;">Async</th> <th style="text-align:center;">Scope</th> <th style="text-align:center;">RMI</th> <th style="text-align:center;">Vendor Indep.</th> </tr>
<tr> <td style="text-align:left;">Thread-Local</td style="text-align:center;"> <td style="text-align:center;">X</td> <td style="text-align:center;">OK</td> <td style="text-align:center;">X</td> <td style="text-align:center;">OK</td> </tr>
<tr> <td style="text-align:left;">JNDI</td> <td style="text-align:center;">OK</td> <td style="text-align:center;">X</td> <td style="text-align:center;">OK</td> <td style="text-align:center;">OK</td> </tr>
<tr> <td style="text-align:left;">TSR</td> <td style="text-align:center;">X</td> <td style="text-align:center;">OK</td> <td style="text-align:center;">OK</td> <td style="text-align:center;">OK</td> </tr>
<tr> <td style="text-align:left;">WAS</td> <td style="text-align:center;">OK</td> <td style="text-align:center;">OK</td> <td style="text-align:center;">OK</td> <td style="text-align:center;">X</td> </tr>
</table>




<br/>


<p>As you can see there is no silver bullet here. I went for the vendor specific solution. It can be nicely encapsulated to isolate the dependency to vendor specific code. Furthermore, several servers have similar mechanism and it can be therefore adapted. Here is why it was not possible in my setup to use the other alternatives:</p>

<ul>
<li>The Thread-local solution is not acceptable because it does not support Remote Method Invocation on several virtual machines.</li>
<li>The JNDI solution requires to implement the scoping mechanism. This can be tricky and it is definitely not my area of expertise.</li>
<li>The TransactionSynchronizationRegistry is JEE compliant but it requires huge machinery to support asynchronous calls as well as transaction suspension and re-creation (<code>REQUIRES_NEW</code>, <code>NOT_SUPPORTED</code>, <code>NEVER</code>). Basically, it does not work if there is not one and only one transaction throughout the request.</li>
</ul>


<p>[1] Adam Bien. HOW TO PASS CONTEXT IN STANDARD WAY - WITHOUT THREADLOCAL. http://www.adam-bien.com/roller/abien/entry/how_to_pass_context_in</p>

<p>[2] Adam Bien. HOW TO PASS CONTEXT BETWEEN LAYERS WITH THREADLOCAL AND EJB 3.(1). http://www.adam-bien.com/roller/abien/entry/how_to_pass_context_with</p>

<p>[3] IBM. Work area partition service. http://www-01.ibm.com/support/knowledgecenter/SSEQTJ_8.0.0/com.ibm.websphere.nd.multiplatform.doc/info/ae/workarea/concepts/cwa_partition.html</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/18/fakes-stubs-dummy-mocks-doubles-and-all-that/">Fakes, Stubs, Dummy, Mocks, Doubles and All That&#8230;</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-18T10:58:00+02:00" pubdate data-updated="true">May 18<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/05/18/fakes-stubs-dummy-mocks-doubles-and-all-that/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2014/05/18/fakes-stubs-dummy-mocks-doubles-and-all-that/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post, I  look at the different kind of objects used for test purposes. By this, I mean objects that are used to make a test running. This article focuses on component testing, a.k.a. unit testing (I do not like the term unit testing because it is too often misunderstood with the technology behind, e.g., JUnit, testNG).
Although there already exists a great number of resources on that subject, it was very difficult to me to understand the differences between the different kinds of test objects. This is partly due to the fact that different authors use different terms for the same object and the same term for different objects [1]. To be as didactic as possible, I also chose to add some blocks of code. Please note, that these blocks are only here for the sake of clarity. This is not the way I would recommend to do stubbing, faking, and mocking. Consider  <a href="https://code.google.com/p/mockito/">Mockito</a> and PowerMockito for that. These are amazing tools to that purpose. They deserve a post on their own to discuss good practices.
This post is in no way an exhaustive state of the art, I only tried to select the terms that, in my opinion, are clear and are consensual enough. To that end I used a number of sources that can be found in the bibliography section.</p>

<p>Here are the main reasons to use different objects during the test phase and in production:</p>

<ul>
<li><p>Performances: the actual object contains slow algorithms and heavy calculation that may impair the test performances. A test should always be fast to not discourage regular run and therefore to identify problems as soon as possible. The worst case being the one in which the developer must deploy and run the entire application to test a single use case.</p></li>
<li><p>States: sometimes the constellation under test happens rarely. This is for instances that occur with a low probability  such as race conditions, network failure, etc..</p></li>
<li><p>Non-deterministic: this is the case of components that have interactions with the real-world such as sensors.</p></li>
<li><p>The actual object does not exist: for instance, another team is working on it and is not yet ready.</p></li>
<li><p>To instrument the actual dependency: for instance to spy the calls of the CUT to one of its dependencies.</p></li>
</ul>


<h2>Doubles objects</h2>

<p>Test double is the generic term that groups all the categories of objects that are used to fulfill one or several of the previous requirements.
The term comes has been coined by Gerard Meszaros in [2]
In rough terms, test doubles look like the actual object they double. They satisfy, to different extends the original interface and propose a sub-set of the behaviors that is expected by the specification. This helps to isolate the problem and reduce the double implementation to the strict minimum.</p>

<p>There exists different kind of test doubles for different purposes. The have in common that they can be use instead of the actual component without breaking the contract syntactically.</p>

<p>The next figure describes a simple test setup that do not use test doubles. To test the Component Under Test (CUT), the following test setup uses its actual dependencies (another component). This setup phase is trivial as there is nothing to do. The exercise phase calls the CUT with the proper parameters (direct inputs) that in turn calls it dependency (indirect outputs). Another Component returns its result to the CUT (indirect inputs) that uses it to complete the work and then finally returns the overall result (direct outputs). The terms &#8220;direct inputs&#8221;, &#8220;indirect outputs&#8221;, and so on come from [2].</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestSetup.png' width='' height='' alt='Overview of a test setup' title='Overview of a test setup'><span class='caption-text'>Overview of a test setup</span></span></p>

<p>Now let us say that &#8220;AnotherComponent&#8221; is either too complex, not already implemented or has a non-deterministic behavior. In those cases, it is easier to use another implementation of &#8220;AnotherComponent&#8221; that behaves exactly has expected for a specific scenario.</p>

<p>Hereafter, a simple example to illustrate the rest of the post. The class <code>CUTImpl</code> that realizes the contract <code>CUT</code> implements  the component under test. The CUT uses a component that realizes the interface <code>AnotherComponent</code>.
For the sake of clarity, the following example injects the dependencies through the constructor.
To improve loose coupling, it is possible to rely on dependency injection.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTImpl</span> <span class="kd">implements</span> <span class="n">CUT</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">AnotherComponent</span> <span class="n">component</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">CUTImpl</span><span class="o">(</span><span class="n">AnotherComponent</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">component</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">doBusiness</span><span class="o">(</span><span class="n">String</span> <span class="n">param</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">delta</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">component</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">param</span><span class="o">)).</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">CUT</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">doBusiness</span><span class="o">(</span><span class="n">String</span> <span class="n">string</span><span class="o">,</span> <span class="n">Integer</span> <span class="n">delta</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AnotherComponent</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Integer</span> <span class="nf">inc</span><span class="o">(</span><span class="n">Integer</span> <span class="n">param</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherComponentImpl</span> <span class="kd">implements</span> <span class="n">AnotherComponent</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">inc</span><span class="o">(</span><span class="n">Integer</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">param</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;Param must be not null!&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">param</span> <span class="o">==</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_INTEGER</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="s">&quot;Incrementing MAX_INTEGER will result in overflow!&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">param</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following test uses real implementations of the the different components.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInc</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">(</span><span class="k">new</span> <span class="n">AnotherComponentImpl</span><span class="o">()).</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The question is what if:</p>

<ol>
<li><code>AnotherComponentImpl</code> is not ready yet</li>
<li><code>AnotherComponentImpl</code> depends itself on external services or specific hardware resources</li>
<li><code>AnotherComponentImpl</code> has non-deterministic behaviors.</li>
</ol>


<h2>Dummy objects</h2>

<p>Dummy objects are meant to satisfy compile-time check and runtime execution. Dummies do not take part to the test scenario.
Some method signatures of the CUT may require objects as parameters. If neither the test nor the CUT care about these objects, we may choose to pass in a Dummy Object. This can be a null reference, an empty object or a constant. Dummy objects are passed around (to dependencies for instance) but never actually used. Usually they are just used to fill parameter lists. They are meant to replace input/output parameters of the components that the CUT interacts with.</p>

<p>In the current example, the parameter <code>delta</code> of the <code>doBusiness</code> method can be set to <code>null</code> or any <code>Integer</code> value without interfering with the test. Of course, this might be different for another test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testInc</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">(</span><span class="k">new</span> <span class="n">AnotherComponentImpl</span><span class="o">()).</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="kc">null</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Stub objects</h2>

<p>Stub objects provide simple answers to the CUT invocations. It does answer to scenarii that are not foreseen by the current test. In other terms it is a simplified fake object. Stub objects may trigger paths in the CUT that would otherwise not been executed.</p>

<p>The next figure presents a test that relies on a test stub. First, the test case setups a stub object. This object responds to the expected CUT invokation in order to enact a given scenario. This is very useful to check indirect inputs with seldom values.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestSTUB.png' width='' height='' alt='Test setup that uses a test stub' title='Test setup that uses a test stub'><span class='caption-text'>Test setup that uses a test stub</span></span></p>

<p>Back to the example, the following program illustrates how to use a stub to check specific indirect inputs.
This stub shows that the CUT relies on the fact that <code>AnotherComponent</code> does not return <code>null</code>, as it
would otherwise raise a <code>NullPointerException</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherComponentStub</span> <span class="kd">implements</span> <span class="n">AnotherComponent</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">inc</span><span class="o">(</span><span class="n">Integer</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIncWhenAnotherComponentReturnsNull</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">//Without any modification of the CUT implement, this would raise an exception</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">(</span><span class="k">new</span> <span class="n">AnotherComponentStub</span><span class="o">()).</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Fake objects</h2>

<p>Fake objects have working implementations, but  they may simplify some behaviors. This makes them not suitable for prime time. The idea is that the object actually displays some real behavior but not everything. While a Fake Object is typically built specifically for testing, it is not used as either a control point or an observation point by the test. The most common reasons for using fake objects is that the real component is not available yet, is too slow or cannot be used during tests because of side effects.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestFAKE.png' width='' height='' alt='Test setup that uses a fake' title='Test setup that uses a fake'><span class='caption-text'>Test setup that uses a fake</span></span></p>

<p>The following fake simulates most of the behaviors except for the limits (MAX_INTEGER, null, etc&#8230;)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherComponentFake</span> <span class="kd">implements</span> <span class="n">AnotherComponent</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">inc</span><span class="o">(</span><span class="n">Integer</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">param</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As the fake covers many scenarios, it can be used to test the general behavior of the CUT.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIncWhenAnotherComponentIsFake</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">CUT</span> <span class="n">cut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">(</span><span class="k">new</span> <span class="n">AnotherComponentFake</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(123) != 124&quot;</span><span class="o">,</span> <span class="mi">124</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Mock objects</h1>

<p>Partially implements the interface and provides a way to verify that the calls to the mock objects validate the specification.
Mock objects are pre-programmed with expectations that form a specification of the calls they are expected to receive.
In fact mocks are a certain kind of stub or fake. However, the additional feature mock objects offer on top of acting as simple stubs or fakes is that they provide a flexible way to specify more directly how your function under test should actually operate. In this sense they also act as a kind of recording device: They keep track of which of the mock object&#8217;s methods are called, with what kind of parameters, and how many times.</p>

<p>Whenever the assertions are made on the fake object and not the CUT, then it is a mock.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestMOCK.png' width='' height='' alt='Test setup that uses a mock' title='Test setup that uses a mock'><span class='caption-text'>Test setup that uses a mock</span></span></p>

<p>The following example uses <a href="https://code.google.com/p/mockito/">Mockito</a> to provide easy Mocking. Note that the last assertion <code>Mockito.verify</code> checks whether the mock was called with a given parameters. In other words, we check that the CUT did not filter the input parameter.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ch</span><span class="o">.</span><span class="na">demo</span><span class="o">.</span><span class="na">business</span><span class="o">.</span><span class="na">service</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CUTTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Mock</span>
</span><span class='line'>  <span class="n">AnotherComponent</span> <span class="n">ac</span><span class="o">;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nd">@InjectMocks</span>
</span><span class='line'>  <span class="n">CUT</span> <span class="n">cut</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CUTImpl</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testIncWhenAnotherComponentReturnsNull</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">ac</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_INTEGER</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_INTEGER</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>      <span class="n">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">ac</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
</span><span class='line'>      <span class="n">Mockito</span><span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="n">ac</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">123</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="mi">124</span><span class="o">);</span>
</span><span class='line'>      
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(Integer.MIN_INTEGER) != Integer.MIN_INTEGER + 1&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_INTEGER</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MIN_INTEGER</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(3) != 4&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">&quot;inc(123) != 124&quot;</span><span class="o">,</span> <span class="mi">124</span><span class="o">,</span> <span class="n">cut</span><span class="o">.</span><span class="na">inc</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//Verifies that the method inc of AnotherComponent was called with parameter Integer.MAX_INTEGER</span>
</span><span class='line'>        <span class="n">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">ac</span><span class="o">).</span><span class="na">inc</span><span class="o">(</span><span class="n">Matchers</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_INTEGER</span><span class="o">));</span>
</span><span class='line'>        <span class="c1">//Verifies that the inc method has been called three times.</span>
</span><span class='line'>        <span class="n">Mockito</span><span class="o">.</span><span class="na">verify</span><span class="o">(</span><span class="n">ac</span><span class="o">,</span> <span class="n">Mockito</span><span class="o">.</span><span class="na">times</span><span class="o">(</span><span class="mi">3</span><span class="o">)).</span><span class="na">inc</span><span class="o">(</span><span class="n">anyInt</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Test Spy</h2>

<p>According to Meszaros [2], a test spy is basically a recorder that is able to save the interactions between the CUT and the spy for later verifications.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TestSPY.png' width='' height='' alt='Test setup that uses a test spy' title='Test setup that uses a test spy'><span class='caption-text'>Test setup that uses a test spy</span></span></p>

<p>On the other hand, <a href="https://code.google.com/p/mockito/">Mockito</a> considers that a spy is an real implementation in which you change only some specific behaviors. Instead of specifying every behavior one by one, you take an existing object that does most of it and you only change very specific behaviors.</p>

<h2>Conclusion</h2>

<p>To sum up:</p>

<ul>
<li>A dummy is just there to enable compilation and is not supposed to be part of the test.</li>
<li>A fake is a partial implementation that can be used either in a component test or in a deployed setting.</li>
<li>A mock is a partial implementation that enables asserting on the component interactions.</li>
<li>A spy is either a recorder for later use or a proxy on a real implementation that is used to override some specific behaviors.</li>
</ul>


<h2>Bibliography</h2>

<ul>
<li>[1] Martin Fowler <a href="http://martinfowler.com/articles/mocksArentStubs.html">Mock aren&#8217;t stubs</a></li>
<li>[2] Meszaros, Gerard (2007). xUnit Test Patterns: Refactoring Test Code. Addison-Wesley. ISBN 978-0-13-149505-0.</li>
<li>[3] <a href="https://storage.googleapis.com/gtb/TotT-2008-06-12.pdf">Friends you can depend on</a></li>
<li>[4] <a href="http://en.wikipedia.org/wiki/Mock_object">Wikipedia Mock Object</a></li>
<li>[5] <a href="http://en.wikipedia.org/wiki/Test_double">Wikipedia Test Doubles</a></li>
<li>[6] <a href="http://en.wikipedia.org/wiki/Fake_object">Wikipedia Fakes</a></li>
<li>[7] <a href="http://en.wikipedia.org/wiki/Test_stubs">Wikipedia Stubs</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/04/18/testing-levels/">Testing Levels</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-04-18T10:52:00+02:00" pubdate data-updated="true">Apr 18<span>th</span>, 2014</time>
        
           | <a href="/blog/2014/04/18/testing-levels/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2014/04/18/testing-levels/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Introduction</h2>

<p>In this post, I would like to discuss number of definitions around the testing activity. Having these definitions in mind helps to organize this crucial activity. In a previous post, I discussed the difference between <a href="">verification and validation</a>. If the difference is not clear to you, please have a look at it prior reading this post.</p>

<p>Let me start with the definition of what is testing. Software testing helps to measure the quality of a software in terms of defects. It is crucial to understand that
&#8220;testing shows the presence, not the absence of bugs&#8221; [1].</p>

<p>This comes from the fact that exhaustive testing is not possible  due to a phenomena called the state space explosion [2]. The idea is that doing exhaustive testing would require a structure in memory that remembers all the tested states of the system. A state of the system being the concatenation of its variables. For instance, let us take a program that has two variables:
- an integer (4 bytes = 32 bits)
- an array of ASCII characters of length 10 (10 bytes =  80 bits)
The number of states to explore is  2<sup>112</sup> ~ 5x10<sup>33</sup> states (remember that the number of atoms in the observable universe is 10<sup>80</sup>) and the required amount of memory would be 7.2x10<sup>22</sup> Terabytes. Although many optimizations can be brought to a brute force approach [1,2], the problem remains huge. Therefore, exhaustive testing is not an option.</p>

<p>Another important point about defects is to understand from where they originate.
A (software) defect originates in a human <strong>mistake</strong> (e.g., a misunderstanding) that produces a <strong>fault</strong> (i.e., a defect, a bug). Under certain circumstances, the faulty code will end up doing something unexpected with respect to the user requirements. This is called a <strong>failure</strong>.</p>

<p>To sum up, there is the following causality chain : Mistake &#8211;> Fault &#8211;> Failure.</p>

<p>This demonstrates that testing is not only a matter of detecting the failure but that it can be done earlier. Of course the earlier the defect is detected the cheaper is it to address it. For instance, informing the developer about the business may avoid a mistake. Using automated code checker may detect some faults.</p>

<h2>Testing dimensions</h2>

<p>Testing can be characterized in terms of dimensions. These dimensions help to categorized the test types.</p>

<ol>
<li><p>What : This dimension describes what are the objectives of the tests. Test objectives vary from one approach to another.
Usually the objectives are the verification or  the validation of functionnal (e.g., portfolio performance) and non-functionnal (e.g., performance, security) requirements.</p></li>
<li><p>How : This defines how the test objective is achieved. For instance, tests can be either static or dynamic, in isolation or in integration, or knowing the implementation.</p></li>
<li><p>When : Test can be executed at different moment of the development process. For instance, component testing can be done very early in the development process, while user acceptance test can only be performed when the software is ready for prime time.</p></li>
<li><p>Who : Different kind of tests are run by different people (e.g., developer, testers , end-users, &#8230;) For instance, component testing can be done by programmers, while user acceptance test are performed by end-users.</p></li>
</ol>


<h3>Testing level</h3>

<p>Testing levels have been addressed in a number of publications, blog posts and talks [3], [4], [5]. Testing levels describe test types by their quantity and when they occur in the software lifecycle. At the base, tests are done early in the development and extensively. The higher the level, the later the test occurs in the lifecycle. Moreover, while lower levels are usually done the the software supplier, higher levels tend to be performed by the customer.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/TESTING_LEVELS.png' width='' height='' alt='Testing Levels' title='Testing Levels'><span class='caption-text'>Testing Levels</span></span></p>

<h4>Static testing</h4>

<p>This sort of testing do not require to execute the code. Tools crawl the code and look for patterns that can lead to fault. Example of tools are <a href="http://findbugs.sourceforge.net/">Findbugs</a>, <a href="http://sourceforge.net/p/pmd/bugs/">PMD</a>. This kind of testing is especially useful to detect complex mistakes involving thread-safety or typing.</p>

<h4>Unit testing</h4>

<p>Test objects are isolated components (classes, packages, programs, &#8230;)  To promote isolation, test objects such as stubs, fakes or mocks can be used. for more information see <a href="">Fakes, Stubs, Dummies, Mocks and all that</a>. These tests happen during development and discovered bugs are fixed right away. Therefore, the management overhead is minimal. Both verification of functional and non.functional requirements can be addressed.</p>

<h4>Integration testing</h4>

<p>Integration testing (a.k.a. assembly testing) verifies the integration between several components. At this level, some components can still be faked to ease deployment and isolation.
Both verification of functional and non.functional requirements can be addressed.</p>

<h4>API testing</h4>

<p>This is the first test level that addresses validation instead of verification. It tests the software using its contracts (API). This is pure blackbox testing usually by using webservices. Tools such as SoapUI are very good at testing the software API and semantics.</p>

<h4>GUI testing</h4>

<p>This level acts on the graphical user interface. Example of tools are <a href="http://www.seleniumhq.org/">Selenium</a></p>

<h4>System testing</h4>

<p>This test level aims the system as a whole with every internal and external components.
Both verification of functional and non.functional requirements can be addressed.</p>

<h4>Acceptance testing</h4>

<p>Both verification of functional and non.functional requirements can be addressed.</p>

<h3>Bibliography</h3>

<p>[1 ]Dijkstra (1969) J.N. Buxton and B. Randell, eds, Software Engineering Techniques, April 1970, p. 16. Report on a conference sponsored by the NATO Science Committee, Rome, Italy, 27–31 October 1969. Possibly the earliest documented use of the famous quote.</p>

<p>[2] Antti Valmari. The state explosion problem. In Wolfgang Reisig and Grzegorz Rozenberg, editors, Lectures on Petri Nets I: Basic
Models, volume 1491 of Lecture Notes in Computer Science, pages 429D528. Springer, 1998.</p>

<p>[3] Martin Fowler. TestPyramid. http://martinfowler.com/bliki/TestPyramid.html</p>

<p>[4] Alister Scott. Yet another software testing pyramid. http://watirmelon.com/2011/06/10/yet-another-software-testing-pyramid/
[5] Alister Scott. Introducing the software testing ice-cream cone (anti-pattern). http://watirmelon.com/2012/01/31/introducing-the-software-testing-ice-cream-cone/</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/31/jee6-tutorial/">JEE6 Tutorial</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-31T09:43:00+01:00" pubdate data-updated="true">Dec 31<span>st</span>, 2012</time>
        
           | <a href="/blog/2012/12/31/jee6-tutorial/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2012/12/31/jee6-tutorial/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I hereby start a series of tutorial on the major (IMHO) JEE 6 features. As a lecturer, I teach the JEE stack at the University of Geneva. This tutorial represents most of the topics that I cover during the EJB, CDI, and JPA lessons.</p>

<p>There already exists a bunch of very complete tutorials and books on the subject. Let me cite the excellent <a href="http://docs.oracle.com/javaee/6/tutorial/doc/" title="Oracle's official JEE6 tutorial">Oracle JEE tutorial</a> and
Antonio Goncalvez&#8217;s books that are available both in <a href="http://www.amazon.com/Beginning-GlassFish-Experts-Voice-Technology/dp/143022889X/ref=sr_1_1?ie=UTF8&amp;qid=1356945347&amp;sr=8-1&amp;keywords=JEE6+antonio+goncalves" title="Antonio's Book in English">English</a> and in <a href="http://www.amazon.com/Java-EE6-GlassFish-Antonio-Goncalves/dp/2744024236/ref=sr_1_fkmr2_1?s=books&amp;ie=UTF8&amp;qid=1356945440&amp;sr=1-1-fkmr2&amp;keywords=JEE6+et+glassfish" title="Antonio's Book in French">French</a>. For advanced JEE developers, Adam Bien&#8217;s <a href="http://press.adam-bien.com/real-world-java-ee-night-hacks-dissecting-the-business-tier.htm" title="Real World Java EE Night Hacks--Dissecting the Business Tier">Real World Java EE Night Hacks</a> is a must read.</p>

<p>As the <a href="http://jcp.org/aboutJava/communityprocess/final/jsr318/index.html" title="EJB 3.1 specification">EJB 3.1 specification</a> is rather well written, I encourage people to read it or at least to look at specifics when needed.</p>

<p>To support this tutorial you can find a JEE6-Demo on GitHub. It contains a simple enterprise application that demonstrates many of the
aspects I discuss hereafter. The first step of this tutorial is to prepare the environment:</p>

<p>1) Install GlassFish and integrate it to your favorite development environment (eclipse in my case). You can get GlassFish from <a href="http://glassfish.java.net/downloads/3.1.2.2-final.html" title="Glassfish Download Page">here</a>. Grab the zip version and install it by unzipping the archive.</p>

<p>2) Run GlassFish and check that it works. Locate the script named <code>asadmin</code> in the <code>bin</code> directory, start it and at the prompt, execute the command <code>start-domain</code>. This starts the GlassFish instance.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>localhost:bin ~$ ./asadmin
</span><span class='line'>Use "exit" to exit and "help" for online help.
</span><span class='line'>asadmin&gt; start-domain
</span><span class='line'>Waiting for domain1 to start ...
</span><span class='line'>Successfully started the domain : domain1
</span><span class='line'>domain  Location: ~/Applications/glassfish3/glassfish/domains/domain1
</span><span class='line'>Log File: ~/Applications/glassfish3/glassfish/domains/domain1/logs/server.log
</span><span class='line'>Admin Port: 4848
</span><span class='line'>Command start-domain executed successfully.
</span><span class='line'>asadmin&gt; </span></code></pre></td></tr></table></div></figure>


<p>Now the server is started and it listens to the ports 8080 and 4848. The first being the application port while the second is the administrative console.</p>

<p>Start a browser and navigate to <a href="http://localhost:4848/common/index.jsf"><code>http://localhost:4848/common/index.jsf</code></a>. Depending of the server configuration, you may have to log in.</p>

<p>3) Do a Git checkout of the jee6-demo project that is available <a href="https://github.com/hostettler/JEE6-Demo">here</a>.</p>

<p>4) Perform a <code>mvn clean install</code> at the project root</p>

<p>This compiles the project and builds the artifacts. It should end up in something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[INFO] ------------------------------------------------------------------------
</span><span class='line'>[INFO] Reactor Summary:
</span><span class='line'>[INFO] 
</span><span class='line'>[INFO] jee6-demo ......................................... SUCCESS [0.480s]
</span><span class='line'>[INFO] Service Layer ..................................... SUCCESS [3.650s]
</span><span class='line'>[INFO] Presentation Layer ................................ SUCCESS [1.725s]
</span><span class='line'>[INFO] Application ....................................... SUCCESS [0.663s]
</span><span class='line'>[INFO] ------------------------------------------------------------------------
</span><span class='line'>[INFO] BUILD SUCCESS
</span><span class='line'>[INFO] ------------------------------------------------------------------------
</span><span class='line'>[INFO] Total time: 6.923s
</span><span class='line'>[INFO] Finished at: Sun Jan 06 16:41:29 CET 2013
</span><span class='line'>[INFO] Final Memory: 19M/81M
</span><span class='line'>[INFO] --------------------------------------------------------------------</span></code></pre></td></tr></table></div></figure>


<p>5) In the GlassFish installation directory, there is a <code>javadb</code> directory that contains, Derby, a Java-based database. Starts the network server:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;$ pwd
</span><span class='line'>/~/Applications/glassfish3/javadb/bin
</span><span class='line'>localhost:bin ~$ ./startNetworkServer
</span><span class='line'>Mon Jan 07 06:02:54 CET 2013 : Security manager installed using the Basic server security policy.
</span><span class='line'>Mon Jan 07 06:02:54 CET 2013 : Apache Derby Network Server - 10.8.1.2 - (1095077) started and ready to accept connections on port 1527</span></code></pre></td></tr></table></div></figure>


<p>The database server listens to the port <code>1527</code>.</p>

<p>Now that the database is started. It is time to populate the database with the database creation scripts as well as some data.
In the project, under the ejb components, there is a sql file that initializes the database structure as well as some data.</p>

<p>Derby provides a command line tool called <code>ij</code> to connect to the database and to execute sql scripts:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>localhost:bin ~$ pwd
</span><span class='line'>~/Applications/glassfish3/javadb/bin
</span><span class='line'>localhost:bin ~$./ij ~/git/jee6demo/jee6-ejb/src/main/resources/sql/createStudentsDB_DERBY.sql
</span><span class='line'>...
</span><span class='line'>ij&gt; QUIT;</span></code></pre></td></tr></table></div></figure>


<p>Now the database is ready to use.</p>

<p>6) Create a datasource in GlassFish that points to the  database server that has been started previously:</p>

<p>First, let us create a connection pool:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-jdbc-connection-pool  --datasourceclassname=org.apache.derby.jdbc.ClientDataSource40 --restype=javax.sql.DataSource --property user=DEV:DatabaseName=StudentsDB:Password=DEV:ServerName=localhost:PortNumber=1527:create=true StudentsDB
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>222JDBC connection pool StudentsDB created successfully.
</span><span class='line'>Command create-jdbc-connection-pool executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>The connection pool provides a &#8230; pool of connection that is managed by the application server. A major benefit being that the developer does not have to open and close connections.
The server opens n connections and allocate them on demand. It ensures that there will not be 1000 open connections to the database thus improving the performances.
Then, we create a datasource that uses the previous connection pool:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-jdbc-resource --connectionpoolid StudentsDB --enabled jdbc/StudentsDS
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>JDBC resource jdbc/StudentsDS created successfully.
</span><span class='line'>Command create-jdbc-resource executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>7) Configure the messaging resources.</p>

<p>The tutorial uses JMS (Java Messaging Service) to implement the publish/subscribe pattern. The following script builds a connection factory for JMS queues.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-jms-resource --restype javax.jms.QueueConnectionFactory --enabled  MyConnectionFactory
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Connector resource MyConnectionFactory created.
</span><span class='line'>Command create-jms-resource executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>The following snippet declares the JMS queue. That is the message endpoint.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-jms-resource --restype javax.jms.Queue MyQueue
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Administered object MyQueue created.
</span><span class='line'>Command create-jms-resource executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>8) Configure the security</p>

<p>Authentication and authorization is another major feature that is provided by the application server.
First let us create the realm with two groups user and manager.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-auth-realm --classname com.sun.enterprise.security.auth.realm.file.FileRealm  --property assign-groups=manager,user:file=jee6-tutorial-file-realm:jaas-context=fileRealm jee6-tutorial-file-realm
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Command create-auth-realm executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>Then, we add a user that belongs two groups: user and manager.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-file-user --authrealmname jee6-tutorial-file-realm --groups user:manager user1
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Enter the user password&gt; 
</span><span class='line'>Enter the user password again&gt; 
</span><span class='line'>Command create-file-user executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>The second user only belongs to the group user.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; create-file-user --authrealmname jee6-tutorial-file-realm --groups user user2
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Enter the user password&gt; 
</span><span class='line'>Enter the user password again&gt; 
</span><span class='line'>Command create-file-user executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>9) Deploy the application</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>asadmin&gt; deploy ~/git/jee6demo/jee6-ear/target/jee6-demo-ear-1.0.0-SNAPSHOT.ear
</span><span class='line'>Authentication failed with password from login store: ~/.asadminpass
</span><span class='line'>Enter admin password for user "admin"&gt; 
</span><span class='line'>Application deployed with name jee6-demo-ear-1.0.0-SNAPSHOT.
</span><span class='line'>Command deploy executed successfully.</span></code></pre></td></tr></table></div></figure>


<p>10) Test the application</p>

<p>Once deployed, serve to <a href="http://localhost:8080/jee6-demo-web/facade/studentService/all"><code>http://localhost:8080/jee6-demo-web/facade/studentService/all</code></a> and you should get:
You must log yourself with one of the use that you created at step 8).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;studentsDto</span> <span class="na">xmlns:ns2=</span><span class="s">&quot;http://ch.demo.app&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;students&gt;</span>
</span><span class='line'>      <span class="nt">&lt;id&gt;</span>0<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>      <span class="nt">&lt;last_name&gt;</span>Doe<span class="nt">&lt;/last_name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;firstName&gt;</span>John<span class="nt">&lt;/firstName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;birthDate&gt;</span>1965-12-10T00:00:00+01:00<span class="nt">&lt;/birthDate&gt;</span>
</span><span class='line'>      <span class="nt">&lt;phoneNumber&gt;</span>
</span><span class='line'>      <span class="nt">&lt;areaCode&gt;</span>0<span class="nt">&lt;/areaCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;countryCode&gt;</span>0<span class="nt">&lt;/countryCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;number&gt;</span>0<span class="nt">&lt;/number&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/phoneNumber&gt;</span>
</span><span class='line'>      <span class="nt">&lt;address&gt;</span>
</span><span class='line'>          <span class="nt">&lt;number&gt;</span>22<span class="nt">&lt;/number&gt;</span>
</span><span class='line'>          <span class="nt">&lt;street&gt;</span>wisteria street<span class="nt">&lt;/street&gt;</span>
</span><span class='line'>          <span class="nt">&lt;city&gt;</span>Downtown<span class="nt">&lt;/city&gt;</span>
</span><span class='line'>          <span class="nt">&lt;postalCode&gt;</span>34343<span class="nt">&lt;/postalCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/address&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/students&gt;</span>
</span><span class='line'>  <span class="nt">&lt;students&gt;</span>
</span><span class='line'>      <span class="nt">&lt;id&gt;</span>1<span class="nt">&lt;/id&gt;</span>
</span><span class='line'>      <span class="nt">&lt;last_name&gt;</span>Doe<span class="nt">&lt;/last_name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;firstName&gt;</span>Jane<span class="nt">&lt;/firstName&gt;</span>
</span><span class='line'>      <span class="nt">&lt;birthDate&gt;</span>1985-12-10T00:00:00+01:00<span class="nt">&lt;/birthDate&gt;</span>
</span><span class='line'>      <span class="nt">&lt;phoneNumber&gt;</span>
</span><span class='line'>      <span class="nt">&lt;areaCode&gt;</span>0<span class="nt">&lt;/areaCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;countryCode&gt;</span>0<span class="nt">&lt;/countryCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;number&gt;</span>0<span class="nt">&lt;/number&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/phoneNumber&gt;</span>
</span><span class='line'>      <span class="nt">&lt;address&gt;</span>
</span><span class='line'>          <span class="nt">&lt;number&gt;</span>22<span class="nt">&lt;/number&gt;</span>
</span><span class='line'>          <span class="nt">&lt;street&gt;</span>wisteria street<span class="nt">&lt;/street&gt;</span>
</span><span class='line'>          <span class="nt">&lt;city&gt;</span>Downtown<span class="nt">&lt;/city&gt;</span>
</span><span class='line'>          <span class="nt">&lt;postalCode&gt;</span>34343<span class="nt">&lt;/postalCode&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/address&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/students&gt;</span>
</span><span class='line'><span class="nt">&lt;/studentsDto&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you are ready to follow me in the EJB world.</p>

<p>The tutorial is organized in three parts. First, in this post, we will look at the EJB stack. In following posts, we will cover both the Context and Dependency Injection and the Java Persistence API.</p>

<h1><a id="ejbs"></a>EJBs</h1>

<p>The EJB API provides useful non-functional services to Java Enterprise Applications such as transactionality, security, pooling, and thread-safety.
Server side components that implement this API and wrap up business logic are called Enterprise Java Beans (EJBs). While the first versions were infamously known for the boilerplate code as well as their low testability,
EJB 3.x are rather easy to use thanks to a new design paradigms called <a href="http://en.wikipedia.org/wiki/Convention_over_configuration" title="Convention over Configuration on Wikipedia">Convention over Configuration</a>. The idea is to specify unconventional aspects rather than everything. This dramatically reduces the boilerplate code and improves readability.</p>

<p>Furthermore, the massive usage of annotations instead of XML descriptor greatly improves the productivity. In the sequel, I mostly rely on annotations. Nevertheless, every annotation has its counterpart in a configuration descriptor that is called <code>ejb-jar.xml</code>.</p>

<blockquote><p>In case there is two different value for the same property, remember that one from the <code>ejb-jar.xml</code> always overrides the annotation.</p></blockquote>

<p>Enterprise Java Beans are of three kinds:</p>

<ul>
<li><strong>Session Beans</strong>: components whose execution is triggered by a client call. The call can be local (within the JVM) or remote (by another JVM).</li>
<li><strong>Message Beans</strong>: execution is triggered by a message and the business logic is processed asynchronously. Please note that, since JEE6 there are other (simpler) ways to process logic asynchronously. Nevertheless, Message Beans
remain very useful to implement bus and/or publish-subscribe patterns and to enforce loose coupling between the client and the server component.</li>
<li><strong>Entity Beans</strong>: I will not discuss entity beans as they have been replaced by the <a href="http://jcp.org/aboutJava/communityprocess/final/jsr317/index.html" title="JPA 2.0 specification">JPA 2.0 specification</a>.</li>
</ul>


<h2><a id="sb"></a>Session Beans</h2>

<p>As mentioned previously, session beans (merely) react on client invocation. Henceforth, the bean can either take the client session into account (thus it shares a state between multiple client invocations) or it can treat each call as unrelated.
In the first case, the EJB is called <strong>Stateful</strong> while in the latter it is called <strong>Stateless</strong>.</p>

<h3><a id="slsb"></a>Stateless Session Beans</h3>

<p>Let us start with a <strong>Stateless</strong> bean. The following Java class describes a Stateless EJB.
The most important part is the annotation <code>@Stateless</code> at the top of the class.
This marks the class as an EJB. When the container instantiates this class, it knows that
it is a so-called <strong>Managed Bean</strong>. By this, it means that the container manages the bean&#8217;s lifecycle (e.g., instantiation, passivation). Furthermore, as an EJB, it has access to the container services such as security and transactionality.</p>

<p>The following snippet describes a Stateless Session bean that computes a grade distribution. The method is secured and only authorized to client that have the role <code>user</code> through the <code>@RolesAllowed({ "user" })</code> annotation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceJPAImpl</span> <span class="kd">implements</span> <span class="n">StudentService</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="nd">@RolesAllowed</span><span class="o">({</span> <span class="s">&quot;user&quot;</span> <span class="o">})</span> <span class="c1">// This a role-based security.</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Integer</span><span class="o">[]</span> <span class="nf">getDistribution</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">numberOfAccess</span><span class="o">++;</span>
</span><span class='line'>        <span class="n">Integer</span><span class="o">[]</span> <span class="n">grades</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">[</span><span class="n">n</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">Student</span> <span class="n">s</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">getAll</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">grades</span><span class="o">[(</span><span class="n">s</span><span class="o">.</span><span class="na">getAvgGrade</span><span class="o">().</span><span class="na">intValue</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="n">TOTAL</span> <span class="o">/</span> <span class="n">n</span><span class="o">)]++;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">grades</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'> <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note that the previous EJB implements an interface. An EJB can be local (invokable from within the container),
remote (invokable from another JVM) or both. In the previous case, it is a local interface and therefore the bean is only
invokable locally.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Local</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudentService</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">  * @return an array that contains the distribution of the grades. It</span>
</span><span class='line'><span class="cm">  *         partitions the grades in &quot;n&quot; parts.</span>
</span><span class='line'><span class="cm">  * @param n : number of parts</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kt">int</span><span class="o">[]</span> <span class="nf">getDistribution</span><span class="o">(</span><span class="kd">final</span> <span class="kt">int</span> <span class="n">n</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Adding a remote invocation to the implementation amounts to add an interface that is annotated <code>@Remote</code>.
Of course, the interface may be different and may exposes different services locally and remotely.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Remote</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudentServiceRemote</span> <span class="kd">extends</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">     * @param lastname</span>
</span><span class='line'><span class="cm">     *            of the student</span>
</span><span class='line'><span class="cm">     * @return the student with the given lastname.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">Student</span> <span class="nf">getStudentByLastName</span><span class="o">(</span><span class="n">String</span> <span class="n">lastname</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The implementation must be changed as follow to be remotely invokable:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceJPAImpl</span> <span class="kd">implements</span> <span class="n">StudentService</span><span class="o">,</span> <span class="n">StudentServiceRemote</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>To use this EJB, we need a client code. The easiest possible interaction is either via a JAX-RS service or via a servlet.
In the JEE6-Demo, under the JEE6-WEB project the JAX-RS facade is called <code>StudentFacade.java</code>. It implements a JAX-RS facade over the <code>StudentService</code>.</p>

<p>The method <code>getDistribution()</code> uses the student service that is injected via <code>@EJB</code> in the
facade. <a href="http://en.wikipedia.org/wiki/Dependency_injection" title="Dependency Injection on Wikipedia">Dependency injection</a>  is now a first class citizen in the JEE6 stack.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@ApplicationScoped</span> <span class="c1">// This sets the scope to application level</span>
</span><span class='line'><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/studentService&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceFacade</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="nd">@EJB</span>
</span><span class='line'>  <span class="n">StudentService</span> <span class="n">studentService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@GET</span>
</span><span class='line'>  <span class="nd">@Produces</span><span class="o">({</span> <span class="s">&quot;application/xml&quot;</span><span class="o">,</span> <span class="s">&quot;application/json&quot;</span> <span class="o">})</span>
</span><span class='line'>  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;distribution&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">getDistribution</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Integer</span><span class="o">[]</span> <span class="n">distrib</span> <span class="o">=</span> <span class="n">studentService</span><span class="o">.</span><span class="na">getDistribution</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="k">new</span> <span class="n">DistributionDto</span><span class="o">(</span><span class="n">distrib</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following snippet illustrates the injection of a Stateless EJB into a Servlet.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">&quot;/student&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@EJB</span>
</span><span class='line'>  <span class="n">StudentService</span> <span class="n">studentService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()</span>
</span><span class='line'>              <span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;There are #&quot;</span> <span class="o">+</span> <span class="n">studentService</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; students in the database&quot;</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doPost</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">arg1</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">doGet</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, implementing EJBs (and invoking them) is rather easy. So far, we did not talk much about transactionality and security so you might wonder why using EJBs for such simple business services. The answer is pooling and thread-safety. As the container manages a pool of EJBs, it handles the invocation queue and you do not have to manager re-entrance and thread-safety.</p>

<blockquote><p>Remember that there is a <strong>one to many relationship</strong> between a stateless session bean and the clients. In other words, one instance may manage different clients. Hence, there must be not field that represent a client state in a <strong>Stateless</strong> EJB because there is no guarantee that a given client will get the same SLSB accross two invokations. Nevertheless, within a given invokation the client is guaranteed to be the only user.</p></blockquote>

<p>Consider the following exercises.</p>

<blockquote><p><em>Exercise 1:</em> Add a new method to the StudentService service that computes the standard deviation and use this method in the JAX-RS facade.</p>

<p><em>Exercise 2:</em> Add a counter that is incremented each and every time a method is invoked. Print out the thread-id (and if possible the session-id) and explain why the so-called stateless beans must be without state. Add a rest service to interface this method.</p></blockquote>

<h4><a id="trx"></a>Transactionality</h4>

<p><a href="http://en.wikipedia.org/wiki/Database_transaction" title="Transactions on wikipedia">Transactions</a> are important concepts when dealing with enterprise applications. It is of vital importance that whenever something goes wrong, the transaction is roll-backed. This preserves the <a href="http://en.wikipedia.org/wiki/ACID" title="ACID in wikipedia">ACID</a> properties. Managing database transactions with JDBC is complex to say the least. Remember that we often have to manage transactions over several databases and even between databases and messaging queues. If the processing of a message leads to a database exception, we might want to put the message back in the queue.</p>

<p>Lucky for us, JEE 6 manages (almost) everything by itself. By default a bean is transactional and each method either reuse a running transaction or creates a new one if necessary.</p>

<blockquote><p>By default the transaction (or transaction context) is propagated to other business methods that are called from within a transactional method.</p></blockquote>

<p>In JEE, there is two types of transaction management:</p>

<ul>
<li><p><strong>Bean Managed</strong> : In this case the bean is annotated with <code>@TransactionManagement(TransactionManagementType.BEAN)</code>. In this mode, the developer must manage the transaction himself.</p></li>
<li><p><strong>Container Managed</strong>: this is the default behavior and it corresponds to marking the bean <code>@TransactionManagement(TransactionManagementType.CONTAINER)</code>. This mode is called <strong>Container Managed Transaction Demarcation</strong>. This idea is that every public method is transactional and is marked as <code>@Required</code>.</p></li>
</ul>


<p>The following snippet shows how to use bean demarcation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MessageDriven</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@TransactionManagement</span><span class="o">(</span><span class="n">TransactionManagementType</span><span class="o">.</span><span class="na">BEAN</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentRegistrationService</span> <span class="kd">implements</span> <span class="n">MessageListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PersistenceContext</span>
</span><span class='line'>  <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">inMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">TextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">begin</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>          <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextMessage</span><span class="o">)</span> <span class="n">inMessage</span><span class="o">;</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;MESSAGE BEAN: Message received: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">commit</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and now the exact same class using container demarcation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MessageDriven</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentRegistrationService</span> <span class="kd">implements</span> <span class="n">MessageListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PersistenceContext</span>
</span><span class='line'>  <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">inMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">TextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>          <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextMessage</span><span class="o">)</span> <span class="n">inMessage</span><span class="o">;</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;MESSAGE BEAN: Message received: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because the previous snippet relies on the default convention, it is equivalent to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MessageDriven</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'><span class="nd">@TransactionManagement</span><span class="o">(</span><span class="n">TransactionManagementType</span><span class="o">.</span><span class="na">CONTAINER</span><span class="o">)</span>
</span><span class='line'><span class="nd">@TransactionAttribute</span><span class="o">(</span><span class="n">TransactionAttributeType</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentRegistrationService</span> <span class="kd">implements</span> <span class="n">MessageListener</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Inject</span> <span class="c1">// Let&#39;s ignore this for the moment</span>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">transient</span> <span class="n">Logger</span> <span class="n">logger</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PersistenceContext</span>
</span><span class='line'>  <span class="n">EntityManager</span> <span class="n">em</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Resource</span> <span class="c1">// Let&#39;s ignore this for the moment</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">MessageDrivenContext</span> <span class="n">mdbContext</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">inMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">TextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>          <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextMessage</span><span class="o">)</span> <span class="n">inMessage</span><span class="o">;</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;MESSAGE BEAN: Message received: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
</span><span class='line'>          <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">em</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">().</span><span class="na">rollback</span><span class="o">();</span>
</span><span class='line'>          <span class="o">...</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In other terms, it uses container managed transaction demarcation <code>@TransactionManagement(TransactionManagementType.CONTAINER)</code>.
Moreover, each and every public method either reuses an existing transaction or creates a new one if none has been started <code>@TransactionAttribute(TransactionAttributeType.REQUIRED)</code></p>

<p>The <code>@TransactionAttribute</code> annotation can also be put directly on the method. Valid options are:</p>

<ul>
<li><code>REQUIRED</code>: if there is an existing transaction then it reuses it, otherwise it creates a new one.</li>
<li><code>REQUIRES_NEW</code>: it always creates a new transaction</li>
<li><code>NEVER</code>: if there is an existing transaction then it fails</li>
<li><code>MANDATORY</code>: if there is an existing transaction then it reuses it, otherwise it fails</li>
<li><code>NOT_SUPPORTED</code>: If there is a transaction then it suspends it and it does not propagate the transaction to other business methods, otherwise it does nothing.</li>
<li><code>SUPPORTS</code>: If a transaction exists then it works as for <code>REQUIRED</code>, otherwise it works as for <code>NOT_SUPPORTED</code>.</li>
</ul>


<p>Consider the following exercises.</p>

<blockquote><p><em>Exercise 3:</em> Test the different types of transaction attribute and observe their respective behavior.</p>

<p><em>Exercise 4:</em> Are the snippets 1 and 2 semantically equivalent?</p>

<p><em>Exercise 5:</em> Mix the two types of transaction management.</p></blockquote>

<h4><a id="secu"></a>Security</h4>

<p>Another great feature of EJBs is their ability for declarative authorization and the integration in the JAAS framework. JAAS is the Java Authentication and Authorization Service
It provides unified services to access user directories for user authentication and their authorization. As the client is already authenticated, at the EJB level, only authorization matters.</p>

<p>After authentication, a principal (e.g., user name, role) is set in the context. This principal is used for authorization.</p>

<p>The main annotation is <code>@RolesAllowed</code> followed by a list of authorized roles. As an example, look at the method <code>getDistribution</code> of <code>StudentServiceJPAImpl.java</code>. The method is only allowed for client that belongs to the group/role <code>user</code>.</p>

<p>Sometimes, a method of an EJB is not executed in the context of an authenticated user or the authenticated user has not enough credentials. If it is still important to run the method, you can use the <code>@RunAs</code> annotation. This basically overrides the current security context (and the associated principal) similarly to <code>sudo</code> for UNIX.</p>

<p>In any EJB, it is possible to get the current client session and therefore the principal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Resource</span>
</span><span class='line'><span class="n">SessionContext</span> <span class="n">ctx</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// obtain the principal. </span>
</span><span class='line'>  <span class="n">Principal</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getCallerPrincipal</span><span class="o">();</span>
</span><span class='line'>  <span class="c1">// obtain the name. </span>
</span><span class='line'>  <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">callerPrincipal</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span><span class='line'>  <span class="c1">// Is the caller an admin?</span>
</span><span class='line'>  <span class="n">ctx</span><span class="o">.</span><span class="na">isCallerInRole</span><span class="o">(</span><span class="s">&quot;admin&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 6:</em> Change the method getDistribution to only allow client that belong to the <code>admin</code> group. Log as a user and as an admin, check the servlet as well as the JAX-RS service. What do you observe?</p>

<p><em>Exercise 7:</em> Add a new Role to the application, and use it. Warning, some configurations are vendor specific.</p>

<p><em>Exercise 8:</em> Create a service that uses <code>@RunAs</code> to upgrade the credentials of a standard user in order to call another service that requires the admin level.</p></blockquote>

<h4><a id="callbacks"></a> Callbacks and Interceptors</h4>

<p>Interceptors are used to enhance the business method invocations and the beans&#8217; lifecycle events. Interceptors implements the AOP paradigm.</p>

<p>Interceptors are of two kinds:
- Lifecycle event interceptors such as <code>@PostConstruct</code>, <code>@PostActivate</code>, and <code>@PrePassivate</code>, and <code>@PreDestroy</code> enable to add logic when the bean is created or destroyed.
- Call-based interceptors that relies on the <code>@AroundInvoke</code> annotation.</p>

<p>In the first case, adding the annotation before the method declaration is enough. It will then be called when the lifecycle event occurs.
In the latter case, in addition to the annotation the developer must configure the <code>ejb-jar.xml</code> file.</p>

<p>Here is a simple interceptor that prints out the time consumed by a method call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@AroundInvoke</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Object</span> <span class="nf">intercept</span><span class="o">(</span><span class="n">InvocationContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>   <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
</span><span class='line'>   <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">StringBuilder</span> <span class="n">str</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&quot;******  &quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">str</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="na">getMethod</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>      <span class="n">str</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; took :&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">str</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
</span><span class='line'>      <span class="n">str</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot; ms  ******&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">mLogger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In addition to the interceptor declaration, it must be activated by mean of either an annotation on the target EJB or via the <code>ejb-jar.xml</code> file. If several interceptors are declared, then the order of declaration is the order of execution: the last is the most nested interceptor.</p>

<p>The following example presents the annotation based declaration.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="nd">@Interceptor</span><span class="o">({</span><span class="n">PerformanceEJBInterceptor</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">StudentServiceJPAImpl</span> <span class="kd">implements</span> <span class="n">StudentService</span><span class="o">,</span> <span class="n">StudentServiceRemote</span> <span class="o">{</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>In the following snippet, the interceptor is applied to all methods whose name is like <code>get*</code> and EJB&#8217;s name is like <code>Student*</code>. It is also possible to specify the parameters&#8217; type in case of overloading.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;assembly-descriptor&gt;</span>
</span><span class='line'> <span class="c">&lt;!-- Default interceptor that will apply to all methods for all beans in deployment --&gt;</span>
</span><span class='line'> <span class="nt">&lt;interceptor-binding&gt;</span>
</span><span class='line'>      <span class="nt">&lt;ejb-name&gt;</span>Student*<span class="nt">&lt;/ejb-name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;method&gt;</span>
</span><span class='line'>           <span class="nt">&lt;method-name&gt;</span>get*<span class="nt">&lt;/method-name&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/method&gt;</span>
</span><span class='line'>      <span class="nt">&lt;interceptor-class&gt;</span>ch.demo.business.interceptors.PerformanceEJBInterceptor<span class="nt">&lt;/interceptor-class&gt;</span>
</span><span class='line'>   <span class="nt">&lt;/interceptor-binding&gt;</span>
</span><span class='line'>   ...
</span><span class='line'><span class="nt">&lt;/assembly-descriptor&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 9:</em> Add an interceptor that for all public methods of <code>StudentServiceJPAImpl.java</code> to increments an overall (common to all clients) usage counter using the annotation based approach.</p>

<p><em>Exercise 10:</em> Do the same, but using the <code>`ejb-jar.xml</code>.</p></blockquote>

<h4><a id="timers"></a> Timers</h4>

<p>Some services are not directly linked to a client session. This is the case for batch processes that must run every x hours. To that end, EJB 3.1 provides the annotation <code>@Schedule</code> to specify how often a service method must be called. This is similar to the CRON  feature on UNIX systems.</p>

<p>The following example runs the method <code>doSomethingUseful</code> every 30 minutes.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Schedule</span><span class="o">(</span><span class="n">minute</span><span class="o">=</span><span class="s">&quot;*/30&quot;</span><span class="o">,</span> <span class="n">hour</span><span class="o">=</span><span class="s">&quot;*&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomethingUseful</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 11:</em>  Add a scheduler that runs a method every minutes to print out the number of students in the database.</p>

<p><em>Exercise 12:</em>  <code>@Schedule</code> is often used in conjunction with <code>@RunAs</code>. Why?</p></blockquote>

<h4><a id="async"></a> Asynchronous calls</h4>

<p>Asynchronous calling means that the control is returned to the caller before the process has been completed. For instance, a batch job that loads 1000 customers description from one database, processes them and finally save them in another database. From a performances point of view, it is better to split the process in x batches and then to wait until every thing is finished. Firstly, if the asynchronous call is made to another EJB, it is possible to leverage the pool to have parallel treatments without managing multi-threading and race conditions. Secondly, as the different call may use different database connections, it will limit the database bottleneck.</p>

<p>To do this, JEE provides the <code>@Asynchronous</code> annotation. Any method that returns either nothing (<code>void</code>) or an instance of type <code>Future&lt;T&gt;</code> can be run asynchronously.</p>

<p>The <code>Future</code> interface exposes the method <code>get</code> that blocks until the job is over.
The following class, exposes the method <code>processJob</code> that runs asynchronously.</p>

<p>The methods <code>processJobs</code> starts 10 times the method processJob and put the resulting <code>Future&lt;String&gt;</code> in an array. Then it iterates of the pool and wait until all calls have returned.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">BatchProcessor</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">processJobs</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;[]</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;[</span><span class="mi">10</span><span class="o">];</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">pool</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">processJob</span><span class="o">(</span><span class="s">&quot;Job #&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">pool</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>    
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@Asynchronous</span>
</span><span class='line'><span class="kd">public</span> <span class="n">Future</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">processJob</span><span class="o">(</span><span class="n">String</span> <span class="n">jobName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">();</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="n">AsyncResult</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">jobName</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 13:</em> Create an EJB that invoke an asynchronous method that runs 100 times. The asynchronous method should wait a random time between 5 and 10 seconds  before returning a the actual waiting time. Collect all the waiting times and compute the average.</p></blockquote>

<h3>Singleton Beans</h3>

<p>Singleton beans (<code>@Singleton</code>) are special kind of EJBS that exist only in one instance in the container. This is for instance useful to initialize the application. Thus, <code>@Singleton</code> can be associated with <code>@Startup</code> to start the EJB during container&#8217;s startup.</p>

<p>As there is only one instance, it means the bean is meant to be shared. Therefore, it is important to specify the locking policy. There are two types of locking:
- Container managed concurrency management <code>@ConcurrencyManagement(ConcurrencyManagementType.CONTAINER)</code>. This is the default behavior and it is highly recommended to stick to it. Annotating a method (or the class) with <code>@Lock(LockType.READ)</code> means that the method can be safely access concurrently. <code>@Lock(LockType.WRITE)</code> requires the calls to the method to be serialized. The methods are <code>@Lock(LockType.WRITE)</code> by default.
- Bean managed concurrency management <code>@ConcurrencyManagement(ConcurrencyManagementType.BEAN)</code>. This requires the developer to use synchronized and volatile to achieve good concurrency.</p>

<blockquote><p>By default the class is marked as <code>@Lock(LockType.WRITE)</code>, thus EVERY CALL is synchronized. This is probably not the expected behavior (at least most of the time) and produces a huge bottleneck. Make sure to set the proper lock policy on the class and to only put <code>@Lock(LockType.WRITE)</code> where needed.</p></blockquote>

<p>The following bean initialize a shared variable during container startup and lock the access to the modification to only one thread (client) at a time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Singleton</span>
</span><span class='line'><span class="nd">@Startup</span>
</span><span class='line'><span class="nd">@Lock</span><span class="o">(</span><span class="n">LockType</span><span class="o">.</span><span class="na">READ</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StatusBean</span> <span class="o">{</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">status</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@PostConstruct</span>
</span><span class='line'>  <span class="kt">void</span> <span class="n">init</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="s">&quot;Ready&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getStatus</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">status</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Lock</span><span class="o">(</span><span class="n">LockType</span><span class="o">.</span><span class="na">WRITE</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setStatus</span><span class="o">(</span><span class="n">String</span> <span class="k">new</span> <span class="n">Status</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">this</span><span class="o">.</span><span class="na">status</span> <span class="o">=</span> <span class="n">newStatus</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Lock</span><span class="o">(</span><span class="n">LockType</span><span class="o">.</span><span class="na">WRITE</span><span class="o">)</span>
</span><span class='line'>  <span class="nd">@AccessTimeout</span><span class="o">(</span><span class="n">value</span><span class="o">=</span><span class="mi">360000</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="n">doTediousOperation</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em>Exercise 14:</em> Write a singleton that reads the postal code from the database during startup, update them every 30 minutes. Take care of the concurrency aspects.</p></blockquote>

<h3><a id="sfsb"></a>Stateful Session Beans</h3>

<p>Unlike stateless session beans, stateful session beans maintain a state across several client invocation. This is because there is a one to one relationship between a client and a stateful session bean.</p>

<p>The following code snippet describes a stateful session bean that maintains a counter across several invocations.
A stateful session bean is annotated with <code>@Stateful</code>. As it is stateful, it maintains a session state and it is therefore important to set a timeout. Otherwise, the number of open session will raise and it will consume the server memory.
The timeout is defined using the <code>@StatefulTimeout</code> annotation.</p>

<blockquote><p>Because there is no instance sharing among several client, Stateful session beans are more resource-demanding than stateless session beans. Therefore, they should be used with great care.</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateful</span>
</span><span class='line'><span class="nd">@StatefulTimeout</span><span class="o">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">30</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentStatisticsServiceImpl</span> <span class="kd">implements</span> <span class="n">StudentStatisticsService</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Long</span> <span class="n">numberOfAccess</span> <span class="o">=</span> <span class="mi">0</span><span class="n">l</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getStatistics</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="s">&quot;The student service has been invoked #&quot;</span> <span class="o">+</span> <span class="n">numberOfAccess</span>
</span><span class='line'>              <span class="o">+</span> <span class="s">&quot; in this session&quot;</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">count</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">numberOfAccess</span><span class="o">++;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a stateful session bean is not per se linked to an HTTP session, the application client code must ensure to remember which instance of the EJB is dedicated to which client.
When used in conjunction with a Servlet, Stateful beans are often put in the HTTP session for further reuse.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">StudentStatisticsService</span> <span class="n">statistics</span> <span class="o">=</span> <span class="o">(</span><span class="n">StudentStatisticsService</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">getAttribute</span><span class="o">(</span>
</span><span class='line'>              <span class="n">StudentStatisticsService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">statistics</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">InitialContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span><span class='line'>              <span class="n">statistics</span> <span class="o">=</span> <span class="o">(</span><span class="n">StudentStatisticsService</span><span class="o">)</span> <span class="n">ctx</span>
</span><span class='line'>                      <span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;java:global/JEE6-EAR/JEE6-EJB-0.0.1-SNAPSHOT/StudentStatisticsServiceImpl&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">request</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">setAttribute</span><span class="o">(</span><span class="n">StudentStatisticsService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">statistics</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">statistics</span><span class="o">.</span><span class="na">count</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;There are #&quot;</span> <span class="o">+</span> <span class="n">studentService</span><span class="o">.</span><span class="na">getAll</span><span class="o">().</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; students in the database&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="n">statistics</span><span class="o">.</span><span class="na">getStatistics</span><span class="o">());</span>
</span><span class='line'>      <span class="n">response</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">println</span><span class="o">(</span><span class="n">studentService</span><span class="o">.</span><span class="na">getStatistics</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Either the EJB is looked-up with JNDI and then put into the HTTP session or, when using CDI, the link is made based on the caller scope.
The class <code>StudentServiceFacade.java</code> describes how the injection automatically links the correct instance of a stateful session bean to a given based on the <code>@SessionScoped</code> annotation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@SessionScoped</span>
</span><span class='line'><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/studentService&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentServiceFacade</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1318211294294344900L</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@EJB</span>
</span><span class='line'>  <span class="n">StudentService</span> <span class="n">studentService</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@EJB</span>
</span><span class='line'>  <span class="n">StudentStatisticsService</span> <span class="n">studentServiceStatistics</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@GET</span>
</span><span class='line'>  <span class="nd">@Produces</span><span class="o">({</span> <span class="s">&quot;application/xml&quot;</span><span class="o">,</span> <span class="s">&quot;application/json&quot;</span> <span class="o">})</span>
</span><span class='line'>  <span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;session&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">getSessionStatistics</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">studentServiceStatistics</span><span class="o">.</span><span class="na">getStatistics</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Consider the following exercise.</p>

<blockquote><p><em>Exercise 15:</em> Show that two sessions share the same overall count but not the same per session count.</p></blockquote>

<p>As the container does not share the stateful instances, it might run out of memory and therefore it will try to save the state of the bean on disk (or database). This operation is called <strong>Passivation</strong>. Afterwards, when the client comes back and requires its stateful instance, the container loads it from the disk. This operation is called <strong>Activation</strong>.</p>

<p>Some operations such as initializing/cleaning File, a socket connection, or a database connection can be made before activation and/or after activation using the following
<code>@PrePassivate</code> and the <code>@PostActivate</code> annotations.</p>

<p>Consider the following exercises:</p>

<blockquote><p><em>Exercise 16:</em> Stop the server and observe that the bean has been passivated.</p>

<p><em>Exercise 17:</em> Start the server and observe that the bean has been activated.</p></blockquote>

<p>Whenever the user logs out and thus invalidate the HTTP Session, you might want to clean up the EJB state and release the resources. To achieve this, the client must call a method annotated with <code>@Remove</code>. As soon as the client call is over the container can garbage the bean. The idea is simply to get ahead of the timeout.</p>

<blockquote><p><em>Exercise 18:</em> Implements two methods with <code>@Remove</code> with two different behaviors. Check that both will discard the current instance. Hint: you can use <code>@PreDestroy</code> to check the bean&#8217;s destruction.</p></blockquote>

<h2>Message Driven Beans</h2>

<p>Message driven beans (MDB) are very useful for asynchronous process and for decoupling the client from the processor. MDB implement a typical publish/subscribe architecture.</p>

<p>There are two kinds of objects, a MDB can listen to:</p>

<ul>
<li><strong>Topics</strong>: pure publish/subscribe semantics. A new message will be processed by every listeners.</li>
<li><strong>Queue</strong>: more of a load balancer, once the message is consumed by one of the listeners, it
is removed from the queue.</li>
</ul>


<p>Although, there is, in JEE6, another mechanism for asynchronous processing, MDBs remain the best alternative if you do not want the client to be aware of the asynchronous logic and processor.</p>

<p>The idea is that there is a queue (or a topic) in between. Therefore, the client as no knowledge whatsoever of the message processor contract or semantics.</p>

<p>The first step is to configure a Queue Connection Factory as well as a Queue in the application server.</p>

<p>The following servlet gets  the connection factory as well as the queue injected. As always with dependency injection, the same result can be achieved using JNDI lookups.
For each request to the servlet 100 messages are generated and put in the Queue called <code>MyQueue</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">&quot;/registration&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegistrationServlet</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>      
</span><span class='line'>  <span class="nd">@Resource</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyConnectionFactory&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">ConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Resource</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Queue</span> <span class="n">queue</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span>  <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">Connection</span> <span class="n">connection</span><span class="o">;</span>
</span><span class='line'>          <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="n">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
</span><span class='line'>          <span class="n">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">TextMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">message</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;This is message &quot;</span> <span class="o">+</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
</span><span class='line'>              <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following MDB listens to <code>MyQueue</code> (thanks to the annotation <code>@MessageDriven(mappedName = "MyQueue")</code> and because it implements the <code>MessageListener</code> interface it takes a message when available.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@MessageDriven</span><span class="o">(</span><span class="n">mappedName</span> <span class="o">=</span> <span class="s">&quot;MyQueue&quot;</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StudentRegistrationService</span> <span class="kd">implements</span> <span class="n">MessageListener</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Resource</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">MessageDrivenContext</span> <span class="n">mdbContext</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">inMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">TextMessage</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">inMessage</span> <span class="k">instanceof</span> <span class="n">TextMessage</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="n">TextMessage</span><span class="o">)</span> <span class="n">inMessage</span><span class="o">;</span>
</span><span class='line'>              <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&quot;MESSAGE BEAN: Message received: &quot;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Message of wrong type: &quot;</span>
</span><span class='line'>                      <span class="o">+</span> <span class="n">inMessage</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">mdbContext</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">();</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is a sample output. As you can see, the messages are processed according to their input order but not necessarily by the same EJB (worker).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">1</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">2</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">3</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">1</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">2</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">5</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">Sending</span> <span class="nl">message:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">6</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">4</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">5</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="nl">INFO:</span> <span class="n">MESSAGE</span> <span class="nl">BEAN:</span> <span class="n">Message</span> <span class="nl">received:</span> <span class="n">This</span> <span class="n">is</span> <span class="n">message</span> <span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>


<p>Consider the following exercises:</p>

<blockquote><p><em>Exercise 19:</em> Compare Message Driven Beans and Session Beans with asynchronous calls.</p>

<p><em>Exercise 20:</em> Print out the thread-id. What do you observe?</p>

<p><em>Exercise 21:</em> Create another MDB that consumes the same queue. What do you observe?</p>

<p><em>Exercise 22:</em> Do the same (2 consumers) but using a <code>Topic</code> instead of a <code>Queue</code>.</p></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/12/05/servicelocator/">Context Dependency Injection and the Rich Object Model</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-05T06:59:00+01:00" pubdate data-updated="true">Dec 5<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/12/05/servicelocator/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2012/12/05/servicelocator/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>[Rich object model] vs [anemic object model] is long running debate. While the latter encourages to use simple and stupid objects with little or no business in them, the rich object model advocates for a clean object design with inheritance, polymorphism and so on.
The anemic object model is very popular among JEE partitioners because, in the past, the specification did not provide any mean to invoke services in business objects. Therefore, the anemic pattern uses so called &#8220;managers&#8221; that maintain references to other &#8220;managers&#8221;. A direct benefit is the clear separation of concerns between the different kind of objects. Basically, it splits processing and data. As this is anti-object oriented, the abstract design of such system is often very different from the actual implementation.</p>

<h2>The portfolio example</h2>

<p>As example, let us take a portfolio that contains a set of financial position. A financial position can be either a set of stock, or an amount in a given currency. To evaluate the actual portfolio value, we go through the positions and for each of them we ask the current quote for stock to the service <code>QuoteService</code> or the current value of a given currency to the <code>CurrencyService</code>.
The next figure presents the &#8220;ideal&#8221; design.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/portfolio-business.png' width='' height='' alt='An object oriented class diagram of the Portfolio management component.' title='An object oriented class diagram of the Portfolio management component.'><span class='caption-text'>An object oriented class diagram of the Portfolio management component.</span></span></p>

<p>To achieve this, one need to access services from within business objects. Since EJB 3.1,  Context and Dependency Injection (CDI) provides such a mechanism via the <code>@Inject</code> annotation. The only requirement is that the object that requires the service as well as the service to inject are so called &#8220;managed beans&#8221;. The trick is that not all objects are meant to be managed. Furthermore, having managed lists of object is very tricky to say the least. Fortunately, the EJB 3.1 and more specifically the CDI 1.0 specification provide a way to solve this.
In CDI, the main component is the bean manager. This manager keeps track of the beans to inject via @Inject and other means. Instead of relying on annotations to provide injection, it is possible to use the good old Service Locator pattern. CDI 1.0 exposes the bean manager on JNDI with the name <code>java:comp/BeanManager</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServiceLocator</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&quot;unchecked&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">getInstance</span><span class="o">(</span><span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">T</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">//Access to the current context.</span>
</span><span class='line'>          <span class="n">InitialContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InitialContext</span><span class="o">();</span>
</span><span class='line'>          <span class="c1">//Resolve the bean manager</span>
</span><span class='line'>          <span class="n">BeanManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">BeanManager</span><span class="o">)</span> <span class="n">ctx</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="s">&quot;java:comp/BeanManager&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="c1">//Retrieve all beans of that type</span>
</span><span class='line'>          <span class="n">Set</span><span class="o">&lt;</span><span class="n">Bean</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">beans</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">getBeans</span><span class="o">(</span><span class="n">type</span><span class="o">);</span>
</span><span class='line'>          <span class="n">Bean</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">bean</span> <span class="o">=</span> <span class="o">(</span><span class="n">Bean</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;)</span> <span class="n">manager</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">beans</span><span class="o">);</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">bean</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">CreationalContext</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">context</span> <span class="o">=</span> <span class="n">manager</span>
</span><span class='line'>                      <span class="o">.</span><span class="na">createCreationalContext</span><span class="o">(</span><span class="n">bean</span><span class="o">);</span>
</span><span class='line'>              <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">result</span> <span class="o">=</span> <span class="o">(</span><span class="n">T</span><span class="o">)</span> <span class="n">manager</span><span class="o">.</span><span class="na">getReference</span><span class="o">(</span><span class="n">bean</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NamingException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The client code is very simple. It consists in calling the <code>ServiceLocator</code>with the desired interface.
For the sake of clarity, I did not show the ServiceLocator that takes a qualifier in addition to the interface. To add this feature, look at the <code>getBeans(Type beanType, Annotation... qualifiers)</code> method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StockPos</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Long</span> <span class="n">qty</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">stockId</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Double</span> <span class="nf">evaluate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">StockQuoteService</span> <span class="n">sqs</span> <span class="o">=</span> <span class="n">ServiceLocator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">StockQuoteService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">qty</span> <span class="o">*</span> <span class="n">sqs</span><span class="o">.</span><span class="na">getQuoteValue</span><span class="o">(</span><span class="n">stockId</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Similarly, here is the code of the <code>CurrencyPos</code> object.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CurrencyPos</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="n">Double</span> <span class="n">amount</span><span class="o">;</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">String</span> <span class="n">currencyId</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Double</span> <span class="nf">evaluate</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">CurrencyQuoteService</span> <span class="n">sqs</span> <span class="o">=</span> <span class="n">ServiceLocator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">CurrencyQuoteService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">amount</span> <span class="o">*</span> <span class="n">sqs</span><span class="o">.</span><span class="na">getQuoteValue</span><span class="o">(</span><span class="n">stockId</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Some thoughts on the Demeter law</h2>

<p>Let me be clear, I do <strong>not</strong> recommend this approach everywhere. It is very important to not mix the objects responsabilities. Furthermore,
in order to respect the Demeter law, a business must <strong>not</strong> directly call something outside of the current component. Calls to other components are always to be done through so-called consumers to have clear components boundaries.
For instance, putting to much intelligence in JPA entities that can be detached and serialized may cause problems on the client side.</p>

<h2>Conclusion</h2>

<p>In this post, I showed a solution to consume services that are exposed via the CDI BeanManager. These services can be pure POJOs or EJBs.
Nevertheless, this approach must be used with great care as it can blur the components boundaries and responsabilities.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/11/20/multi-tenancy/">Multi-Tenancy With EJB 3.1 and JPA 2.0</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-20T05:18:00+01:00" pubdate data-updated="true">Nov 20<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/11/20/multi-tenancy/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2012/11/20/multi-tenancy/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Multi-tenancy is a recurrent non functional requirement. Indeed, many important IT-systems are meant to be shared among multiple tenants. The data are often distributed over several databases or schemas. This, for different reasons:</p>

<ul>
<li>Security: The data belong to different customers and some level of isolation is required;</li>
<li>Performances: Distributing the data over multiple systems may help to master performance issues;</li>
<li>Legacy: Sometimes, old and new systems must cohabit for a (long) time;</li>
<li>Maintenability: A database or a schema can be updated without putting the rest of the application at risk.</li>
</ul>


<p>Although data are distributed, the application code should remain tenant agnostic. Furthermore, choosing between the different tenants is often made at runtime based on credentials (e.g. user Joe has access to customer AAAA while user Jane sees data of customer BBB). <a href="/https://blogs.oracle.com/arungupta/entry/java_ee_7_key_features">Java EE 7 will address this problem and much more</a>, but in the mean time here is the way that I use to address this problematic using EJB 3.1 and JPA 2.0</p>

<h2>Overall architecture</h2>

<p>First, let me start with the overall architecture as described below.</p>

<p><span class='caption-wrapper center'><img class='caption' src='/figures/multi-tenancy-architecture.png' width='' height='' alt='Multi-tenancy architecture with serveral datasources' title='Multi-tenancy architecture with serveral datasources'><span class='caption-text'>Multi-tenancy architecture with serveral datasources</span></span></p>

<p>In the above figure, the database is organized in schemas, with one application server datasource (DS) per schema and one persistence unit (PU) per datasource.
It is also possible to use only one datasoure and to discriminate between schemas by setting the <code>&lt;property name="openjpa.jdbc.Schema" value="TenantX" /&gt;</code> property for each persistence unit (PU). This sets the default schema for the PU.
Here is a <code>persistence.xml</code> file that provides one persistence unit per tenant.</p>

<p>The following code has been tested for Open-JPA but there is nothing specific to this implementation outside of the <code>&lt;provider&gt;</code>tag in the <code>persistence.xml</code>file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;persistence</span> <span class="na">version=</span><span class="s">&quot;2.0&quot;</span>
</span><span class='line'>  <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/persistence&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class='line'>  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;Tenant1&quot;</span> <span class="na">transaction-type=</span><span class="s">&quot;JTA&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;provider&gt;</span>
</span><span class='line'>          org.apache.openjpa.persistence.PersistenceProviderImpl
</span><span class='line'>      <span class="nt">&lt;/provider&gt;</span>
</span><span class='line'>      <span class="nt">&lt;jta-data-source&gt;</span>jdbc/Tenant1_DS<span class="nt">&lt;/jta-data-source&gt;</span>
</span><span class='line'>      <span class="nt">&lt;exclude-unlisted-classes&gt;</span>false<span class="nt">&lt;/exclude-unlisted-classes&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/persistence-unit&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;persistence-unit</span> <span class="na">name=</span><span class="s">&quot;Tenant2&quot;</span> <span class="na">transaction-type=</span><span class="s">&quot;JTA&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;provider&gt;</span>
</span><span class='line'>          org.apache.openjpa.persistence.PersistenceProviderImpl
</span><span class='line'>      <span class="nt">&lt;/provider&gt;</span>
</span><span class='line'>      <span class="nt">&lt;jta-data-source&gt;</span>jdbc/Tenant2_DS<span class="nt">&lt;/jta-data-source&gt;</span>
</span><span class='line'>      <span class="nt">&lt;exclude-unlisted-classes&gt;</span>false<span class="nt">&lt;/exclude-unlisted-classes&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/persistence-unit&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/persistence&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The basic idea is that, instead of using <code>@PersistenceContext</code>, we inject our &#8220;own&#8221; multi tenant entity manager wraper.
Then, at runtime, the multi-tenant entity manager loads the persistence context that corresponds to the current user context from JNDI.
Please note that this only works for JTA-based persistence-units. Otherwise, the persistence context is not container-basd and therefore not exposed to JNDI. Moreover, without JTA, we loose container based transaction demarcation.</p>

<p>Let us first start with the client code. In other words, how to use the Multi-Tenant Entity manager.</p>

<h2>Client Code</h2>

<p>Here is the client code. In order to preserve thread-safety and transactionality, Data access objects are EJBs (<code>@Stateless</code>, <code>@Stateful</code>, <code>@Singleton</code>). The presented solution uses an entity manager that is wrapped and then injected using <code>@Inject</code> or <code>@EJB</code>.  Thread-safety, transactionnality and performances are guaranted by the <code>EJB 3.1</code> and <code>JPA 2.0</code> specification as explained in the section <code>Thread-safety and Transactionality</code>. As shown below, the <code>MultiTenancyWrapper</code> delegates to a real entity manager and implements the <code>EntityManager</code> interface. Therefore, its use is very similar to a normal <code>EntityManager</code> injected via <code>@PersistenceContext</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyEJB</span> <span class="kd">implements</span> <span class="n">MyEJBLocal</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Inject</span>
</span><span class='line'>  <span class="kd">private</span> <span class="n">MultiTenancyWrapper</span> <span class="n">emWrapper</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@TransactionAttribute</span><span class="o">(</span><span class="n">TransactionAttributeType</span><span class="o">.</span><span class="na">REQUIRED</span><span class="o">)</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">emWrapper</span><span class="o">.</span><span class="na">findAll</span><span class="o">(...);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The Multi-Tenant EntityManager EJB</h2>

<p>The <code>MultiTenanEntityManagertWrapper</code> simply wraps the entity manager that corresponds to the current user context. The trick is to configure it as an EJB in order to get the xml configuration feature via <code>ejb-jar.xml</code>. Another alternative would be to use the <code>@PersistenceContexts</code> and <code>@PersistenceContext</code> annotations. The main drawback being that, for each new tenant, not only the <code>persistence.xml</code> and <code>ejb-jar.xml</code> must be changed but also the <code>Java</code> code.</p>

<p>The JNDI context that is linked to the current request is injected in the <code>MultiTenantEntityManager</code> using the <code>@Resource</code>annotation.
As there is no creation of a new <code>InitialContext</code> the overhead is not significant. Actually, the <code>@PersistentContext</code> annotation does the exact same thing except that it is not specific to the user context. The <code>MultiTenanEntityManagertWrapper</code> implements the delegate pattern. This allows to use it (almost) transparently in client code.
The main difference being the use of <code>@Inject</code> or <code>@EJB</code> over <code>@PersistenceContext</code> in the client code.</p>

<p>Using the session context that is specific to the caller bean (and thus the caller request/session) enables transparent support for thread-safety, security and transactionality.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">package</span> <span class="n">ejb</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">javax.persistence.EntityManager</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MultiTenanEntityManagertWrapper</span> <span class="kd">extends</span> <span class="n">EntityManager</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The method <code>getMultiTenantEntityManager</code> of the <code>MultiTenanEntityManagertWrapperImpl</code> extracts the <code>EntityManager</code> that corresponds to the current request from JNDI (we will see later how it has been put there). To that end, the method <code>getMultiTenantEntityManager</code>first extracts the prinipal from the current EJB context (<code>SessionContext</code>). After what, the tenant that corresponds to the current user is used to obtain the JNDI name of the corresponding entity manager. <code>MultiTenanEntityManagertWrapperImpl</code> simple delegates every call to the this Request specific <code>EntityManager</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Stateless</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiTenanEntityManagertWrapperImpl</span> <span class="kd">implements</span> <span class="n">MultiTenanEntityManagertWrapper</span> <span class="o">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">JNDI_ENV</span> <span class="o">=</span> <span class="s">&quot;java:comp/env/persistence/&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Resource</span>
</span><span class='line'>  <span class="n">SessionContext</span> <span class="n">context</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  
</span><span class='line'>  <span class="kd">private</span> <span class="n">EntityManager</span> <span class="nf">getMultiTenantEntityManager</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">//Extract the name of the current user.</span>
</span><span class='line'>      <span class="n">Principal</span> <span class="n">p</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getCallerPrincipal</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//Lookup the tenant name for the current user</span>
</span><span class='line'>      <span class="c1">//This is application specific</span>
</span><span class='line'>      <span class="n">Users</span> <span class="n">u</span> <span class="o">=</span> <span class="n">Users</span><span class="o">.</span><span class="na">getUser</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">//Produces either TENANT1 or TENANT2       </span>
</span><span class='line'>      <span class="n">String</span> <span class="n">tenantName</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="na">getSite</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">String</span> <span class="n">jndiName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">(</span><span class="n">JNDI_ENV</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">tenantName</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>      <span class="c1">//Lookup the entity manager</span>
</span><span class='line'>      <span class="n">EntityManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="o">(</span><span class="n">EntityManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">jndiName</span><span class="o">);</span>
</span><span class='line'>      
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">manager</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;Tenant unknown&quot;</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">manager</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//The delegates</span>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">persist</span><span class="o">(</span><span class="n">Object</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">getMultiTenantEntityManager</span><span class="o">().</span><span class="na">persist</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">merge</span><span class="o">(</span><span class="n">T</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nf">getMultiTenantEntityManager</span><span class="o">().</span><span class="na">merge</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Override</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Object</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">getMultiTenantEntityManager</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let us see how to put the entity manager references in JNDI.
In order to avoid a lot of annotations (one per tenant) and therefore to be able to handle a huge number of tenans, I propose to use the <code>ejb-jar.xml</code> file to configure the EJB intead of the <code>PersistenceContext</code> annotation. The <code>MultiTenantEntityWrapper</code>EJB is configured as a stateless EJB. Ther persistence contexts are simply exposed to JNDI with the following pattern: <code>java:comp/env/persistence/TENANTX</code>. For more information please look at the EJB 3.1 specification chapter 16.11.1.</p>

<p><code>&lt;persistence-unit-name&gt;Tenant1&lt;/persistence-unit-name&gt;</code> is the name of the PU as defined in the <code>persistence.xml</code> file. <code>&lt;persistence-context-ref-name&gt;persistence/TENANT1&lt;/persistence-context-ref-name&gt;</code>defines the name of the entity manager that is exposed via JNDI.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;ejb-jar</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee&quot;</span> <span class="na">xmlns:ejb=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee/ejb-jar_3_0.xsd&quot;</span> <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/ejb-jar_3_1.xsd&quot;</span> <span class="na">version=</span><span class="s">&quot;3.1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;enterprise-beans&gt;</span>
</span><span class='line'>      <span class="nt">&lt;session&gt;</span>
</span><span class='line'>          <span class="nt">&lt;ejb-name&gt;</span>MultiTenantEntityWrapper<span class="nt">&lt;/ejb-name&gt;</span>   
</span><span class='line'>          <span class="nt">&lt;ejb-class&gt;</span>ejb.MultiTenantWrapperImpl<span class="nt">&lt;/ejb-class&gt;</span>
</span><span class='line'>          <span class="nt">&lt;session-type&gt;</span>Stateless<span class="nt">&lt;/session-type&gt;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c">&lt;!-- Persistece contexts --&gt;</span>
</span><span class='line'>          <span class="nt">&lt;persistence-context-ref&gt;</span>
</span><span class='line'>              <span class="nt">&lt;description&gt;</span>Tenant 1<span class="nt">&lt;/description&gt;</span>             
</span><span class='line'>              <span class="nt">&lt;persistence-context-ref-name&gt;</span>persistence/TENANT1<span class="nt">&lt;/persistence-context-ref-name&gt;</span>        
</span><span class='line'>              <span class="nt">&lt;persistence-unit-name&gt;</span>Tenant1<span class="nt">&lt;/persistence-unit-name&gt;</span>
</span><span class='line'>              <span class="nt">&lt;persistence-context-type&gt;</span>Transaction<span class="nt">&lt;/persistence-context-type&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/persistence-context-ref&gt;</span>
</span><span class='line'>
</span><span class='line'>          <span class="nt">&lt;persistence-context-ref&gt;</span>
</span><span class='line'>              <span class="nt">&lt;description&gt;</span>Tenant 2<span class="nt">&lt;/description&gt;</span>             
</span><span class='line'>              <span class="nt">&lt;persistence-context-ref-name&gt;</span>persistence/TENANT2<span class="nt">&lt;/persistence-context-ref-name&gt;</span>        
</span><span class='line'>              <span class="nt">&lt;persistence-unit-name&gt;</span>Tenant2<span class="nt">&lt;/persistence-unit-name&gt;</span>
</span><span class='line'>              <span class="nt">&lt;persistence-context-type&gt;</span>Transaction<span class="nt">&lt;/persistence-context-type&gt;</span>                
</span><span class='line'>          <span class="nt">&lt;/persistence-context-ref&gt;</span>
</span><span class='line'>          
</span><span class='line'>      <span class="nt">&lt;/session&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/enterprise-beans&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/ejb-jar&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Thread-safety and Transactionality</h2>

<p>As this is compliant with both the EJB 3.1 and JPA 2.0 specification, thread-safety and transactionnaly are guaranteed by the container. For more details please look at the EJB 3.1 specification
at chapters 16.10, 16.11 and the JPA 2.0 specification at chapter 7.6. Of course, the wrapper has to be an EJB in order to have access to the current JNDI context without having to create it.
Furthermore, because the <code>EntityManager</code>is not <code>per se</code> thread-safe (JPA 2.0, chapter 7.2), the serialization of the invokations that is provided by the container for EJBs is essential the thread-safety aspect (EJB 3.1, chapter 4.10.13).</p>

<h2>Conclusion</h2>

<p>In this post, I showed how to leverage EJB 3.1 and JPA 2.0 standard features to provide multi-tenancy. The presented approach is thead-safe, it preserves transactionaly and does not induce
a significant overhead.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/06/10/Sessions-GC-Conversations/">About Sessions, Conversations, and the Garbage Collector</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-06-10T18:51:00+02:00" pubdate data-updated="true">Jun 10<span>th</span>, 2012</time>
        
           | <a href="/blog/2012/06/10/Sessions-GC-Conversations/#disqus_thread"
             data-disqus-identifier="http://hostettler.github.io/blog/2012/06/10/Sessions-GC-Conversations/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A couple of days ago, I had a discussion with a developer about the notion of web conversation.
More precisely, about its utility. During this discussion, we ran into some basic misconceptions
that, IMHO, no web developer must do. Conversation (or flows) are good features of the recent
frameworks (Spring, JSF) because they allow to save information across several user requests without
putting them into the session. For instance, this can be very useful for wizards. Putting these
information into the session asks for manual maintenance, and in particular for manual collection.
This is usual error prone and should be avoided. The problem being that the user rarely logs out
before closing the browser. Thus, <code>HttpSession.invalidate()</code> does not get a chance to be called
and the session remains active until the timeout occurs (usually 20 minutes later).</p>

<p>The person I was talking with, though that it is not necessary to care about that. In his view,
the garbage collector will take care of this and that it can be forced. We discuss the matter a bit
deeper and here are some myths that I think must be rebutted.</p>

<h2>First assumption: I can force the garbage collection</h2>

<p>This is not true, actually according to the Java documentation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Calling the gc method suggests that the Java Virtual Machine expend effort toward recycling unused objects in order to make the memory they currently occupy available for quick reuse. When control returns from the method call, the Java Virtual Machine has made a best effort to reclaim space from all discarded objects.</span></code></pre></td></tr></table></div></figure>


<p><code>System.gc()</code> <strong>suggests</strong> the garbage collection, it does not enforce it. This signals that you
would like the garbage collector to do its job, but there is no guarantee whatsoever. It is only
possible to enforce garbage collection by writing your own garbage collector, but you cannot expect
all garbage collectors of all the possible VM to act similarly. Therefore, relying on this
assumption is not portable.</p>

<h2>Second assumption: If I close the browser the session and its objects are collected</h2>

<p>Even If it would be possible to enforce the garbage collection, it is of no use as long as there
remains a single reference to the objects to collect. Again, this is absolutely not the case.
Remember that closing the browser does not mean anything to the server. It would, in theory possible
to imagine something with an ajax call that traps the close event of the browser and does a
<code>HttpSession.invalidate()</code> . This is quite complex to do in a cross-browser manner and gives no
guarantee. Therefore, the data attached to the session will be kept in memory until the session
timeout. This is precisely the beauty of conversation scopes, the developer just tells when the
conversation starts and when it ends. Usually, user do not stop in the middle of a conversation,
they tend to finish it. At least, more often that they click on logout.</p>

<h2>Third assumption: Anyway this does not represent a huge amount of memory.</h2>

<p>Let us take a simple example: a standard business application that, at some point in the business
process, requires a tree for shop selection. This kind of interactions requires several client-server
communications and therefore several requests. A temptation would be to put the tree in the session
scope. Let us say that 10,000 (logical) users log into the application, for instance from 09:00 am to 09:30
am. If each session requires 100 KB (trees are huge even with lazy loading), we end up with 1G memory(only for the tree).
As most of the users do not click on logout, you rely on the timeout to free these objects.</p>

<h2>Conclusion</h2>

<p>Using request scope of conversation scope over session scope is a good practice as it frees you
from managing the garbage collection. The code is therefore cleaner and more efficient.
This can be done with JSF&#8217;s <code>@ConversationScoped</code> or with Spring Webflow&#8217;s <code>Conversation</code>.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/02/10/data-warehouse/">A (Small) Hitchhiker&#8217;s Guide to the Data Warehousing</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/30/integration-tests-with-docker-and-arquillian/">Integration Tests With Docker and Arquillian</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/02/cleaning-intermediate-docker-images/">Cleaning Intermediate Docker Images</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/26/communication-between-java-enterprise-applications/">Communication Between Java Enterprise Applications</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/18/fakes-stubs-dummy-mocks-doubles-and-all-that/">Fakes, Stubs, Dummy, Mocks, Doubles and All That&#8230;</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/18/testing-levels/">Testing Levels</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/31/jee6-tutorial/">JEE6 Tutorial</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/05/servicelocator/">Context Dependency Injection and the Rich Object Model</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/20/multi-tenancy/">Multi-Tenancy With EJB 3.1 and JPA 2.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/06/10/Sessions-GC-Conversations/">About Sessions, Conversations, and the Garbage Collector</a>
      </li>
    
  </ul>
</section>




<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/116636069211041664299?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Steve Hostettler -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hostettlerblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
